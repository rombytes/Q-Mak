<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - UMak COOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- HTML5 QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="flex h-screen bg-gray-50">
    <!-- Retractable Sidebar -->
    <div class="sidebar bg-blue-900 text-white flex flex-col fixed h-full z-50 shadow-2xl">
        <div class="sidebar-content">
            <!-- Profile Section -->
            <div class="p-4 border-b border-blue-700/50">
                <div class="flex items-center gap-3">
                    <div class="profile-avatar" id="profileAvatar">
                        <img src="../../images/Herons.png" alt="Profile Picture">
                    </div>
                    <div class="menu-text flex-1 min-w-0">
                        <h3 class="font-bold text-sm truncate" id="sidebarAdminName">Admin User</h3>
                        <p class="text-xs text-blue-200 truncate" id="sidebarAdminEmail">admin@umak.com</p>
                    </div>
                </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="flex-1 py-4">
                <ul class="space-y-1 py-2">
                    <li onclick="showTab('queue-management')" id="tab-queue-management" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl bg-orange-500 hover:bg-orange-600 border-l-4 border-orange-300 shadow-lg hover:shadow-xl transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="16" x2="16" y2="12"/><line x1="12" y1="12" x2="12" y2="16"/><line x1="8" y1="16" x2="8" y2="8"/>
                            </svg>
                            <span class="menu-text font-semibold">Queue & Orders</span>
                        </div>
                    </li>
                    <li onclick="showTab('queue-history')" id="tab-queue-history" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/>
                            </svg>
                            <span class="menu-text font-medium">Queue History</span>
                        </div>
                    </li>
                    <li onclick="showTab('student-records')" id="tab-student-records" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <span class="menu-text font-medium">Student Records</span>
                        </div>
                    </li>
                    <li onclick="showTab('analytics')" id="tab-analytics" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 3v18h18"/><path d="M18.7 8a2.3 2.3 0 0 0-3.4 0l-4.6 4.6a2.3 2.3 0 0 0 0 3.4l1.6 1.6a2.3 2.3 0 0 0 3.4 0l4.6-4.6a2.3 2.3 0 0 0 0-3.4Z"/><path d="M12 12 1.4 1.4"/><path d="M7.7 3H5v2.7Z"/>
                            </svg>
                            <span class="menu-text font-medium">Analytics</span>
                        </div>
                    </li>
                    <li onclick="showTab('service-config')" id="tab-service-config" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
                            </svg>
                            <span class="menu-text font-medium">Inventory</span>
                        </div>
                    </li>
                    <li onclick="showTab('email-logs')" id="tab-email-logs" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>
                            </svg>
                            <span class="menu-text font-medium">Email Logs</span>
                        </div>
                    </li>
                    <li onclick="showTab('admin-settings')" id="tab-admin-settings" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.2-14.2 4.3-4.3M2.5 2.5l4.2 4.2m0 10.6-4.2 4.2m17-17-4.3 4.3M1 12h6m6 0h6"/>
                            </svg>
                            <span class="menu-text font-medium">Settings</span>
                        </div>
                    </li>
                    <li onclick="showTab('admin-management')" id="tab-admin-management" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-blue-700/60 border-l-4 border-transparent hover:border-orange-400 hover:shadow-md transform hover:translate-x-1 hidden">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                            </svg>
                            <span class="menu-text font-medium">Admin Management</span>
                        </div>
                    </li>
                </ul>
            </nav>

            <!-- Bottom Section -->
            <div class="border-t border-blue-700/50 pt-4 mt-auto">
                <!-- Logout Button -->
                <ul class="space-y-1">
                    <li onclick="logout()" class="group mx-2 px-4 py-3.5 cursor-pointer transition-all duration-200 rounded-xl hover:bg-red-500/20 border-l-4 border-transparent hover:border-red-400 hover:shadow-md transform hover:translate-x-1">
                        <div class="flex items-center gap-3">
                            <svg class="menu-icon text-red-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            <span class="menu-text font-medium text-red-400 group-hover:font-semibold">Logout</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-gray-50" style="margin-left: 80px;">
        <!-- Top Bar -->
        <div class="bg-white/80 backdrop-blur-md shadow-lg sticky top-0 z-40 px-8 py-5 border-b border-blue-100">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-900">
                    Welcome, <span id="adminName" class="text-orange-500"></span>! 
                </h1>
                <div class="flex items-center gap-4">
                    <p class="text-gray-600 text-sm font-medium" id="currentDate"></p>
                    
                    <!-- Notification Bell -->
                    <button onclick="toggleNotifications()" class="relative p-2 hover:bg-blue-50 rounded-lg transition-all duration-200" title="System Notifications">
                        <i class="fas fa-bell text-gray-700 text-xl"></i>
                        <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full min-w-[20px] h-5 flex items-center justify-center font-semibold shadow-lg">0</span>
                    </button>
                </div>
            </div>
            
            <!-- Notification Dropdown Panel -->
            <div id="notificationPanel" class="hidden absolute right-8 top-20 bg-white rounded-xl shadow-2xl border border-gray-200 w-96 max-h-[550px] overflow-hidden z-50 animate-fadeIn">
                <!-- Header -->
                <div class="p-4 border-b border-gray-200 bg-white sticky top-0">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 text-lg">Notifications</h3>
                        <button onclick="markAllRead()" class="text-xs text-blue-600 hover:text-blue-800 font-semibold hover:underline transition">Mark all read</button>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-200 bg-gray-50">
                    <button onclick="filterNotifications('all')" id="tab-all" class="notif-tab flex-1 px-4 py-3 text-sm font-semibold text-blue-600 border-b-2 border-blue-600 bg-white transition-all">
                        All
                    </button>
                    <button onclick="filterNotifications('unread')" id="tab-unread" class="notif-tab flex-1 px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        Unread
                    </button>
                    <button onclick="filterNotifications('read')" id="tab-read" class="notif-tab flex-1 px-4 py-3 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-all">
                        Read
                    </button>
                </div>
                
                <!-- Notification List -->
                <div id="notificationList" class="divide-y divide-gray-100 overflow-y-auto max-h-[400px]">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>

        <div class="p-8">
            <!-- Queue Management Tab -->
            <div id="content-queue-management" class="tab-content">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-blue-900 mb-2">Queue & Orders Management</h2>
                    <p class="text-gray-600">Monitor and process customer orders in real-time</p>
                </div>
                
                <!-- Current Queue Display -->
                <div id="currentQueueDisplay" class="glass-effect rounded-2xl shadow-xl p-8 mb-8 border border-blue-100">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-semibold text-blue-900">Current Queue</h3>
                        <div class="text-sm bg-orange-500 text-white px-5 py-2 rounded-full font-semibold shadow-md" id="queuePosition">Queue: -</div>
                    </div>
                    
                    <div id="currentOrderCard" class="bg-white rounded-xl p-8 shadow-sm border border-gray-100">
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <h4 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                    Order Information
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Queue Number:</span>
                                        <span class="font-semibold text-gray-900" id="currentQueueNumber">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Item Ordered:</span>
                                        <span class="font-semibold text-gray-900" id="currentItemOrdered">-</span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-gray-600">Time Placed:</span>
                                        <span class="font-semibold text-gray-900" id="currentTimePlaced">-</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
                                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    Student Information
                                </h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Student ID:</span>
                                        <span class="font-semibold text-gray-900" id="currentStudentId">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Name:</span>
                                        <span class="font-semibold text-gray-900" id="currentStudentName">-</span>
                                    </div>
                                    <div class="flex justify-between py-2 border-b border-gray-100">
                                        <span class="text-gray-600">Email:</span>
                                        <span class="font-semibold text-gray-900" id="currentStudentEmail">-</span>
                                    </div>
                                    <div class="flex justify-between py-2">
                                        <span class="text-gray-600">Program:</span>
                                        <span class="font-semibold text-gray-900" id="currentStudentProgram">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 pt-6 border-t border-gray-100">
                            <div id="queue-action-start" class="flex justify-center">
                                <button onclick="processQueue('processing')" class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-3.5 rounded-xl font-semibold flex items-center gap-3 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    Start Processing
                                </button>
                            </div>
                            
                            <div id="queue-action-process" class="flex gap-3 justify-center hidden">
                                <button onclick="processQueue('ready')" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                    Mark Ready
                                </button>
                                <button onclick="processQueue('completed')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    Complete
                                </button>
                                <button onclick="skipQueue()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                                    Skip
                                </button>
                                <button onclick="processQueue('cancelled')" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noQueueMessage" class="hidden bg-white rounded-xl p-12 text-center shadow-sm border border-gray-100">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-100 to-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        </div>
                        <h4 class="text-xl font-semibold text-gray-700 mb-2">No Orders in Queue</h4>
                        <p class="text-gray-500">All orders have been processed or there are no pending orders.</p>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-orange-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Pending Orders</h4>
                        <p class="text-4xl font-bold bg-gradient-to-r from-orange-500 to-orange-600 bg-clip-text text-transparent" id="pendingCount">0</p>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-blue-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Ready for Pick Up</h4>
                        <p class="text-4xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent" id="readyCount">0</p>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-green-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Completed Today</h4>
                        <p class="text-4xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent" id="doneCount">0</p>
                    </div>
                </div>

                <!-- Queue Table -->
                <div class="glass-effect rounded-2xl shadow-lg overflow-hidden border border-gray-100 transition-all duration-300 hover:shadow-xl">
                    <div class="p-6 bg-gradient-to-r from-blue-50 via-indigo-50 to-orange-50 border-b border-gray-200">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-blue-900">Current Queue Status</h3>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Queue ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Student ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Time Placed</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="queueTableBody" class="divide-y divide-gray-100 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student Records Tab -->
            <div id="content-student-records" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent mb-2">Student Records</h2>
                    <p class="text-gray-600">Manage and monitor student accounts</p>
                </div>
                
                <!-- Filters and Actions -->
                <div class="glass-effect rounded-2xl shadow-md p-6 mb-6 border border-gray-100" style="overflow: visible; position: relative; z-index: 10;">
                    <div class="flex gap-4 items-center mb-4" style="overflow: visible;">
                        <input type="text" id="searchStudent" placeholder="Search by Student ID or Email..." 
                               class="flex-1 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" onkeyup="filterStudents()" style="position: relative; z-index: 1;" />
                        
                        <!-- Kebab Menu -->
                        <div class="relative" id="studentKebabMenu" style="z-index: 100;">
                            <button type="button" onclick="toggleStudentMenu()" id="studentMenuBtn"
                                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white p-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-ellipsis-v text-xl"></i>
                            </button>
                            <div id="studentMenuDropdown" class="hidden bg-white shadow-2xl border border-gray-200" style="position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 14rem; z-index: 10000; border-radius: 0.75rem; overflow: visible;">
                                <button type="button" onclick="enterStudentExportMode(); toggleStudentMenu()" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-gray-100" style="border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;">
                                    <i class="fas fa-file-excel text-green-600 w-5"></i>
                                    <span class="font-semibold text-gray-700">Export to Excel</span>
                                </button>
                                <button type="button" onclick="enterStudentArchiveMode(); toggleStudentMenu()" id="archiveStudentsBtnMenu" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-gray-100">
                                    <i class="fas fa-archive text-blue-900 w-5"></i>
                                    <span class="font-semibold text-gray-700">Archive Students</span>
                                </button>
                                <button type="button" onclick="toggleArchivedStudentsView(); toggleStudentMenu()" id="viewArchivedStudentsBtnMenu" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3" style="border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;">
                                    <i class="fas fa-folder-open text-gray-600 w-5"></i>
                                    <span class="font-semibold text-gray-700">View Archived</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="studentActions" class="hidden flex gap-2">
                        <button onclick="exportAllStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-file-excel mr-2"></i>Export All
                        </button>
                        <button onclick="exportSelectedStudents()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-check-square mr-2"></i>Export Selected (<span id="selectedStudentCount">0</span>)
                        </button>
                        <button onclick="exitStudentExportMode()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                    <div id="studentArchiveActions" class="hidden flex gap-2">
                        <button onclick="archiveAllStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-archive mr-2"></i>Archive All
                        </button>
                        <button onclick="archiveSelectedStudents()" class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-check-square mr-2"></i>Archive Selected (<span id="selectedStudentArchiveCount">0</span>)
                        </button>
                        <button onclick="restoreAllStudents()" id="restoreAllStudentsBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-undo mr-2"></i>Restore All
                        </button>
                        <button onclick="restoreSelectedStudents()" id="restoreSelectedStudentsBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-check-square mr-2"></i>Restore Selected (<span id="selectedStudentRestoreCount">0</span>)
                        </button>
                        <button onclick="exitStudentArchiveMode()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
                
                <div class="glass-effect rounded-2xl shadow-md overflow-hidden border border-gray-100" style="position: relative; z-index: 1;">
                    <div class="p-6 bg-gray-50 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-blue-900" id="studentsTableTitle">Active Students</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left student-checkbox-column hidden">
                                        <input type="checkbox" id="selectAllStudents" onchange="toggleSelectAllStudents()" class="w-4 h-4">
                                    </th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Student ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Full Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Account Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Total Orders</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">College</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Program</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-100 bg-white">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Management Tab -->
            <div id="content-service-config" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent mb-2 flex items-center gap-2">
                        <i class="fas fa-boxes"></i>Inventory Management
                    </h2>
                    <p class="text-gray-600">Manage stock levels and item availability</p>
                </div>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass-effect rounded-2xl p-6 shadow-md border border-gray-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-box text-white text-xl"></i>
                        </div>
                        <div class="text-sm text-gray-600 mb-1 text-center font-medium">Total Items</div>
                        <div class="text-3xl font-bold text-center bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent" id="totalItems">0</div>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 shadow-md border border-green-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-check-circle text-white text-xl"></i>
                        </div>
                        <div class="text-sm text-gray-600 mb-1 text-center font-medium">In Stock</div>
                        <div class="text-3xl font-bold text-center bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent" id="inStockCount">0</div>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 shadow-md border border-yellow-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-exclamation-triangle text-white text-xl"></i>
                        </div>
                        <div class="text-sm text-gray-600 mb-1 text-center font-medium">Low Stock</div>
                        <div class="text-3xl font-bold text-center bg-gradient-to-r from-yellow-500 to-yellow-600 bg-clip-text text-transparent" id="lowStockCount">0</div>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 shadow-md border border-red-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-times-circle text-white text-xl"></i>
                        </div>
                        <div class="text-sm text-gray-600 mb-1 text-center font-medium">Out of Stock</div>
                        <div class="text-3xl font-bold text-center bg-gradient-to-r from-red-500 to-red-600 bg-clip-text text-transparent" id="outOfStockCount">0</div>
                    </div>
                </div>

                <!-- Add Item Button -->
                <div class="mb-6 flex justify-end items-center">
                    <button onclick="showAddItemModal()" class="px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-xl font-semibold shadow-lg transition-all hover:shadow-xl duration-300 transform hover:-translate-y-0.5">
                        <i class="fas fa-plus mr-2"></i>Add New Item
                    </button>
                </div>

                <!-- Inventory Table -->
                <div class="glass-effect rounded-2xl shadow-md overflow-hidden border border-gray-100">
                    <div class="p-4 bg-gray-50 border-b border-gray-200">
                        <input type="text" id="inventorySearchInput" placeholder="Search items..." 
                               class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all"
                               oninput="filterInventoryItems()">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Item Name</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Stock</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Low Stock Alert</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Est. Time (min)</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Available</th>
                                    <th class="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="divide-y divide-gray-100 bg-white">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading inventory...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Add/Edit Item Modal -->
                <div id="itemModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" id="modalTitle">Add New Item</h2>
                            <button onclick="closeItemModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="itemForm" onsubmit="saveInventoryItem(event)">
                            <input type="hidden" id="itemId">
                            
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Item Name *</label>
                                <input type="text" id="itemName" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Description</label>
                                <textarea id="itemDescription" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Stock Quantity *</label>
                                    <input type="number" id="stockQuantity" min="0" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Low Stock Alert At</label>
                                    <input type="number" id="lowStockThreshold" min="1" value="20" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">Estimated Time (minutes) *</label>
                                <input type="number" id="estimatedTime" min="1" value="10" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="mb-6">
                                <label class="flex items-center">
                                    <input type="checkbox" id="isActive" checked class="mr-2">
                                    <span class="text-gray-700">Active (visible to students)</span>
                                </label>
                            </div>

                            <div class="flex gap-4">
                                <button type="button" onclick="closeItemModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                    <i class="fas fa-save mr-2"></i>Save Item
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Stock Adjustment Modal -->
                <div id="stockModal" class="modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div class="modal-content" style="background: white; padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%;">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Adjust Stock</h2>
                            <button onclick="closeStockModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="stockForm" onsubmit="adjustInventoryStock(event)">
                            <input type="hidden" id="stockItemId">
                            
                            <div class="mb-4">
                                <p class="text-gray-700 font-semibold" id="stockItemName"></p>
                                <p class="text-sm text-gray-500">Current Stock: <span id="currentStock" class="font-bold"></span></p>
                            </div>

                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">New Stock Quantity *</label>
                                <input type="number" id="newStockQuantity" min="0" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="mb-6">
                                <label class="block text-gray-700 font-semibold mb-2">Reason</label>
                                <input type="text" id="stockReason" placeholder="e.g., Restock, Inventory count" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <div class="flex gap-4">
                                <button type="button" onclick="closeStockModal()" class="flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                                    Cancel
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">
                                    <i class="fas fa-check mr-2"></i>Update Stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <style>
                    .modal.active { display: flex !important; }
                    .stock-badge {
                        padding: 4px 12px;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        font-weight: 600;
                    }
                    .stock-in { background-color: #d1fae5; color: #065f46; }
                    .stock-low { background-color: #fef3c7; color: #92400e; }
                    .stock-out { background-color: #fee2e2; color: #991b1b; }
                </style>
            </div>

            <!-- Edit Service Modal -->
            <div id="editServiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Edit Service</h3>
                    <form id="editServiceForm" class="space-y-4">
                        <input type="hidden" id="editServiceId" />
                        <div>
                            <label class="block font-bold mb-1">Service Name *</label>
                            <input type="text" id="editServiceName" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Estimated Time (mins) *</label>
                            <input type="number" id="editServiceTime" required min="1" class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editServiceActive" class="w-4 h-4" />
                                <span class="font-bold">Active</span>
                            </label>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                                Update
                            </button>
                            <button type="button" onclick="closeEditServiceModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <div id="editServiceMessage" class="mt-4 text-sm font-medium"></div>
                </div>
            </div>

            <!-- Email Logs Tab -->
            <div id="content-email-logs" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent mb-2">Email Logs</h2>
                    <p class="text-gray-600">Monitor email delivery and troubleshoot issues</p>
                </div>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-4 gap-6 mb-8">
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-blue-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-envelope text-white text-xl"></i>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Total Emails</h4>
                        <p class="text-3xl font-bold bg-gradient-to-r from-blue-500 to-blue-600 bg-clip-text text-transparent" id="totalEmails">0</p>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-green-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-check-circle text-white text-xl"></i>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Successfully Sent</h4>
                        <p class="text-3xl font-bold bg-gradient-to-r from-green-500 to-green-600 bg-clip-text text-transparent" id="sentEmails">0</p>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-red-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-times-circle text-white text-xl"></i>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Failed</h4>
                        <p class="text-3xl font-bold bg-gradient-to-r from-red-500 to-red-600 bg-clip-text text-transparent" id="failedEmails">0</p>
                    </div>
                    <div class="glass-effect rounded-2xl p-6 text-center shadow-md border border-indigo-100 hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center mx-auto mb-3 shadow-md">
                            <i class="fas fa-percentage text-white text-xl"></i>
                        </div>
                        <h4 class="text-sm text-gray-600 mb-2 font-medium">Success Rate</h4>
                        <p class="text-3xl font-bold bg-gradient-to-r from-indigo-500 to-indigo-600 bg-clip-text text-transparent" id="successRate">0%</p>
                    </div>
                </div>
                
                <!-- Filters and Actions -->
                <div class="glass-effect rounded-2xl shadow-md p-6 mb-6 border border-gray-100" style="overflow: visible; position: relative; z-index: 10;">
                    <div class="flex gap-4 items-center mb-4" style="overflow: visible;">
                        <select id="filterEmailType" onchange="fetchEmailLogs()" class="border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" style="position: relative; z-index: 1;">
                            <option value="all">All Types</option>
                            <option value="otp">OTP</option>
                            <option value="receipt">Receipt</option>
                            <option value="status_update">Status Update</option>
                        </select>
                        <select id="filterEmailStatus" onchange="fetchEmailLogs()" class="border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" style="position: relative; z-index: 1;">
                            <option value="all">All Status</option>
                            <option value="sent">Sent</option>
                            <option value="failed">Failed</option>
                        </select>
                        <input type="text" id="searchEmail" placeholder="Search by email..." 
                               onkeyup="fetchEmailLogs()" class="flex-1 border border-gray-200 rounded-xl p-3 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" style="position: relative; z-index: 1;" />
                        
                        <!-- Kebab Menu -->
                        <div class="relative" id="emailKebabMenu" style="z-index: 100;">
                            <button type="button" onclick="toggleEmailMenu()" id="emailMenuBtn"
                                    class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white p-3 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-ellipsis-v text-xl"></i>
                            </button>
                            <div id="emailMenuDropdown" class="hidden bg-white shadow-2xl border border-gray-200" style="position: absolute; right: 0; top: 100%; margin-top: 0.5rem; width: 14rem; z-index: 10000; border-radius: 0.75rem; overflow: visible;">
                                <button type="button" onclick="exportEmailLogsToExcel(); toggleEmailMenu()" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-gray-100" style="border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;">
                                    <i class="fas fa-file-excel text-green-600 w-5"></i>
                                    <span class="font-semibold text-gray-700">Export to Excel</span>
                                </button>
                                <button type="button" onclick="enterEmailArchiveMode(); toggleEmailMenu()" id="archiveEmailLogsBtnMenu" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-gray-100">
                                    <i class="fas fa-archive text-blue-900 w-5"></i>
                                    <span class="font-semibold text-gray-700">Archive Logs</span>
                                </button>
                                <button type="button" onclick="toggleArchivedView(); toggleEmailMenu()" id="viewArchivedBtnMenu" class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3" style="border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem;">
                                    <i class="fas fa-folder-open text-gray-600 w-5"></i>
                                    <span class="font-semibold text-gray-700">View Archived</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="emailLogActions" class="hidden flex gap-2">
                        <button onclick="archiveAllEmailLogs()" id="archiveAllBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-archive mr-2"></i>Archive All
                        </button>
                        <button onclick="archiveSelectedLogs()" id="archiveLogsBtn" class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-check-square mr-2"></i>Archive Selected (<span id="selectedCount">0</span>)
                        </button>
                        <button onclick="restoreAllEmailLogs()" id="restoreAllBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-undo mr-2"></i>Restore All
                        </button>
                        <button onclick="restoreSelectedLogs()" id="restoreLogsBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-check-square mr-2"></i>Restore Selected (<span id="selectedCountRestore">0</span>)
                        </button>
                        <button onclick="deleteSelectedLogs()" id="deleteLogsBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-trash mr-2"></i>Delete Selected (<span id="selectedCountDelete">0</span>)
                        </button>
                        <button onclick="exitEmailArchiveMode()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl font-bold text-sm">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                    </div>
                </div>
                
                <!-- Email Logs Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden" style="position: relative; z-index: 1;">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-900 mb-4" id="emailLogsTableTitle">Email History</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left email-log-checkbox-column hidden">
                                        <input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs()" class="w-4 h-4">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Log ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Recipient</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Subject</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Sent At</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogsTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Settings Tab -->
            <div id="content-admin-settings" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-6">
                    <h2 class="text-3xl font-bold text-gray-900 mb-1">Settings</h2>
                    <p class="text-gray-500 text-sm">Manage your system settings and preferences</p>
                </div>
                
                <!-- Settings Navigation Tabs -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex border-b border-gray-200 overflow-x-auto">
                        <button onclick="switchSettingsTab('system')" id="settings-tab-system" 
                                class="settings-tab px-6 py-3 font-medium text-gray-900 border-b-2 border-gray-900 whitespace-nowrap">
                            System
                        </button>
                        <button onclick="switchSettingsTab('working-hours')" id="settings-tab-working-hours" 
                                class="settings-tab px-6 py-3 font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Working Hours
                        </button>
                        <button onclick="switchSettingsTab('special-dates')" id="settings-tab-special-dates" 
                                class="settings-tab px-6 py-3 font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Special Dates
                        </button>
                        <button onclick="switchSettingsTab('account')" id="settings-tab-account" 
                                class="settings-tab px-6 py-3 font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                            Account
                        </button>
                    </div>
                </div>
                
                <!-- System Settings Content -->
                <div id="settings-content-system" class="settings-content">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-w-3xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">System Configuration</h3>
                        
                        <div class="space-y-6">
                            <!-- Order Cutoff Time -->
                            <div class="pb-6 border-b border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Order Cutoff Time</label>
                                <p class="text-xs text-gray-500 mb-3">Minutes before closing time to stop accepting new orders</p>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="orderCutoffMinutes" value="30" min="0" max="120" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    <span class="text-sm text-gray-600">minutes</span>
                                </div>
                            </div>
                            
                            <!-- Auto-Move Pending Orders -->
                            <div class="pb-6 border-b border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Auto-Move Pending Orders</label>
                                <p class="text-xs text-gray-500 mb-3">Automatically move pending orders to next business day at closing time</p>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoMovePending" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                    <span class="ml-3 text-sm text-gray-700">Enabled</span>
                                </label>
                            </div>
                            
                            <!-- Average Processing Time -->
                            <div class="pb-6 border-b border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Average Processing Time</label>
                                <p class="text-xs text-gray-500 mb-3">Base time per order for queue estimation</p>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="avgProcessTime" value="5" min="1" max="60" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    <span class="text-sm text-gray-600">minutes</span>
                                </div>
                            </div>
                            
                            <!-- Item Complexity Factor -->
                            <div class="pb-6 border-b border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Item Complexity Factor</label>
                                <p class="text-xs text-gray-500 mb-3">Additional time per item in order</p>
                                <div class="flex items-center gap-3">
                                    <input type="number" id="itemComplexity" value="2" min="0" max="10" 
                                           class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    <span class="text-sm text-gray-600">minutes per item</span>
                                </div>
                            </div>
                            
                            <!-- Daily Queue Reset -->
                            <div class="pb-6 border-b border-gray-200">
                                <label class="block text-sm font-medium text-gray-700 mb-3">Daily Queue Reset</label>
                                <p class="text-xs text-gray-500 mb-3">Reset queue number counter at start of business day</p>
                                <button onclick="resetDailyQueue()" 
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors">
                                    Reset Queue Number
                                </button>
                                <div id="queueResetMessage" class="mt-2 text-xs font-medium"></div>
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button onclick="saveSystemSettings()" 
                                        class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors">
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Working Hours Content -->
                <div id="settings-content-working-hours" class="settings-content hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-w-3xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Operating Hours</h3>
                        
                        <div id="workingHoursForm" class="space-y-3" data-days-generated="false">
                            <!-- Days will be generated dynamically by JavaScript -->
                        </div>
                        
                        <div id="hoursUpdateMessage" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Special Dates Content -->
                <div id="settings-content-special-dates" class="settings-content hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-w-3xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Special Dates & Holidays</h3>
                        
                        <form id="specialHourForm" class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="specialDate" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                                <input type="text" id="specialReason" placeholder="e.g., National Holiday, Maintenance" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Opening Time</label>
                                    <input type="time" id="specialOpenTime" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Closing Time</label>
                                    <input type="time" id="specialCloseTime" 
                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="specialClosed" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                <label for="specialClosed" class="text-sm text-gray-700">Mark as Closed Day</label>
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button type="submit" 
                                        class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors">
                                    Add Special Date
                                </button>
                            </div>
                        </form>
                        
                        <div id="specialHoursList" class="space-y-2 max-h-96 overflow-y-auto border-t border-gray-200 pt-4">
                            <!-- Special hours will be listed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Account Content -->
                <div id="settings-content-account" class="settings-content hidden">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 max-w-3xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6">Change Password</h3>
                        
                        <form id="passwordUpdateForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Current Password</label>
                                <input type="password" id="currentPassword" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                <input type="password" id="newPassword" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                <input type="password" id="confirmPassword" 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required />
                            </div>
                            
                            <div class="flex justify-end pt-2">
                                <button type="submit" 
                                        class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors">
                                    Update Password
                                </button>
                            </div>
                        </form>

                        <div id="passwordUpdateMessage" class="mt-4 text-sm font-medium"></div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Admin Management Tab -->
            <div id="content-admin-management" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">
                    <i class="fas fa-users-cog mr-2"></i>Admin Management Center
                </h2>
                
                <!-- Sub-Navigation Tabs -->
                <div class="bg-white rounded-lg shadow mb-6">
                    <div class="flex border-b">
                        <button onclick="switchAdminTab('accounts')" id="admin-subtab-accounts" 
                                class="flex-1 px-6 py-4 font-bold text-blue-900 border-b-4 border-blue-500 bg-blue-50">
                            <i class="fas fa-users mr-2"></i>Admin Accounts
                        </button>
                        <button onclick="switchAdminTab('logs')" id="admin-subtab-logs" 
                                class="flex-1 px-6 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-50">
                            <i class="fas fa-clipboard-list mr-2"></i>Activity Logs
                        </button>
                    </div>
                </div>

                <!-- Admin Accounts Sub-Tab -->
                <div id="admin-content-accounts" class="admin-subtab-content">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm mb-1">Total Admins</p>
                                    <p class="text-3xl font-bold" id="totalAdminsCount">0</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm mb-1">Super Admins</p>
                                    <p class="text-3xl font-bold" id="superAdminsCount">0</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-crown text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white p-6 rounded-lg shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100 text-sm mb-1">Archived</p>
                                    <p class="text-3xl font-bold" id="archivedAdminsCount">0</p>
                                </div>
                                <div class="bg-white bg-opacity-20 p-3 rounded-full">
                                    <i class="fas fa-archive text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Create New Admin Form -->
                    <div class="bg-white rounded-lg shadow-lg mb-6">
                        <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white p-4 rounded-t-lg">
                            <h3 class="text-xl font-bold">
                                <i class="fas fa-user-plus mr-2"></i>Create New Admin Account
                            </h3>
                        </div>
                        <div class="p-6">
                            <form id="createAdminForm" class="space-y-4">
                                <div class="grid grid-cols-2 gap-6">
                                    <div>
                                        <label class="block font-bold mb-2 text-gray-700">
                                            <i class="fas fa-user mr-1 text-blue-600"></i>Full Name *
                                        </label>
                                        <input type="text" id="newAdminFullName" required 
                                               class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" 
                                               placeholder="Enter full name" />
                                    </div>
                                    <div>
                                        <label class="block font-bold mb-2 text-gray-700">
                                            <i class="fas fa-id-badge mr-1 text-blue-600"></i>Username *
                                        </label>
                                        <input type="text" id="newAdminUsername" required 
                                               class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" 
                                               placeholder="Enter username" />
                                    </div>
                                    <div>
                                        <label class="block font-bold mb-2 text-gray-700">
                                            <i class="fas fa-envelope mr-1 text-blue-600"></i>Email *
                                        </label>
                                        <input type="email" id="newAdminEmail" required 
                                               class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" 
                                               placeholder="admin@example.com" />
                                    </div>
                                    <div>
                                        <label class="block font-bold mb-2 text-gray-700">
                                            <i class="fas fa-lock mr-1 text-blue-600"></i>Password * (min 8 characters)
                                        </label>
                                        <input type="password" id="newAdminPassword" required minlength="8" 
                                               class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" 
                                               placeholder="" />
                                    </div>
                                    <div class="col-span-2">
                                        <label class="flex items-center gap-3 p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-purple-50 hover:border-purple-300 transition">
                                            <input type="checkbox" id="newAdminSuperAdmin" class="w-5 h-5 text-purple-600" />
                                            <div>
                                                <span class="font-bold text-gray-800">
                                                    <i class="fas fa-crown mr-2 text-purple-600"></i>Super Admin Privileges
                                                </span>
                                                <p class="text-sm text-gray-600">Grant full access to all admin features including logs and admin management</p>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <button type="submit" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all">
                                    <i class="fas fa-plus-circle mr-2"></i>Create Admin Account
                                </button>
                            </form>
                            <div id="createAdminMessage" class="mt-4 text-sm font-medium"></div>
                        </div>
                    </div>
                    
                    <!-- View Archived Button and Search -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="flex gap-4 items-center justify-between">
                            <div class="flex-1">
                                <input type="text" id="searchAdmins" placeholder="Search by name, username, or email..." 
                                       onkeyup="filterAdmins()" 
                                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" />
                            </div>
                            <button onclick="toggleArchivedAdminsView()" id="viewArchivedAdminsBtn" 
                                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-bold whitespace-nowrap shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-archive mr-2"></i>View Archived
                            </button>
                        </div>
                    </div>
                    
                    <!-- Admins List -->
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-gray-50 p-6 border-b-2 border-gray-200">
                            <h3 class="text-xl font-bold text-blue-900" id="adminAccountsTableTitle">
                                <i class="fas fa-users mr-2"></i>Admin Accounts
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-hashtag mr-1"></i>ID
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-user mr-1"></i>Full Name
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-id-badge mr-1"></i>Username
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-envelope mr-1"></i>Email
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-shield-alt mr-1"></i>Role
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-cog mr-1"></i>Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="adminAccountsTableBody" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activity Logs Sub-Tab -->
                <div id="admin-content-logs" class="admin-subtab-content hidden">
                    <!-- Logs Stats -->
                    <div class="grid grid-cols-4 gap-6 mb-6">
                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm mb-1">Total Activities</p>
                                    <p class="text-3xl font-bold text-blue-900" id="totalLogsCount">0</p>
                                </div>
                                <i class="fas fa-list text-4xl text-blue-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm mb-1">Today's Actions</p>
                                    <p class="text-3xl font-bold text-green-700" id="todayLogsCount">0</p>
                                </div>
                                <i class="fas fa-calendar-day text-4xl text-green-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm mb-1">Active Admins</p>
                                    <p class="text-3xl font-bold text-purple-700" id="activeAdminsLogsCount">0</p>
                                </div>
                                <i class="fas fa-user-check text-4xl text-purple-500"></i>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-orange-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm mb-1">Action Types</p>
                                    <p class="text-3xl font-bold text-orange-700" id="actionTypesCount">0</p>
                                </div>
                                <i class="fas fa-tasks text-4xl text-orange-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-6 rounded-lg shadow-lg mb-6">
                        <h3 class="text-lg font-bold text-blue-900 mb-4">
                            <i class="fas fa-filter mr-2"></i>Filter Activity Logs
                        </h3>
                        <div class="grid grid-cols-4 gap-4">
                            <div>
                                <label class="block font-bold mb-2 text-gray-700 text-sm">
                                    <i class="fas fa-user mr-1"></i>Admin
                                </label>
                                <select id="filterLogAdmin" onchange="fetchAdminLogs()" 
                                        class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                                    <option value="all">All Admins</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-bold mb-2 text-gray-700 text-sm">
                                    <i class="fas fa-bolt mr-1"></i>Action Type
                                </label>
                                <select id="filterLogAction" onchange="fetchAdminLogs()" 
                                        class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition">
                                    <option value="all">All Actions</option>
                                    <optgroup label="Admin Actions">
                                        <option value="admin_create">Admin Created</option>
                                        <option value="admin_update">Admin Updated</option>
                                        <option value="admin_archive">Admin Archived</option>
                                        <option value="admin_restore">Admin Restored</option>
                                        <option value="admin_delete">Admin Deleted</option>
                                    </optgroup>
                                    <optgroup label="Student Actions">
                                        <option value="student_update">Student Updated</option>
                                        <option value="student_archive">Student Archived</option>
                                        <option value="student_restore">Student Restored</option>
                                    </optgroup>
                                    <optgroup label="Other Actions">
                                        <option value="order_status_update">Order Status Update</option>
                                        <option value="email_archive">Email Archived</option>
                                        <option value="email_restore">Email Restored</option>
                                        <option value="inventory_update">Inventory Update</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label class="block font-bold mb-2 text-gray-700 text-sm">
                                    <i class="fas fa-calendar mr-1"></i>Date
                                </label>
                                <input type="date" id="filterLogDate" onchange="fetchAdminLogs()" 
                                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" />
                            </div>
                            <div>
                                <label class="block font-bold mb-2 text-gray-700 text-sm">
                                    <i class="fas fa-search mr-1"></i>Search
                                </label>
                                <input type="text" id="searchLogs" placeholder="Search logs..." 
                                       onkeyup="fetchAdminLogs()" 
                                       class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-blue-500 focus:ring focus:ring-blue-200 transition" />
                            </div>
                        </div>
                        <div class="mt-4 flex gap-4">
                            <button onclick="fetchAdminLogs()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh Logs
                            </button>
                            <button onclick="resetLogFilters()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-redo mr-2"></i>Reset Filters
                            </button>
                            <button onclick="enterAdminLogExportMode()" id="startAdminLogExportBtn"
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg hover:shadow-xl transition-all">
                                <i class="fas fa-file-excel mr-2"></i>Export
                            </button>
                        </div>
                        <div id="adminLogActions" class="hidden mt-4 flex gap-2">
                            <button onclick="exportAllAdminLogs()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fas fa-file-excel mr-2"></i>Export All
                            </button>
                            <button onclick="exportSelectedAdminLogs()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fas fa-check-square mr-2"></i>Export Selected (<span id="selectedAdminLogCount">0</span>)
                            </button>
                            <button onclick="exitAdminLogExportMode()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-6 border-b-2 border-blue-200">
                            <h3 class="text-xl font-bold text-blue-900">
                                <i class="fas fa-clipboard-list mr-2"></i>Activity Timeline
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                                    <tr>
                                        <th class="px-6 py-4 text-left admin-log-checkbox-column hidden">
                                            <input type="checkbox" id="selectAllAdminLogs" onchange="toggleSelectAllAdminLogs()" class="w-4 h-4">
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-clock mr-1"></i>Time
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-user mr-1"></i>Admin
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-bolt mr-1"></i>Action
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-info-circle mr-1"></i>Description
                                        </th>
                                        <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase">
                                            <i class="fas fa-network-wired mr-1"></i>IP Address
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="adminLogsTableBody" class="divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                                            <p>Loading activity logs...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Admin Modal -->
            <div id="editAdminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Edit Admin Account</h3>
                    <form id="editAdminForm" class="space-y-4">
                        <input type="hidden" id="editAdminId" />
                        <div>
                            <label class="block font-bold mb-1">Full Name</label>
                            <input type="text" id="editAdminFullName" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Username</label>
                            <input type="text" id="editAdminUsername" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Email</label>
                            <input type="email" id="editAdminEmail" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">New Password (leave blank to keep current)</label>
                            <input type="password" id="editAdminPassword" minlength="8" class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editAdminSuperAdmin" class="w-4 h-4" />
                                <span class="font-bold">Super Admin</span>
                            </label>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                                Update
                            </button>
                            <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <div id="editAdminMessage" class="mt-4 text-sm font-medium"></div>
                </div>
            </div>

            <!-- Student Details Modal -->
            <div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-blue-900" id="studentModalTitle">Student Details</h3>
                            <button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="flex gap-2 mt-4">
                            <button onclick="switchStudentTab('current')" id="student-tab-current" class="px-4 py-2 rounded font-bold bg-blue-900 text-white">
                                Current Order
                            </button>
                            <button onclick="switchStudentTab('info')" id="student-tab-info" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Student Info
                            </button>
                            <button onclick="switchStudentTab('breakdown')" id="student-tab-breakdown" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Order Breakdown
                            </button>
                            <button onclick="switchStudentTab('history')" id="student-tab-history" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Order History
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
                        <!-- Current Order Tab -->
                        <div id="student-content-current" class="student-tab-content">
                            <div id="studentCurrentOrder"></div>
                        </div>
                        
                        <!-- Student Info Tab -->
                        <div id="student-content-info" class="student-tab-content hidden">
                            <div id="studentInfoContent"></div>
                        </div>
                        
                        <!-- Order Breakdown Tab -->
                        <div id="student-content-breakdown" class="student-tab-content hidden">
                            <div id="studentOrderBreakdown"></div>
                        </div>
                        
                        <!-- Order History Tab -->
                        <div id="student-content-history" class="student-tab-content hidden">
                            <div id="studentOrderHistory"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-queue-history" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent mb-2">Queue History</h2>
                    <p class="text-gray-600">View and analyze past order records</p>
                </div>
                
                <div class="glass-effect rounded-2xl shadow-md p-6 mb-6 border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="filterHistoryDate" class="block text-sm font-semibold text-gray-700 mb-2">Filter by Date</label>
                            <input type="date" id="filterHistoryDate" onchange="fetchHistory()" class="border border-gray-200 rounded-xl p-3 w-full focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                        </div>
                        <div>
                            <label for="filterHistoryStatus" class="block text-sm font-semibold text-gray-700 mb-2">Filter by Status</label>
                            <select id="filterHistoryStatus" onchange="fetchHistory()" class="border border-gray-200 rounded-xl p-3 w-full focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="ready">Ready</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchHistory" class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                            <input type="text" id="searchHistory" placeholder="Student ID, Queue #" 
                                   onkeyup="fetchHistory()" class="border border-gray-200 rounded-xl p-3 w-full focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-transparent mb-2">Actions</label>
                            <button onclick="resetHistoryFilters()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-4 py-3 rounded-xl font-semibold w-full shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-effect rounded-2xl shadow-md overflow-hidden border border-gray-100">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-gray-50 to-blue-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Queue ID</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Date Placed</th>
                                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-100 bg-white">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-analytics" class="tab-content hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <h2 class="text-3xl font-bold bg-gradient-to-r from-blue-900 to-blue-700 bg-clip-text text-transparent mb-2 flex items-center gap-2">
                        <i class="fas fa-chart-line"></i>Order Analytics Dashboard
                    </h2>
                    <p class="text-gray-600">Visualize trends and monitor performance metrics</p>
                </div>
                
                <!-- Control Panel -->
                <div class="glass-effect rounded-2xl shadow-md p-6 mb-6 border border-gray-100">
                    <div class="flex gap-3 items-center flex-wrap">
                        <button onclick="toggleRealtimeAnalytics()" id="realtimeBtn" 
                                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-5 py-2.5 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                            <i class="fas fa-play mr-2"></i>Start Real-time
                        </button>
                        <button onclick="refreshAnalyticsData()" 
                                class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-5 py-2.5 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh Data
                        </button>
                        <button onclick="resetAnalyticsCharts()" 
                                class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-5 py-2.5 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5">
                            <i class="fas fa-redo mr-2"></i>Reset
                        </button>
                        
                        <!-- Date Range Filter -->
                        <div class="flex gap-2 items-center border-l border-gray-300 pl-4">
                            <label class="text-sm font-semibold text-gray-700">
                                <i class="fas fa-calendar mr-1"></i>Period:
                            </label>
                            <select id="analyticsDateFilter" onchange="changeDateFilter(this.value)" 
                                    class="px-3 py-2 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                                <option value="daily">Today</option>
                                <option value="weekly">This Week</option>
                                <option value="monthly">This Month</option>
                                <option value="custom">Custom Range</option>
                            </select>
                            
                            <!-- Custom Date Range Inputs (Hidden by default) -->
                            <div id="customDateRange" class="hidden flex gap-2 items-center">
                                <input type="date" id="startDate" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                                <span class="text-gray-500">to</span>
                                <input type="date" id="endDate" class="px-3 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                                <button onclick="applyCustomDateRange()" class="bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white px-4 py-2 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transition-all duration-300">
                                    Apply
                                </button>
                            </div>
                        </div>
                        
                        <div class="ml-auto text-sm text-gray-600">
                            <span id="analyticsUpdateTime">Last updated: --:--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Total Orders</p>
                                <p class="text-3xl font-bold text-blue-600" id="analyticsTotalOrders">0</p>
                            </div>
                            <div class="text-4xl text-blue-600">
                                <i class="fas fa-box"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Pending</p>
                                <p class="text-3xl font-bold text-yellow-600" id="analyticsPendingOrders">0</p>
                            </div>
                            <div class="text-4xl text-yellow-600">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Completed</p>
                                <p class="text-3xl font-bold text-green-600" id="analyticsCompletedOrders">0</p>
                            </div>
                            <div class="text-4xl text-green-600">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-sm">Avg Wait Time</p>
                                <p class="text-3xl font-bold text-purple-600" id="analyticsAvgWaitTime">0m</p>
                            </div>
                            <div class="text-4xl text-purple-600">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Orders Over Time (Line Chart) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">
                            <i class="fas fa-chart-line text-blue-600 mr-2"></i>Orders Over Time
                        </h2>
                        <div style="position: relative; height: 300px;">
                            <canvas id="analyticsOrdersTimeChart"></canvas>
                        </div>
                    </div>

                    <!-- Order Status Distribution (Pie Chart) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">
                            <i class="fas fa-chart-pie text-blue-600 mr-2"></i>Status Distribution
                        </h2>
                        <div style="position: relative; height: 300px;">
                            <canvas id="analyticsStatusPieChart"></canvas>
                        </div>
                    </div>

                    <!-- Items Demand (Bar Chart) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">
                            <i class="fas fa-chart-bar text-blue-600 mr-2"></i>Popular Items
                        </h2>
                        <div style="position: relative; height: 300px;">
                            <canvas id="analyticsItemsBarChart"></canvas>
                        </div>
                    </div>

                    <!-- Hourly Activity (Animated Bar Chart) -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4">
                            <i class="fas fa-clock text-blue-600 mr-2"></i>Hourly Activity
                        </h2>
                        <div style="position: relative; height: 300px;">
                            <canvas id="analyticsHourlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Real-time Activity Feed -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-4">
                        <i class="fas fa-stream text-blue-600 mr-2"></i>Live Order Stream
                    </h2>
                    <div id="analyticsActivityFeed" class="space-y-2 max-h-64 overflow-y-auto scroll-smooth">
                        <p class="text-gray-500 text-sm">Waiting for data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '../../php/api';
        let ordersData = [];
        let studentsData = [];
        let refreshInterval = null;
        let currentQueueOrder = null;
        let queueIndex = 0;
        let ordersChart = null;
        let currentAnalyticsPeriod = 'daily';
        let showingArchivedLogs = false;
        let selectedLogIds = [];
        let inventoryStock = {};
        
        // Archive variables
        let showingArchivedStudents = false;
        let showingArchivedAdmins = false;
        
        // Analytics variables
        let realtimeAnalyticsInterval = null;
        let isRealtimeAnalytics = false;
        let analyticsCharts = {};

        // Check if admin is logged in
        if (!sessionStorage.getItem('adminLoggedIn')) {
            window.location.href = 'admin_login.html';
        }

        // Display current date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = 'Today is: ' + new Date().toLocaleDateString('en-US', options);

        // Tab switching
        function showTab(tabName) {
            console.log('=== SWITCHING TO TAB:', tabName, '===');
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                console.log('Hidden tab:', tab.id);
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('nav li').forEach(item => {
                // Remove all orange/active styling
                item.classList.remove('bg-orange-500', 'hover:bg-orange-600', 'bg-gradient-to-r', 'from-orange-500', 'to-orange-600', 'border-orange-300', 'shadow-lg');
                // Add default styling (inactive tabs have no shadow by default)
                item.classList.add('border-transparent', 'hover:bg-blue-700/60', 'hover:shadow-md', 'hover:border-orange-400');
                // Update font weight for inactive tabs
                const span = item.querySelector('.menu-text');
                if (span) {
                    span.classList.remove('font-semibold');
                    span.classList.add('font-medium');
                }
            });
            
            // Show selected tab
            const contentElement = document.getElementById('content-' + tabName);
            console.log('Found element:', contentElement);
            if (contentElement) {
                contentElement.classList.remove('hidden');
                console.log('Removed hidden class from:', contentElement.id);
                console.log('Element classes after:', contentElement.className);
                console.log('Element display style:', window.getComputedStyle(contentElement).display);
                console.log('Element visibility:', window.getComputedStyle(contentElement).visibility);
                console.log('Element has content:', contentElement.children.length > 0);
            } else {
                console.error(' Tab element not found: content-' + tabName);
            }
            
            // Add active class to selected menu item
            const activeItem = document.getElementById('tab-' + tabName);
            if (activeItem) {
                // Remove default styling
                activeItem.classList.remove('border-transparent', 'hover:bg-blue-700/60', 'hover:shadow-md', 'hover:border-orange-400');
                // Add active styling
                activeItem.classList.add('bg-orange-500', 'hover:bg-orange-600', 'border-orange-300', 'shadow-lg');
                // Update font weight for active tab
                const span = activeItem.querySelector('.menu-text');
                if (span) {
                    span.classList.remove('font-medium');
                    span.classList.add('font-semibold');
                }
            }

            // Fetch data for the tab if it's one of the new ones
            if (tabName === 'queue-management') {
                fetchOrders();
            } else if (tabName === 'queue-history') {
                fetchHistory();
            } else if (tabName === 'analytics') {
                initAnalyticsCharts();
                generateAnalyticsData();
            } else if (tabName === 'student-records') {
                fetchStudents();
            } else if (tabName === 'email-logs') {
                fetchEmailLogs();
            } else if (tabName === 'service-config') {
                loadInventory();
            } else if (tabName === 'admin-management') {
                switchAdminTab('accounts');
                fetchAdminAccounts();
            }
            
            console.log('=== TAB SWITCH COMPLETE ===');
        }

        // Logout function
        async function logout() {
            sessionStorage.clear();
            window.location.href = '../index.html';
        }

        // Debug function to check PHP session
        async function checkPHPSession() {
            try {
                const response = await fetch(`${API_BASE}/admin/check_session.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                console.log('=== PHP SESSION CHECK ===');
                console.log('Session Active:', result.session_active);
                console.log('Session ID:', result.session_id);
                console.log('Session Data:', result.session_data);
                console.log('JavaScript sessionStorage:', JSON.parse(sessionStorage.getItem('adminData')));
                console.log('========================');
                return result;
            } catch (error) {
                console.error('Session check error:', error);
            }
        }

        // Auto-check session on page load
        setTimeout(() => {
            console.log('%c Checking PHP Session...', 'color: orange; font-weight: bold; font-size: 14px;');
            checkPHPSession();
        }, 1000);

        // Fetch orders from API
        async function fetchOrders() {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'GET',
                    credentials: 'include' // Important for session cookies
                });
                
                const result = await response.json();
                
                if (result.success) {
                    ordersData = result.data.orders;
                    displayQueueTable();
                    updateCounts(result.data.stats);
                    updateCurrentQueue();
                    updateConnectionStatus(true);
                } else if (response.status === 401) {
                    // Session expired, redirect to login
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                updateConnectionStatus(false);
            }
        }

        // Fetch students from API
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php?archived=${showingArchivedStudents}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    studentsData = result.data.students;
                    updateStudentTable();
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching students:', error);
            }
        }

        // Update student table display
        function updateStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            if (!studentsData || studentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500">No students found</td></tr>';
                return;
            }

            const adminData = JSON.parse(sessionStorage.getItem('adminData'));

            studentsData.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Determine account status
                const hasAccount = student.has_account == 1;
                const accountStatusBadge = hasAccount 
                    ? '<span class="inline-flex items-center gap-1 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Registered</span>'
                    : '<span class="inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>Guest Only</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 student-checkbox-column hidden">
                        <input type="checkbox" class="student-checkbox w-4 h-4" data-student-id="${student.student_id}" onchange="handleStudentCheckbox()">
                    </td>
                    <td class="px-6 py-4 font-mono text-sm">${student.student_id || 'N/A'}</td>
                    <td class="px-6 py-4 font-semibold">${student.first_name || ''} ${student.last_name || ''}</td>
                    <td class="px-6 py-4">${student.email || 'N/A'}</td>
                    <td class="px-6 py-4">${accountStatusBadge}</td>
                    <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold text-sm">${student.total_orders || 0}</span></td>
                    <td class="px-6 py-4 text-sm">${student.college || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm">${student.program || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick="viewStudentDetails('${student.student_id}')" 
                                    class="text-blue-600 hover:text-blue-800 font-bold text-sm">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter students based on search
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            
            if (!searchTerm) {
                updateStudentTable();
                return;
            }

            const filtered = studentsData.filter(student => {
                return (student.student_id && student.student_id.toLowerCase().includes(searchTerm)) ||
                       (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                       (student.first_name && student.first_name.toLowerCase().includes(searchTerm)) ||
                       (student.last_name && student.last_name.toLowerCase().includes(searchTerm));
            });

            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500">No matching students found</td></tr>';
                return;
            }

            filtered.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Determine account status
                const hasAccount = student.has_account == 1;
                const accountStatusBadge = hasAccount 
                    ? '<span class="inline-flex items-center gap-1 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Registered</span>'
                    : '<span class="inline-flex items-center gap-1 bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>Guest Only</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 student-checkbox-column hidden">
                        <input type="checkbox" class="student-checkbox w-4 h-4" data-student-id="${student.student_id}" onchange="handleStudentCheckbox()">
                    </td>
                    <td class="px-6 py-4 font-mono text-sm">${student.student_id || 'N/A'}</td>
                    <td class="px-6 py-4 font-semibold">${student.first_name || ''} ${student.last_name || ''}</td>
                    <td class="px-6 py-4">${student.email || 'N/A'}</td>
                    <td class="px-6 py-4">${accountStatusBadge}</td>
                    <td class="px-6 py-4"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-bold text-sm">${student.total_orders || 0}</span></td>
                    <td class="px-6 py-4 text-sm">${student.college || 'N/A'}</td>
                    <td class="px-6 py-4 text-sm">${student.program || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <button onclick="viewStudentDetails('${student.student_id}')" class="text-blue-600 hover:text-blue-800 font-bold text-sm">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // View student details in modal
        async function viewStudentDetails(studentId) {
            const student = studentsData.find(s => s.student_id === studentId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            // Show modal
            document.getElementById('studentDetailsModal').classList.remove('hidden');
            document.getElementById('studentDetailsModal').classList.add('flex');
            document.getElementById('studentModalTitle').textContent = `${student.first_name} ${student.last_name} (${student.student_id})`;
            
            // Switch to current order tab
            switchStudentTab('current');
            
            // Load student data
            await loadStudentCurrentOrder(studentId);
            loadStudentInfo(student);
            await loadStudentOrderBreakdown(studentId);
            await loadStudentOrderHistory(studentId);
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('studentDetailsModal').classList.add('hidden');
            document.getElementById('studentDetailsModal').classList.remove('flex');
        }

        // Switch student modal tabs
        function switchStudentTab(tabName) {
            // Update button styles
            ['current', 'info', 'breakdown', 'history'].forEach(tab => {
                const btn = document.getElementById(`student-tab-${tab}`);
                const content = document.getElementById(`student-content-${tab}`);
                if (tab === tabName) {
                    btn.className = 'px-4 py-2 rounded font-bold bg-blue-900 text-white';
                    content.classList.remove('hidden');
                } else {
                    btn.className = 'px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300';
                    content.classList.add('hidden');
                }
            });
        }

        // Load student current order
        async function loadStudentCurrentOrder(studentId) {
            const container = document.getElementById('studentCurrentOrder');
            container.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            // Find current orders for this student
            const currentOrders = ordersData.filter(o => 
                o.student_id === studentId && 
                (o.order_status === 'pending' || o.order_status === 'processing' || o.order_status === 'ready')
            );
            
            if (currentOrders.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No current orders in queue</div>';
                return;
            }
            
            container.innerHTML = currentOrders.map(order => {
                const statusColor = getStatusColor(order.order_status);
                const createdTime = new Date(order.created_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg text-blue-900">Queue #${order.queue_number}</h4>
                                <p class="text-sm text-gray-500">${createdTime}</p>
                            </div>
                            <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                                ${capitalizeWords(order.order_status)}
                            </span>
                        </div>
                        <div class="space-y-2">
                            <p><span class="font-bold">Item:</span> ${capitalizeWords(order.item_ordered)}</p>
                            <p><span class="font-bold">Wait Time:</span> ${order.estimated_wait_time} minutes</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load student information
        function loadStudentInfo(student) {
            const container = document.getElementById('studentInfoContent');
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            const isSuperAdmin = adminData && adminData.is_super_admin == 1;
            const isArchived = student.is_archived == 1;
            
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Personal Information</h4>
                        <div><span class="font-bold">Student ID:</span> ${student.student_id || 'N/A'}</div>
                        <div><span class="font-bold">Full Name:</span> ${student.first_name} ${student.last_name}</div>
                        <div><span class="font-bold">Email:</span> ${student.email || 'N/A'}</div>
                        ${isArchived ? '<div class="text-orange-600 font-bold"><i class="fas fa-archive mr-2"></i>This student is archived</div>' : ''}
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Academic Information</h4>
                        <div><span class="font-bold">College:</span> ${student.college || 'N/A'}</div>
                        <div><span class="font-bold">Program:</span> ${student.program || 'N/A'}</div>
                        <div><span class="font-bold">Year Level:</span> ${student.year_level || 'N/A'}</div>
                        <div><span class="font-bold">Section:</span> ${student.section || 'N/A'}</div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t flex gap-4">
                    ${isSuperAdmin && !isArchived ? `
                        <button onclick="editStudentInfo('${student.student_id}')" 
                                class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            <i class="fas fa-edit mr-2"></i>Edit Student Information
                        </button>
                    ` : ''}
                    ${!isArchived ? `
                        <button onclick="archiveStudentFromModal('${student.student_id}', '${student.first_name} ${student.last_name}')" 
                                class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded font-bold">
                            <i class="fas fa-archive mr-2"></i>Archive Student
                        </button>
                    ` : ''}
                    ${isArchived && isSuperAdmin ? `
                        <button onclick="restoreStudentFromModal('${student.student_id}', '${student.first_name} ${student.last_name}')" 
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold">
                            <i class="fas fa-undo mr-2"></i>Restore Student
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // Edit student information (super admin only)
        async function editStudentInfo(studentId) {
            const student = studentsData.find(s => s.student_id === studentId);
            if (!student) return;
            
            const container = document.getElementById('studentInfoContent');
            container.innerHTML = `
                <form id="editStudentForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Personal Information</h4>
                            <div>
                                <label class="block font-bold mb-1">First Name</label>
                                <input type="text" id="edit_first_name" value="${student.first_name || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Last Name</label>
                                <input type="text" id="edit_last_name" value="${student.last_name || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Email</label>
                                <input type="email" id="edit_email" value="${student.email || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Academic Information</h4>
                            <div>
                                <label class="block font-bold mb-1">College</label>
                                <input type="text" id="edit_college" value="${student.college || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Program</label>
                                <input type="text" id="edit_program" value="${student.program || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Year Level</label>
                                <input type="text" id="edit_year_level" value="${student.year_level || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Section</label>
                                <input type="text" id="edit_section" value="${student.section || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Save Changes
                        </button>
                        <button type="button" onclick="loadStudentInfo(studentsData.find(s => s.student_id === '${studentId}'))" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                            Cancel
                        </button>
                    </div>
                </form>
            `;
            
            // Add form submit handler
            document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveStudentChanges(studentId);
            });
        }

        // Save student changes (super admin only)
        async function saveStudentChanges(studentId) {
            const updatedData = {
                student_id: studentId,
                first_name: document.getElementById('edit_first_name').value,
                last_name: document.getElementById('edit_last_name').value,
                email: document.getElementById('edit_email').value,
                college: document.getElementById('edit_college').value,
                program: document.getElementById('edit_program').value,
                year_level: document.getElementById('edit_year_level').value,
                section: document.getElementById('edit_section').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Student information updated successfully', 'success');
                    // Refresh student data
                    await fetchStudents();
                    // Reload student info
                    const updatedStudent = studentsData.find(s => s.student_id === studentId);
                    if (updatedStudent) {
                        loadStudentInfo(updatedStudent);
                    }
                } else {
                    alert(result.message || 'Failed to update student information');
                }
            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student information');
            }
        }

        // Load student order breakdown
        async function loadStudentOrderBreakdown(studentId) {
            const container = document.getElementById('studentOrderBreakdown');
            container.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            // Get all orders for this student
            const studentOrders = ordersData.filter(o => o.student_id === studentId);
            
            // Calculate breakdown by status
            const breakdown = {
                completed: studentOrders.filter(o => o.order_status === 'completed').length,
                cancelled: studentOrders.filter(o => o.order_status === 'cancelled').length,
                pending: studentOrders.filter(o => o.order_status === 'pending').length,
                processing: studentOrders.filter(o => o.order_status === 'processing').length,
                ready: studentOrders.filter(o => o.order_status === 'ready').length,
                total: studentOrders.length
            };
            
            // Calculate breakdown by item (split comma-separated items)
            const itemBreakdown = {};
            studentOrders.forEach(order => {
                const itemsString = order.item_ordered || 'Unknown';
                // Split by comma and process each item separately
                const items = itemsString.split(',').map(i => i.trim());
                items.forEach(item => {
                    itemBreakdown[item] = (itemBreakdown[item] || 0) + 1;
                });
            });
            
            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Total Orders Summary -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
                        <h4 class="text-2xl font-bold text-blue-900 mb-2">Total Orders</h4>
                        <p class="text-5xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">${breakdown.total}</p>
                    </div>
                    
                    <!-- Status Breakdown -->
                    <div>
                        <h4 class="text-xl font-bold text-blue-900 mb-4">
                            <i class="fas fa-chart-pie mr-2"></i>Order Status Breakdown
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div class="bg-white rounded-xl p-4 border-l-4 border-green-500 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Completed</p>
                                        <p class="text-3xl font-bold text-green-600">${breakdown.completed}</p>
                                    </div>
                                    <div class="bg-green-100 p-3 rounded-full">
                                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border-l-4 border-red-500 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Cancelled</p>
                                        <p class="text-3xl font-bold text-red-600">${breakdown.cancelled}</p>
                                    </div>
                                    <div class="bg-red-100 p-3 rounded-full">
                                        <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border-l-4 border-orange-500 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Pending</p>
                                        <p class="text-3xl font-bold text-orange-600">${breakdown.pending}</p>
                                    </div>
                                    <div class="bg-orange-100 p-3 rounded-full">
                                        <i class="fas fa-clock text-orange-600 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border-l-4 border-blue-500 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Processing</p>
                                        <p class="text-3xl font-bold text-blue-600">${breakdown.processing}</p>
                                    </div>
                                    <div class="bg-blue-100 p-3 rounded-full">
                                        <i class="fas fa-spinner text-blue-600 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl p-4 border-l-4 border-indigo-500 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm text-gray-600 font-semibold">Ready</p>
                                        <p class="text-3xl font-bold text-indigo-600">${breakdown.ready}</p>
                                    </div>
                                    <div class="bg-indigo-100 p-3 rounded-full">
                                        <i class="fas fa-bell text-indigo-600 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items Breakdown -->
                    <div>
                        <h4 class="text-xl font-bold text-blue-900 mb-4">
                            <i class="fas fa-box mr-2"></i>Most Ordered Items
                        </h4>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase">Item</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase">Orders</th>
                                        <th class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase">Percentage</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${Object.entries(itemBreakdown)
                                        .sort((a, b) => b[1] - a[1])
                                        .map(([item, count]) => {
                                            const percentage = ((count / breakdown.total) * 100).toFixed(1);
                                            return `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 font-semibold text-gray-800">${item}</td>
                                                    <td class="px-6 py-4 text-center">
                                                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">${count}</span>
                                                    </td>
                                                    <td class="px-6 py-4 text-center">
                                                        <span class="text-gray-600 font-semibold">${percentage}%</span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            if (breakdown.total === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500"><i class="fas fa-inbox text-5xl mb-3 text-gray-300"></i><p class="text-lg">No orders found for this student</p></div>';
            }
        }

        // Load student order history
        async function loadStudentOrderHistory(studentId) {
            const container = document.getElementById('studentOrderHistory');
            container.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php?filter=history&student_id=${studentId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success && result.data.orders) {
                    const orders = result.data.orders;
                    
                    if (orders.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-gray-500">No order history found</div>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Queue #</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${orders.map(order => {
                                    const statusColor = getStatusColor(order.order_status);
                                    const createdDate = new Date(order.created_at).toLocaleString('en-US', {
                                        year: 'numeric', month: 'short', day: 'numeric', 
                                        hour: '2-digit', minute: '2-digit'
                                    });
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3">${order.queue_number}</td>
                                            <td class="px-4 py-3">${capitalizeWords(order.item_ordered || order.item_name)}</td>
                                            <td class="px-4 py-3">${createdDate}</td>
                                            <td class="px-4 py-3">
                                                <span class="${statusColor} text-white px-2 py-1 rounded text-xs font-bold uppercase">
                                                    ${capitalizeWords(order.order_status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Error loading order history</div>';
                }
            } catch (error) {
                console.error('Error loading student order history:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Error loading order history</div>';
            }
        }

        // --- ADDED: New function to fetch data for the Queue History tab ---
        async function fetchHistory() {
            const date = document.getElementById('filterHistoryDate').value;
            const status = document.getElementById('filterHistoryStatus').value;
            const search = document.getElementById('searchHistory').value;

            // We pass ?filter=history to get ALL orders
            let url = `${API_BASE}/admin/admin_orders.php?filter=history`;
            if (date) url += `&date=${date}`;
            if (status !== 'all') url += `&status=${status}`;
            if (search) url += `&search=${search}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    displayHistoryTable(result.data.orders);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching order history:', error);
            }
        }

        // --- ADDED: New function to display the history table ---
        function displayHistoryTable(orders) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No order history found for these filters.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const createdDate = new Date(order.created_at).toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // Format items with quantity - show unique items only
                const items = order.item_ordered ? order.item_ordered.split(',').map(i => i.trim()) : [];
                const itemCount = items.length;
                const uniqueItems = [...new Set(items)];
                const itemText = uniqueItems.map(item => capitalizeWords(item)).join(', ');
                const itemDisplay = itemCount > 1 ? `<strong>${itemCount} items:</strong> ${itemText}` : capitalizeWords(order.item_ordered);

                row.innerHTML = `
                    <td class="px-6 py-4">${order.queue_number}</td>
                    <td class="px-6 py-4">${order.first_name} ${order.last_name} (${order.student_id})</td>
                    <td class="px-6 py-4">${itemDisplay}</td>
                    <td class="px-6 py-4">${createdDate}</td>
                    <td class="px-6 py-4">
                        <span class="${getStatusColor(order.order_status)} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                            ${order.order_status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- ADDED: New function to reset history filters ---
        function resetHistoryFilters() {
            document.getElementById('filterHistoryDate').value = '';
            document.getElementById('filterHistoryStatus').value = 'all';
            document.getElementById('searchHistory').value = '';
            fetchHistory();
        }

        // Set analytics period and fetch data
        function setAnalyticsPeriod(period) {
            currentAnalyticsPeriod = period;
            
            // Update button styles
            ['daily', 'weekly', 'monthly', 'yearly', 'custom'].forEach(p => {
                const btn = document.getElementById(`btn-${p}`);
                if (p === period) {
                    btn.className = 'px-4 py-2 rounded font-bold bg-blue-900 text-white';
                } else {
                    btn.className = 'px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });
            
            // Show/hide custom date range
            const customDateRange = document.getElementById('customDateRange');
            if (period === 'custom') {
                customDateRange.classList.remove('hidden');
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                document.getElementById('customStartDate').value = weekAgo;
                document.getElementById('customEndDate').value = today;
            } else {
                customDateRange.classList.add('hidden');
                fetchAnalyticsByPeriod(period);
            }
        }

        // Apply custom date range
        async function applyCustomDateRange() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            if (!startDate || !endDate) {
                await showAlert('Please select both start and end dates.', 'warning');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                await showAlert('Start date must be before end date.', 'warning');
                return;
            }
            
            fetchAnalyticsByDateRange(startDate, endDate);
        }

        // Fetch analytics based on period
        async function fetchAnalyticsByPeriod(period) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_reports.php?period=${period}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    displayAnalytics(result.data, period, result.data.date_range);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    console.error('Analytics API Error:', result);
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        }

        // Fetch analytics by custom date range
        async function fetchAnalyticsByDateRange(startDate, endDate) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_reports.php?start=${startDate}&end=${endDate}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    displayAnalytics(result.data, 'custom', result.data.date_range);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    console.error('Analytics API Error:', result);
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        }

        // Helper function to capitalize words properly
        function capitalizeWords(str) {
            if (!str) return 'N/A';
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Display analytics data with Chart.js
        function displayAnalytics(data, period, dateRange) {
            // Update summary cards
            document.getElementById('analyticsTotalOrders').textContent = data.summary.total_orders || 0;
            document.getElementById('analyticsTotalCompleted').textContent = data.summary.completed_orders || 0;
            
            // Fix top item display to handle empty data
            if (data.top_items && data.top_items.length > 0 && data.top_items[0].item_ordered) {
                document.getElementById('analyticsTopItem').textContent = capitalizeWords(data.top_items[0].item_ordered);
            } else {
                document.getElementById('analyticsTopItem').textContent = 'N/A';
            }

            // Update date range displays
            const dateRangeText = dateRange ? `${dateRange.start} to ${dateRange.end}` : 'Loading...';
            document.getElementById('statusDateRange').textContent = dateRangeText;
            document.getElementById('productDateRange').textContent = dateRangeText;

            // Populate order status breakdown table
            const statusBody = document.getElementById('analyticsStatusBody');
            statusBody.innerHTML = '';
            if (data.status_breakdown && data.status_breakdown.length > 0) {
                const totalOrders = data.summary.total_orders || 1;
                data.status_breakdown.forEach(status => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const percentage = ((status.count / totalOrders) * 100).toFixed(1);
                    const statusColor = getStatusColor(status.status);
                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold">
                                ${capitalizeWords(status.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 font-bold">${status.count}</td>
                        <td class="px-6 py-4">${percentage}%</td>
                    `;
                    statusBody.appendChild(row);
                });
            } else {
                statusBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500">No status data found for this period.</td></tr>';
            }

            // Populate product quantities table
            const productQtyBody = document.getElementById('analyticsProductQtyBody');
            productQtyBody.innerHTML = '';
            if (data.product_quantities && data.product_quantities.length > 0) {
                data.product_quantities.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4">${capitalizeWords(product.item_name)}</td>
                        <td class="px-6 py-4 font-bold text-blue-600">${product.quantity_sold}</td>
                    `;
                    productQtyBody.appendChild(row);
                });
            } else {
                productQtyBody.innerHTML = '<tr><td colspan="2" class="px-6 py-8 text-center text-gray-500">No product data found for this period.</td></tr>';
            }

            // Populate top items with enhanced card layout
            const topItemsBody = document.getElementById('analyticsTopItemsBody');
            topItemsBody.innerHTML = '';
            if (!data.top_items || data.top_items.length === 0) {
                topItemsBody.innerHTML = '<div class="text-center py-8 text-gray-500">No item data found for this period.</div>';
            } else {
                // Get max value for calculating bar widths
                const maxTotal = Math.max(...data.top_items.map(item => item.total));
                
                data.top_items.forEach((item, index) => {
                    const percentage = (item.total / maxTotal) * 100;
                    const rankColors = [
                        'bg-gradient-to-r from-yellow-400 to-orange-500',
                        'bg-gradient-to-r from-gray-300 to-gray-400',
                        'bg-gradient-to-r from-orange-300 to-orange-400',
                        'bg-gradient-to-r from-blue-400 to-blue-500'
                    ];
                    const barColor = index < 3 ? rankColors[index] : rankColors[3];
                    const rankBadgeColors = [
                        'bg-yellow-500 text-white',
                        'bg-gray-400 text-white',
                        'bg-orange-400 text-white',
                        'bg-blue-500 text-white'
                    ];
                    const badgeColor = index < 3 ? rankBadgeColors[index] : rankBadgeColors[3];
                    
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="${badgeColor} px-3 py-1 rounded-full text-sm font-bold">
                                    #${index + 1}
                                </span>
                                <div>
                                    <h4 class="font-bold text-gray-900">${capitalizeWords(item.item_ordered)}</h4>
                                    <p class="text-sm text-gray-500">${item.total} orders</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-blue-900">${item.total}</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="${barColor} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    topItemsBody.appendChild(card);
                });
            }

            // Render chart
            renderOrdersChart(data.timeline || [], period);
        }

        // Render Chart.js chart
        function renderOrdersChart(timeline, period) {
            const ctx = document.getElementById('ordersChart');
            
            // Destroy existing chart if it exists
            if (ordersChart) {
                ordersChart.destroy();
            }

            // Prepare data
            const labels = timeline.map(t => t.label || t.date);
            const ordersData = timeline.map(t => t.total_orders || 0);
            const completedData = timeline.map(t => t.completed_orders || 0);

            // Get descriptive title
            const periodTitles = {
                'daily': 'Today\'s Orders by Hour',
                'weekly': 'Orders by Week',
                'monthly': 'Orders by Month',
                'yearly': 'Orders by Year',
                'custom': 'Orders Trend'
            };

            // Create chart
            ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Orders',
                            data: ordersData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Completed Orders',
                            data: completedData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: periodTitles[period] || 'Orders Trend',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Initialize queue table
        function displayQueueTable(filteredOrders = null) {
            const tbody = document.getElementById('queueTableBody');
            tbody.innerHTML = '';

            const dataToDisplay = filteredOrders || ordersData;

            if (dataToDisplay.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                    </svg>
                                </div>
                                <p class="text-gray-500 font-medium">No orders found</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            dataToDisplay.forEach((order, index) => {
                const row = document.createElement('tr');
                row.className = 'group hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-200 border-b border-gray-100 last:border-b-0';
                row.style.animation = `fadeInUp 0.3s ease-out ${index * 0.05}s both`;
                
                const createdTime = new Date(order.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                // Format items with quantity - show unique items only
                const items = order.item_ordered ? order.item_ordered.split(',').map(i => i.trim()) : [];
                const itemCount = items.length;
                const uniqueItems = [...new Set(items)];
                const itemText = uniqueItems.map(item => capitalizeWords(item)).join(', ');
                const itemDisplay = itemCount > 1 
                    ? `<span class="font-semibold text-blue-900">${itemCount} items:</span> <span class="text-gray-700">${itemText}</span>` 
                    : `<span class="text-gray-700">${capitalizeWords(order.item_ordered)}</span>`;
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-blue-900 text-base">${order.queue_number}</span>
                            ${order.reference_number ? `<span class="text-xs text-purple-600 font-semibold mt-0.5">Ref: ${order.reference_number}</span>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-medium text-gray-700">${order.student_id}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${itemDisplay}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2 text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-medium">${createdTime}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="${getStatusColor(order.order_status)} text-white px-3 py-1.5 rounded-lg text-xs font-bold uppercase shadow-sm">
                            ${order.order_status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateOrderStatus(${order.order_id}, this.value)" 
                                class="border-2 border-gray-200 hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 rounded-lg px-3 py-2 text-sm font-medium text-gray-700 bg-white transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md">
                            <option value="pending" ${order.order_status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${order.order_status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="ready" ${order.order_status === 'ready' ? 'selected' : ''}>Ready for Pick Up</option>
                            <option value="completed" ${order.order_status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${order.order_status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Add CSS animation keyframes if not already present
        if (!document.querySelector('style[data-queue-animations]')) {
            const style = document.createElement('style');
            style.setAttribute('data-queue-animations', 'true');
            style.textContent = `
                @keyframes fadeInUp {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-orange-500',
                'processing': 'bg-blue-500',
                'ready': 'bg-indigo-600',
                'completed': 'bg-green-600',
                'cancelled': 'bg-red-600'
            };
            return colors[status] || 'bg-gray-500';
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store queue number before fetchOrders clears currentQueueOrder
                    const queueNumber = currentQueueOrder ? currentQueueOrder.queue_number : 'N/A';
                    
                    // Refresh orders to show updated status
                    await fetchOrders();
                    
                    // Show success message
                    const statusLabels = {
                        'processing': 'started processing',
                        'ready': 'marked as ready',
                        'completed': 'completed',
                        'cancelled': 'cancelled'
                    };
                    
                    showNotification(`Order ${queueNumber} ${statusLabels[newStatus]}!`, 'success');
                } else {
                    await showAlert(result.message || 'Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                await showAlert('An error occurred while updating the order status', 'error');
            }
        }

        function updateCounts(stats) {
            if (stats) {
                document.getElementById('pendingCount').textContent = stats.pending || 0;
                document.getElementById('readyCount').textContent = stats.ready || 0;
                document.getElementById('doneCount').textContent = stats.completed || 0;
            } else {
                // Fallback to counting from ordersData
                const pending = ordersData.filter(o => o.order_status === 'pending').length;
                const ready = ordersData.filter(o => o.order_status === 'ready').length;
                const completed = ordersData.filter(o => o.order_status === 'completed').length;
                
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('readyCount').textContent = ready;
                document.getElementById('doneCount').textContent = completed;
            }
        }

        // Connection status indicator
        function updateConnectionStatus(isConnected) {
            const statusDot = document.getElementById('connectionStatus');
            if (isConnected) {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            } else {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Refresh every 5 seconds
            refreshInterval = setInterval(() => {
                fetchOrders();
            }, 5000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Queue Management Functions
        function updateCurrentQueue() {
            const pendingOrders = ordersData.filter(o => o.order_status === 'pending' || o.order_status === 'processing');
            
            // --- ADDED: Get references to the button containers ---
            const startButtonDiv = document.getElementById('queue-action-start');
            const processButtonsDiv = document.getElementById('queue-action-process');

            if (pendingOrders.length === 0) {
                // No orders in queue
                document.getElementById('currentOrderCard').classList.add('hidden');
                document.getElementById('noQueueMessage').classList.remove('hidden');
                currentQueueOrder = null;

                // --- ADDED: Hide both button containers if no order ---
                startButtonDiv.classList.add('hidden');
                processButtonsDiv.classList.add('hidden');

                document.getElementById('queuePosition').textContent = 'Queue: 0 of 0';
                return;
            }
            
            // Show first pending order
            document.getElementById('currentOrderCard').classList.remove('hidden');
            document.getElementById('noQueueMessage').classList.add('hidden');
            
            currentQueueOrder = pendingOrders[0];

            // ... (all the code that updates text content, from line 536 to 563) ...
            document.getElementById('currentStudentProgram').textContent = `${currentQueueOrder.program} - ${currentQueueOrder.year_level} ${currentQueueOrder.section}` || 'N/A';
            
            // --- ADDED: This block controls which buttons are visible ---
            if (currentQueueOrder.order_status === 'pending') {
                startButtonDiv.classList.remove('hidden');
                processButtonsDiv.classList.add('hidden');
            } else if (currentQueueOrder.order_status === 'processing') {
                startButtonDiv.classList.add('hidden');
                processButtonsDiv.classList.remove('hidden');
            }
            // --- END OF ADDED BLOCK ---
            
            // Update queue position
            document.getElementById('queuePosition').textContent = `Queue: 1 of ${pendingOrders.length}`;
            
            // Update order information
            document.getElementById('currentQueueNumber').textContent = currentQueueOrder.queue_number;
            document.getElementById('currentItemOrdered').textContent = currentQueueOrder.item_ordered;
            const createdTime = new Date(currentQueueOrder.created_at).toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('currentTimePlaced').textContent = createdTime;
            
            // Update student information
            document.getElementById('currentStudentId').textContent = currentQueueOrder.student_id;
            document.getElementById('currentStudentName').textContent = `${currentQueueOrder.first_name} ${currentQueueOrder.last_name}`;
            document.getElementById('currentStudentEmail').textContent = currentQueueOrder.email;
            document.getElementById('currentStudentProgram').textContent = `${currentQueueOrder.program} - ${currentQueueOrder.year_level} ${currentQueueOrder.section}` || 'N/A';
        }
        
        async function processQueue(newStatus) {
            if (!currentQueueOrder) {
                await showAlert('No order in queue to process', 'warning');
                return;
            }
            
            const confirmMessages = {
                'processing': 'Start processing this order?',
                'ready': 'Mark this order as ready for pickup?',
                'completed': 'Mark this order as completed?',
                'cancelled': 'Cancel this order? This action cannot be undone.'
            };
            
            const confirmed = await showConfirm(confirmMessages[newStatus]);
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: currentQueueOrder.order_id,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store queue number before fetchOrders clears currentQueueOrder
                    const queueNumber = currentQueueOrder ? currentQueueOrder.queue_number : 'N/A';
                    
                    // Refresh orders to show updated status
                    await fetchOrders();
                    
                    // Show success message
                    const statusLabels = {
                        'processing': 'started processing',
                        'ready': 'marked as ready',
                        'completed': 'completed',
                        'cancelled': 'cancelled'
                    };
                    
                    showNotification(`Order ${queueNumber} ${statusLabels[newStatus]}!`, 'success');
                } else {
                    await showAlert(result.message || 'Failed to update order status', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                await showAlert('An error occurred while updating the order status', 'error');
            }
        }
        
        async function skipQueue() {
            if (!currentQueueOrder) {
                await showAlert('No order in queue to skip', 'warning');
                return;
            }
            
            const confirmed = await showConfirm('Skip this order? It will remain in the queue but move to the end.');
            if (!confirmed) {
                return;
            }
            
            // Move current order to end of pending orders
            const currentIndex = ordersData.findIndex(o => o.order_id === currentQueueOrder.order_id);
            if (currentIndex !== -1) {
                const skippedOrder = ordersData.splice(currentIndex, 1)[0];
                ordersData.push(skippedOrder);
                updateCurrentQueue();
                showNotification(`Order ${currentQueueOrder.queue_number} skipped`, 'info');
            }
        }
        
        function showNotification(message, type = 'success') {
            // Create notification container if it doesn't exist
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 9999;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    max-width: 400px;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
            }

            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-orange-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>`,
                error: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>`,
                warning: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                          </svg>`,
                info: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                       </svg>`
            };

            notification.innerHTML = `
                <div class="flex items-center gap-3 ${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl animate-slide-in" style="pointer-events: auto;">
                    ${icons[type]}
                    <span class="font-semibold">${message}</span>
                    <button onclick="this.closest('.notification-toast').remove()" class="ml-2 hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;

            notification.style.cssText = `
                animation: slideIn 0.3s ease-out;
                width: 100%;
            `;

            // Add to container (new notifications appear at the bottom)
            container.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                    // Remove container if no notifications left
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }, 5000);

            // Limit to max 5 notifications
            while (container.children.length > 5) {
                container.firstChild.remove();
            }
        }

        // Custom Alert Modal
        function showAlert(message, type = 'info') {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'custom-modal-overlay';
                
                const icons = {
                    success: `<svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                              </svg>`,
                    error: `<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>`,
                    warning: `<svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                              </svg>`,
                    info: `<svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                           </svg>`
                };
                
                modal.innerHTML = `
                    <div class="custom-modal-content animate-modal-in">
                        <div class="flex flex-col items-center text-center p-6">
                            <div class="mb-4">
                                ${icons[type] || icons.info}
                            </div>
                            <p class="text-gray-700 text-lg mb-6 whitespace-pre-line">${message}</p>
                            <button onclick="this.closest('.custom-modal-overlay').remove()" 
                                    class="px-8 py-2.5 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-semibold hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                                OK
                            </button>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve();
                    }
                };
                
                modal.querySelector('button').onclick = () => {
                    modal.remove();
                    resolve();
                };
                
                document.body.appendChild(modal);
            });
        }

        // Custom Confirm Modal
        function showConfirm(message, options = {}) {
            return new Promise((resolve) => {
                const {
                    confirmText = 'Confirm',
                    cancelText = 'Cancel',
                    type = 'warning',
                    danger = false
                } = options;
                
                const modal = document.createElement('div');
                modal.className = 'custom-modal-overlay';
                
                const icons = {
                    warning: `<svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                              </svg>`,
                    danger: `<svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                             </svg>`,
                    info: `<svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                           </svg>`
                };
                
                const confirmButtonClass = danger 
                    ? 'px-6 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-lg hover:shadow-xl'
                    : 'px-6 py-2.5 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-lg font-semibold hover:from-orange-600 hover:to-orange-700 transition-all duration-200 shadow-lg hover:shadow-xl';
                
                modal.innerHTML = `
                    <div class="custom-modal-content animate-modal-in">
                        <div class="flex flex-col items-center text-center p-6">
                            <div class="mb-4">
                                ${icons[danger ? 'danger' : type]}
                            </div>
                            <p class="text-gray-700 text-lg mb-6 whitespace-pre-line">${message}</p>
                            <div class="flex gap-3">
                                <button class="cancel-btn px-6 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200">
                                    ${cancelText}
                                </button>
                                <button class="confirm-btn ${confirmButtonClass}">
                                    ${confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
                
                modal.querySelector('.cancel-btn').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                modal.querySelector('.confirm-btn').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.body.appendChild(modal);
            });
        }

        // Fetch email logs from API
        async function fetchEmailLogs() {
            try {
                const type = document.getElementById('filterEmailType').value;
                const status = document.getElementById('filterEmailStatus').value;
                const search = document.getElementById('searchEmail').value;
                
                const response = await fetch(`${API_BASE}/admin/email_logs.php?type=${type}&status=${status}&search=${search}&archived=${showingArchivedLogs}&limit=100`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayEmailLogs(result.data.logs);
                    updateEmailStats(result.data.stats);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching email logs:', error);
            }
            selectedLogIds = [];
            updateSelectedCount();
        }

        // Display email logs in table
        function displayEmailLogs(logs) {
            const tbody = document.getElementById('emailLogsTableBody');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No email logs found</td></tr>';
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = log.status === 'sent' ? 'bg-green-500' : 'bg-red-500';
                const sentTime = new Date(log.sent_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const typeColors = {
                    'otp': 'bg-blue-100 text-blue-800',
                    'receipt': 'bg-green-100 text-green-800',
                    'status_update': 'bg-purple-100 text-purple-800'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4 email-log-checkbox-column hidden">
                        <input type="checkbox" class="log-checkbox w-4 h-4" data-log-id="${log.log_id}" onchange="handleLogCheckbox()">
                    </td>
                    <td class="px-6 py-4">${log.log_id || 'N/A'}</td>
                    <td class="px-6 py-4">${log.recipient_email || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="${typeColors[log.email_type] || 'bg-gray-100 text-gray-800'} px-2 py-1 rounded text-xs font-bold uppercase">
                            ${(log.email_type || '').replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4">${log.subject || 'N/A'}</td>
                    <td class="px-6 py-4">${sentTime}</td>
                    <td class="px-6 py-4">
                        <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                            ${log.status || 'N/A'}
                        </span>
                    </td>
                `;
                
                // Add error message tooltip if failed
                if (log.status === 'failed' && log.error_message) {
                    row.title = `Error: ${log.error_message}`;
                    row.style.cursor = 'help';
                }
                
                tbody.appendChild(row);
            });
        }

        // Update email statistics
        function updateEmailStats(stats) {
            document.getElementById('totalEmails').textContent = stats.total || 0;
            document.getElementById('sentEmails').textContent = stats.sent || 0;
            document.getElementById('failedEmails').textContent = stats.failed || 0;
            
            const successRate = stats.total > 0 ? ((stats.sent / stats.total) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Toggle archived view
        function toggleArchivedView() {
            showingArchivedLogs = !showingArchivedLogs;
            const viewArchivedBtn = document.getElementById('viewArchivedBtnMenu');
            const archiveBtn = document.getElementById('archiveEmailLogsBtnMenu');
            const title = document.getElementById('emailLogsTableTitle');
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            const isSuperAdmin = adminData && adminData.is_super_admin == 1;
            
            if (showingArchivedLogs) {
                // Viewing archived logs
                if (viewArchivedBtn) {
                    viewArchivedBtn.innerHTML = '<i class="fas fa-eye text-green-600 w-5"></i><span class="font-semibold text-gray-700">View Active</span>';
                }
                if (archiveBtn) {
                    archiveBtn.innerHTML = '<i class="fas fa-undo text-green-600 w-5"></i><span class="font-semibold text-gray-700">Restore Logs</span>';
                }
                title.textContent = 'Archived Email Logs';
            } else {
                // Viewing active logs
                if (viewArchivedBtn) {
                    viewArchivedBtn.innerHTML = '<i class="fas fa-folder-open text-gray-600 w-5"></i><span class="font-semibold text-gray-700">View Archived</span>';
                }
                if (archiveBtn) {
                    archiveBtn.innerHTML = '<i class="fas fa-archive text-blue-900 w-5"></i><span class="font-semibold text-gray-700">Archive Logs</span>';
                }
                title.textContent = 'Email History';
            }
            fetchEmailLogs();
        }

        // Handle individual checkbox selection
        function handleLogCheckbox() {
            selectedLogIds = Array.from(document.querySelectorAll('.log-checkbox:checked'))
                .map(cb => cb.dataset.logId);
            updateSelectedCount();
        }

        // Toggle select all checkboxes
        function toggleSelectAllLogs() {
            const selectAll = document.getElementById('selectAllLogs').checked;
            document.querySelectorAll('.log-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
            handleLogCheckbox();
        }

        // Update selected count display
        function updateSelectedCount() {
            const count = selectedLogIds.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedCountRestore').textContent = count;
            document.getElementById('selectedCountDelete').textContent = count;
        }

        /**
         * Enter email archive mode - show checkboxes and action buttons
         */
        function enterEmailArchiveMode() {
            // Show checkbox column
            document.querySelectorAll('.email-log-checkbox-column').forEach(el => {
                el.classList.remove('hidden');
            });
            
            // Determine which buttons to show based on archive status
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            const isSuperAdmin = adminData && adminData.is_super_admin == 1;
            
            if (showingArchivedLogs) {
                // In archived view - show restore/delete buttons
                document.getElementById('archiveAllBtn').classList.add('hidden');
                document.getElementById('archiveLogsBtn').classList.add('hidden');
                document.getElementById('restoreAllBtn').classList.remove('hidden');
                document.getElementById('restoreLogsBtn').classList.remove('hidden');
                if (isSuperAdmin) {
                    document.getElementById('deleteLogsBtn').classList.remove('hidden');
                }
            } else {
                // In active view - show archive buttons
                document.getElementById('archiveAllBtn').classList.remove('hidden');
                document.getElementById('archiveLogsBtn').classList.remove('hidden');
                document.getElementById('restoreAllBtn').classList.add('hidden');
                document.getElementById('restoreLogsBtn').classList.add('hidden');
                document.getElementById('deleteLogsBtn').classList.add('hidden');
            }
            
            // Show action panel, hide kebab menu
            document.getElementById('emailLogActions').classList.remove('hidden');
            document.getElementById('emailKebabMenu').classList.add('hidden');
            
            // Reset selection
            selectedLogIds = [];
            document.getElementById('selectAllLogs').checked = false;
            updateSelectedCount();
        }

        /**
         * Exit email archive mode - hide checkboxes and action buttons
         */
        function exitEmailArchiveMode() {
            // Hide checkbox column
            document.querySelectorAll('.email-log-checkbox-column').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Hide action panel, show kebab menu
            document.getElementById('emailLogActions').classList.add('hidden');
            document.getElementById('emailKebabMenu').classList.remove('hidden');
            
            // Reset selection
            selectedLogIds = [];
            document.getElementById('selectAllLogs').checked = false;
            document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }

        /**
         * Archive all email logs (no selection needed)
         */
        async function archiveAllEmailLogs() {
            // Get all visible log IDs
            const allLogIds = Array.from(document.querySelectorAll('.log-checkbox'))
                .map(cb => cb.dataset.logId);
            
            if (allLogIds.length === 0) {
                showNotification('No active logs to archive', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Archive all ${allLogIds.length} visible email logs?`);
            if (!confirmed) {
                return;
            }
            
            try {
                
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'archive',
                        log_ids: allLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Archived ${allLogIds.length} log(s) successfully`, 'success');
                    exitEmailArchiveMode();
                    fetchEmailLogs();
                } else {
                    await showAlert(result.message || 'Failed to archive logs', 'error');
                }
            } catch (error) {
                console.error('Error archiving logs:', error);
                await showAlert('Error archiving logs', 'error');
            }
        }

        /**
         * Restore all email logs (no selection needed)
         */
        async function restoreAllEmailLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin != 1) {
                showNotification('Only super admins can restore logs', 'error');
                return;
            }
            
            const allLogIds = Array.from(document.querySelectorAll('.log-checkbox'))
                .map(cb => cb.dataset.logId);
            
            if (allLogIds.length === 0) {
                showNotification('No archived logs to restore', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Restore all ${allLogIds.length} visible email logs?`);
            if (!confirmed) {
                return;
            }
            
            try {
                
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'restore',
                        log_ids: allLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Restored ${allLogIds.length} log(s) successfully`, 'success');
                    exitEmailArchiveMode();
                    fetchEmailLogs();
                } else {
                    await showAlert(result.message || 'Failed to restore logs', 'error');
                }
            } catch (error) {
                console.error('Error restoring logs:', error);
                await showAlert('Error restoring logs', 'error');
            }
        }

        // Archive selected logs
        async function archiveSelectedLogs() {
            if (selectedLogIds.length === 0) {
                showNotification('Please select logs to archive', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Archive ${selectedLogIds.length} log(s)?`);
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'archive',
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Archived ${selectedLogIds.length} log(s) successfully`, 'success');
                    exitEmailArchiveMode();
                    fetchEmailLogs();
                } else {
                    await showAlert(result.message || 'Failed to archive logs', 'error');
                }
            } catch (error) {
                console.error('Error archiving logs:', error);
                await showAlert('Error archiving logs', 'error');
            }
        }

        // Restore selected logs (super admin only)
        async function restoreSelectedLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin != 1) {
                showNotification('Only super admin can restore archived logs', 'error');
                return;
            }
            
            if (selectedLogIds.length === 0) {
                showNotification('Please select logs to restore', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Restore ${selectedLogIds.length} log(s)?`);
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'restore',
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Restored ${selectedLogIds.length} log(s) successfully`, 'success');
                    exitEmailArchiveMode();
                    fetchEmailLogs();
                } else {
                    await showAlert(result.message || 'Failed to restore logs', 'error');
                }
            } catch (error) {
                console.error('Error restoring logs:', error);
                await showAlert('Error restoring logs', 'error');
            }
        }

        // Delete selected logs permanently (super admin only)
        async function deleteSelectedLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin == 0 || !adminData.is_super_admin) {
                showNotification('Only super admin can permanently delete logs', 'error');
                return;
            }
            
            if (selectedLogIds.length === 0) {
                showNotification('Please select logs to delete', 'warning');
                return;
            }
            
            const confirmed1 = await showConfirm(
                `PERMANENTLY DELETE ${selectedLogIds.length} log(s)?\n\nThis action CANNOT be undone!`,
                { danger: true, confirmText: 'Delete', cancelText: 'Cancel' }
            );
            if (!confirmed1) {
                return;
            }
            
            // Second confirmation for deletion
            const confirmed2 = await showConfirm(
                'Are you absolutely sure?\n\nThis will permanently remove these logs from the database.',
                { danger: true, confirmText: 'Yes, Delete Forever', cancelText: 'Cancel' }
            );
            if (!confirmed2) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Permanently deleted ${selectedLogIds.length} log(s)`, 'success');
                    exitEmailArchiveMode();
                    fetchEmailLogs();
                } else {
                    showNotification(result.message || 'Failed to delete logs', 'error');
                }
            } catch (error) {
                console.error('Error deleting logs:', error);
                showNotification('Error deleting logs', 'error');
            }
        }

        // Fetch inventory stock status
        async function fetchInventoryStatusAdmin() {
            try {
                const response = await fetch(`${API_BASE}/inventory_status.php`);
                const result = await response.json();
                
                if (result.success && result.data.items) {
                    // Convert items array to lookup object for backward compatibility
                    inventoryStock = {};
                    result.data.items.forEach(item => {
                        inventoryStock[item.item_name] = item.is_available && item.stock_quantity > 0;
                    });
                }
            } catch (error) {
                console.error('Error fetching inventory status:', error);
            }
        }

        // Initialize data on page load
        async function initializeDashboard() {
            try {
                const adminData = JSON.parse(sessionStorage.getItem('adminData'));
                if (adminData && adminData.full_name) {
                    // Set name in top bar (first name only)
                    document.getElementById('adminName').textContent = adminData.full_name.split(' ')[0];
                    // Set full name in sidebar
                    document.getElementById('sidebarAdminName').textContent = adminData.full_name;
                    // Set email in sidebar
                    if (adminData.email) {
                        document.getElementById('sidebarAdminEmail').textContent = adminData.email;
                    }
                    // Profile picture is now set to Herons.png by default in HTML
                }
                
                await fetchInventoryStatusAdmin();
                await fetchOrders();
                await fetchStudents();
                // Don't load email logs on init - only when tab is clicked
                // await fetchEmailLogs();
                updateCurrentQueue();
                startAutoRefresh();
            } catch (error) {
                console.error('Dashboard init error:', error);
            }
        }

        // Check if super admin and show management tab
        function checkSuperAdminAccess() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData') || '{}');
            if (adminData && adminData.is_super_admin == 1) {
                document.getElementById('tab-admin-management').classList.remove('hidden');
                // Show export admin logs button for super admin
                const exportAdminLogsBtn = document.getElementById('exportAdminLogsBtn');
                if (exportAdminLogsBtn) {
                    exportAdminLogsBtn.classList.remove('hidden');
                }
            } else {
                // Hide export admin logs button for regular admin
                const exportAdminLogsBtn = document.getElementById('exportAdminLogsBtn');
                if (exportAdminLogsBtn) {
                    exportAdminLogsBtn.classList.add('hidden');
                }
            }
        }

        // Fetch admin accounts
        async function fetchAdminAccounts() {
            try {
                const adminData = JSON.parse(sessionStorage.getItem('adminData'));
                
                // Check if user is super admin before making the request
                if (!adminData || adminData.is_super_admin == 0 || !adminData.is_super_admin) {
                    // Silently return if not super admin - this is expected behavior
                    return;
                }
                
                const response = await fetch(`${API_BASE}/admin/admin_management.php?archived=${showingArchivedAdmins}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAdminAccounts(result.data.admins);
                    updateAdminStats(result.data.admins); // Update stats after loading admins
                    populateAdminFilter(result.data.admins); // Populate admin filter dropdown
                } else if (response.status === 403) {
                    // Silently handle 403 - user is not authorized
                    return;
                } else {
                    console.error('Failed to fetch admin accounts:', result.message);
                }
            } catch (error) {
                // Only log error if it's not a network/403 error
                if (!error.message.includes('403')) {
                    console.error('Error fetching admin accounts:', error);
                }
            }
        }

        // Display admin accounts in table
        function displayAdminAccounts(admins) {
            const tbody = document.getElementById('adminAccountsTableBody');
            tbody.innerHTML = '';
            
            const currentAdminId = JSON.parse(sessionStorage.getItem('adminData') || '{}').admin_id;
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const roleColor = admin.is_super_admin == 1 ? 'bg-purple-500' : 'bg-blue-500';
                const roleText = admin.is_super_admin == 1 ? 'Super Admin' : 'Admin';
                
                const isCurrentUser = admin.admin_id == currentAdminId;
                
                row.innerHTML = `
                    <td class="px-6 py-4">${admin.admin_id}</td>
                    <td class="px-6 py-4">${admin.full_name} ${isCurrentUser ? '(You)' : ''}</td>
                    <td class="px-6 py-4">${admin.username}</td>
                    <td class="px-6 py-4">${admin.email}</td>
                    <td class="px-6 py-4">
                        <span class="${roleColor} text-white px-3 py-1 rounded text-xs font-bold">
                            ${roleText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            ${!showingArchivedAdmins ? `
                                <button onclick='editAdmin(${JSON.stringify(admin)})' 
                                        class="border-2 border-blue-900 text-blue-900 hover:bg-gray-100 px-4 py-1 rounded text-sm font-bold">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                ${!isCurrentUser ? `
                                    <button onclick="archiveAdmin(${admin.admin_id}, '${admin.full_name}')" 
                                            class="border-2 border-orange-600 text-orange-600 hover:bg-orange-50 px-4 py-1 rounded text-sm font-bold">
                                        <i class="fas fa-archive mr-1"></i>Archive
                                    </button>
                                ` : ''}
                            ` : `
                                <button onclick="restoreAdmin(${admin.admin_id}, '${admin.full_name}')" 
                                        class="border-2 border-green-600 text-green-600 hover:bg-green-50 px-4 py-1 rounded text-sm font-bold">
                                    <i class="fas fa-undo mr-1"></i>Restore
                                </button>
                                <button onclick="permanentDeleteAdmin(${admin.admin_id}, '${admin.full_name}')" 
                                        class="border-2 border-red-600 text-red-600 hover:bg-red-50 px-4 py-1 rounded text-sm font-bold">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            `}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Create admin form handler
        document.getElementById('createAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('createAdminMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            messageEl.textContent = '';
            
            const formData = {
                full_name: document.getElementById('newAdminFullName').value,
                username: document.getElementById('newAdminUsername').value,
                email: document.getElementById('newAdminEmail').value,
                password: document.getElementById('newAdminPassword').value,
                is_super_admin: document.getElementById('newAdminSuperAdmin').checked ? 1 : 0
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Admin account created successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    e.target.reset();
                    await fetchAdminAccounts();
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error creating admin:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Admin Account';
            }
        });

        // Edit admin
        function editAdmin(admin) {
            document.getElementById('editAdminId').value = admin.admin_id;
            document.getElementById('editAdminFullName').value = admin.full_name;
            document.getElementById('editAdminUsername').value = admin.username;
            document.getElementById('editAdminEmail').value = admin.email;
            document.getElementById('editAdminPassword').value = '';
            document.getElementById('editAdminSuperAdmin').checked = admin.is_super_admin == 1;
            
            const modal = document.getElementById('editAdminModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditModal() {
            const modal = document.getElementById('editAdminModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editAdminMessage').textContent = '';
        }

        // Edit admin form handler
        document.getElementById('editAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('editAdminMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            messageEl.textContent = '';
            
            const formData = {
                admin_id: document.getElementById('editAdminId').value,
                full_name: document.getElementById('editAdminFullName').value,
                username: document.getElementById('editAdminUsername').value,
                email: document.getElementById('editAdminEmail').value,
                is_super_admin: document.getElementById('editAdminSuperAdmin').checked ? 1 : 0
            };
            
            const password = document.getElementById('editAdminPassword').value;
            if (password) {
                formData.password = password;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Admin account updated successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    await fetchAdminAccounts();
                    setTimeout(closeEditModal, 1500);
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error updating admin:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update';
            }
        });

        // Delete admin
        async function deleteAdmin(adminId, fullName) {
            const confirmed = await showConfirm(
                `Are you sure you want to delete admin account: ${fullName}?\n\nThis action cannot be undone.`,
                { danger: true, confirmText: 'Delete', cancelText: 'Cancel' }
            );
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_id: adminId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Admin account deleted successfully', 'success');
                    await fetchAdminAccounts();
                } else {
                    await showAlert(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                await showAlert('A connection error occurred.', 'error');
            }
        }

        // ============================================
        // ANALYTICS DASHBOARD FUNCTIONS
        // ============================================
        
        // Initialize analytics charts
        function initAnalyticsCharts() {
            // Only initialize if not already done
            if (Object.keys(analyticsCharts).length > 0) {
                return;
            }
            
            // Orders Over Time (Line Chart)
            const ordersTimeCtx = document.getElementById('analyticsOrdersTimeChart').getContext('2d');
            analyticsCharts.ordersTime = new Chart(ordersTimeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Orders',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 750,
                        easing: 'easeInOutQuart'
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Status Pie Chart
            const statusPieCtx = document.getElementById('analyticsStatusPieChart').getContext('2d');
            analyticsCharts.statusPie = new Chart(statusPieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Processing', 'Ready', 'Completed', 'Cancelled'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgb(234, 179, 8)',  // Yellow
                            'rgb(59, 130, 246)',  // Blue
                            'rgb(139, 92, 246)',  // Purple
                            'rgb(34, 197, 94)',   // Green
                            'rgb(239, 68, 68)'    // Red
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Items Bar Chart
            const itemsBarCtx = document.getElementById('analyticsItemsBarChart').getContext('2d');
            analyticsCharts.itemsBar = new Chart(itemsBarCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Number of Orders',
                        data: [],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(234, 179, 8, 0.8)',
                            'rgba(139, 92, 246, 0.8)'
                        ],
                        borderColor: [
                            'rgb(239, 68, 68)',
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(234, 179, 8)',
                            'rgb(139, 92, 246)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + ' orders';
                                }
                            }
                        }
                    }
                }
            });

            // Hourly Activity Chart
            const hourlyCtx = document.getElementById('analyticsHourlyChart').getContext('2d');
            analyticsCharts.hourly = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Orders per Hour',
                        data: Array(24).fill(0),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Fetch analytics data from API
        async function generateAnalyticsData() {
            try {
                const response = await fetch(`${API_BASE}/admin/analytics.php`);
                const result = await response.json();
                
                if (!result.success) {
                    console.error('API Error:', result.error);
                    return;
                }
                
                const data = result.data;
                const now = new Date();
                const timeLabel = now.toLocaleTimeString();
                
                // Update stats cards
                document.getElementById('analyticsTotalOrders').textContent = data.total_orders;
                document.getElementById('analyticsPendingOrders').textContent = data.status_distribution.pending;
                document.getElementById('analyticsCompletedOrders').textContent = data.status_distribution.completed;
                document.getElementById('analyticsAvgWaitTime').textContent = `${data.avg_wait_time}m`;

                // Update status pie chart
                analyticsCharts.statusPie.data.datasets[0].data = [
                    data.status_distribution.pending,
                    data.status_distribution.processing,
                    data.status_distribution.ready,
                    data.status_distribution.completed,
                    data.status_distribution.cancelled
                ];
                analyticsCharts.statusPie.update();

                // Update hourly activity chart
                analyticsCharts.hourly.data.datasets[0].data = data.orders_over_time;
                analyticsCharts.hourly.update();

                // Update popular items bar chart
                if (data.popular_items && data.popular_items.length > 0) {
                    analyticsCharts.itemsBar.data.labels = data.popular_items.map(item => item.item);
                    analyticsCharts.itemsBar.data.datasets[0].data = data.popular_items.map(item => item.count);
                    analyticsCharts.itemsBar.update();
                }

                // Update orders over time line chart (by day)
                if (data.orders_by_day && data.orders_by_day.length > 0) {
                    analyticsCharts.ordersTime.data.labels = data.orders_by_day.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    analyticsCharts.ordersTime.data.datasets[0].data = data.orders_by_day.map(d => d.count);
                    analyticsCharts.ordersTime.update();
                }

                // Update activity feed
                if (data.recent_activity && data.recent_activity.length > 0) {
                    const feed = document.getElementById('analyticsActivityFeed');
                    feed.innerHTML = ''; // Clear existing
                    data.recent_activity.slice(0, 10).forEach(activity => {
                        const time = new Date(activity.time);
                        const statusColors = {
                            'pending': 'yellow',
                            'processing': 'blue',
                            'ready': 'purple',
                            'completed': 'green',
                            'cancelled': 'red'
                        };
                        const statusIcons = {
                            'pending': '<i class="fas fa-hourglass-half text-yellow-600"></i>',
                            'processing': '<i class="fas fa-cog text-blue-600"></i>',
                            'ready': '<i class="fas fa-check-circle text-purple-600"></i>',
                            'completed': '<i class="fas fa-trophy text-green-600"></i>',
                            'cancelled': '<i class="fas fa-times-circle text-red-600"></i>'
                        };
                        const color = statusColors[activity.status] || 'gray';
                        addAnalyticsActivityItem(
                            `${statusIcons[activity.status] || '<i class="fas fa-box"></i>'} Order ${activity.queue_number} - ${activity.student_name} - <span class="text-${color}-600 font-semibold">${activity.status}</span>`,
                            time.toLocaleTimeString()
                        );
                    });
                }

                // Update timestamp
                document.getElementById('analyticsUpdateTime').textContent = `Last updated: ${timeLabel}`;
                
            } catch (error) {
                console.error('Error fetching analytics data:', error);
                addAnalyticsActivityItem('<i class="fas fa-exclamation-triangle text-red-600"></i> Error fetching data from API');
            }
        }

        // Add item to analytics activity feed
        function addAnalyticsActivityItem(message, time = null) {
            const feed = document.getElementById('analyticsActivityFeed');
            const item = document.createElement('div');
            item.className = 'p-3 bg-blue-50 rounded border-l-4 border-blue-500 text-sm animate-fade-in';
            const timestamp = time || new Date().toLocaleTimeString();
            item.innerHTML = `<span class="font-semibold">${timestamp}</span> - ${message}`;
            
            // Limit to 10 items
            if (feed.children.length >= 10) {
                feed.removeChild(feed.lastChild);
            }
            
            // Remove "Waiting for data..." message if it exists
            if (feed.firstChild && feed.firstChild.tagName === 'P') {
                feed.removeChild(feed.firstChild);
            }
            
            // Insert at the top
            feed.insertBefore(item, feed.firstChild);
            
            // Keep scroll position at top (don't auto-scroll)
            feed.scrollTop = 0;
        }

        // Toggle real-time analytics
        function toggleRealtimeAnalytics() {
            isRealtimeAnalytics = !isRealtimeAnalytics;
            const btn = document.getElementById('realtimeBtn');
            
            if (isRealtimeAnalytics) {
                btn.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause Real-time';
                btn.className = 'bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700';
                realtimeAnalyticsInterval = setInterval(generateAnalyticsData, 2000);
            } else {
                btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Real-time';
                btn.className = 'bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700';
                clearInterval(realtimeAnalyticsInterval);
            }
        }

        // Refresh analytics data manually
        function refreshAnalyticsData() {
            generateAnalyticsData();
            addAnalyticsActivityItem('<i class="fas fa-sync-alt text-blue-600"></i> Data refreshed manually');
        }

        // Reset all analytics charts
        function resetAnalyticsCharts() {
            analyticsCharts.ordersTime.data.labels = [];
            analyticsCharts.ordersTime.data.datasets[0].data = [];
            analyticsCharts.ordersTime.update();
            
            analyticsCharts.statusPie.data.datasets[0].data = [0, 0, 0, 0, 0];
            analyticsCharts.statusPie.update();
            
            analyticsCharts.itemsBar.data.datasets[0].data = [];
            analyticsCharts.itemsBar.update();
            
            analyticsCharts.hourly.data.datasets[0].data = Array(24).fill(0);
            analyticsCharts.hourly.update();
            
            document.getElementById('analyticsActivityFeed').innerHTML = '<p class="text-gray-500 text-sm">Waiting for data...</p>';
            addAnalyticsActivityItem('<i class="fas fa-redo text-gray-600"></i> Charts reset');
        }

        // Change date filter
        function changeDateFilter(value) {
            const customDateRange = document.getElementById('customDateRange');
            
            if (value === 'custom') {
                customDateRange.classList.remove('hidden');
                // Set default dates (last 7 days to today)
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            } else {
                customDateRange.classList.add('hidden');
                currentAnalyticsPeriod = value;
                generateAnalyticsData();
                addAnalyticsActivityItem(`<i class="fas fa-calendar text-blue-600"></i> Filter changed to: ${value}`);
            }
        }

        // Apply custom date range
        function applyCustomDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date');
                return;
            }
            
            currentAnalyticsPeriod = 'custom';
            generateAnalyticsData();
            addAnalyticsActivityItem(`<i class="fas fa-calendar text-blue-600"></i> Custom range: ${startDate} to ${endDate}`);
        }

        // ============================================
        // END ANALYTICS DASHBOARD FUNCTIONS
        // ============================================

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // ============================================
        // INVENTORY MANAGEMENT FUNCTIONS
        // ============================================
        
        let inventoryData = [];
        const INVENTORY_API_URL = '../../php/api/inventory.php';

        // Load inventory on page load
        async function loadInventory() {
            try {
                const response = await fetch(INVENTORY_API_URL);
                const result = await response.json();
                
                if (result.success) {
                    inventoryData = result.data.items;
                    renderInventory();
                    updateInventoryStats();
                } else {
                    console.error('Failed to load inventory:', result.message);
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        function renderInventory(items = inventoryData) {
            const tbody = document.getElementById('inventoryTableBody');
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-2"></i>
                            <p>No items found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const stockBadge = getInventoryStockBadge(item.stock_quantity, item.low_stock_threshold);
                const availableBadge = item.is_available == 1 
                    ? '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold"> Available</span>'
                    : '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold"> Unavailable</span>';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-800">${item.item_name}</div>
                            ${item.description ? `<div class="text-sm text-gray-500">${item.description}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="font-bold text-lg">${item.stock_quantity}</div>
                        </td>
                        <td class="px-6 py-4 text-center text-gray-600">${item.low_stock_threshold}</td>
                        <td class="px-6 py-4 text-center text-gray-600">${item.estimated_time}</td>
                        <td class="px-6 py-4 text-center">${stockBadge}</td>
                        <td class="px-6 py-4 text-center">${availableBadge}</td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center gap-2">
                                <button onclick="showEditItemModal(${item.item_id})" 
                                        class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm"
                                        title="Edit Item">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="showStockModal(${item.item_id})" 
                                        class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm"
                                        title="Adjust Stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button onclick="toggleItemAvailability(${item.item_id}, ${item.is_available})" 
                                        class="px-3 py-1 ${item.is_available == 1 ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded text-sm"
                                        title="${item.is_available == 1 ? 'Mark Out of Stock' : 'Mark Available'}">
                                    <i class="fas fa-${item.is_available == 1 ? 'ban' : 'check'}"></i>
                                </button>
                                <button onclick="deleteInventoryItem(${item.item_id}, '${item.item_name}')" 
                                        class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm"
                                        title="Delete Item">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getInventoryStockBadge(quantity, threshold) {
            if (quantity === 0) {
                return '<span class="stock-badge stock-out">Out of Stock</span>';
            } else if (quantity <= threshold) {
                return `<span class="stock-badge stock-low">Low Stock</span>`;
            } else {
                return '<span class="stock-badge stock-in">In Stock</span>';
            }
        }

        function updateInventoryStats() {
            const total = inventoryData.length;
            const inStock = inventoryData.filter(i => i.stock_quantity > i.low_stock_threshold).length;
            const lowStock = inventoryData.filter(i => i.stock_quantity > 0 && i.stock_quantity <= i.low_stock_threshold).length;
            const outOfStock = inventoryData.filter(i => i.stock_quantity === 0).length;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('inStockCount').textContent = inStock;
            document.getElementById('lowStockCount').textContent = lowStock;
            document.getElementById('outOfStockCount').textContent = outOfStock;
        }

        function filterInventoryItems() {
            const search = document.getElementById('inventorySearchInput').value.toLowerCase();
            const filtered = inventoryData.filter(item => 
                item.item_name.toLowerCase().includes(search) ||
                (item.description && item.description.toLowerCase().includes(search))
            );
            renderInventory(filtered);
        }

        // Modal Functions
        function showAddItemModal() {
            document.getElementById('modalTitle').textContent = 'Add New Item';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('isActive').checked = true;
            document.getElementById('itemModal').classList.add('active');
            document.getElementById('itemModal').style.display = 'flex';
        }

        function showEditItemModal(itemId) {
            const item = inventoryData.find(i => i.item_id === itemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Edit Item';
            document.getElementById('itemId').value = item.item_id;
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('stockQuantity').value = item.stock_quantity;
            document.getElementById('lowStockThreshold').value = item.low_stock_threshold;
            document.getElementById('estimatedTime').value = item.estimated_time;
            document.getElementById('isActive').checked = item.is_active == 1;
            document.getElementById('itemModal').classList.add('active');
            document.getElementById('itemModal').style.display = 'flex';
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemModal').style.display = 'none';
        }

        function showStockModal(itemId) {
            const item = inventoryData.find(i => i.item_id === itemId);
            if (!item) return;

            document.getElementById('stockItemId').value = item.item_id;
            document.getElementById('stockItemName').textContent = item.item_name;
            document.getElementById('currentStock').textContent = item.stock_quantity;
            document.getElementById('newStockQuantity').value = item.stock_quantity;
            document.getElementById('stockReason').value = '';
            document.getElementById('stockModal').classList.add('active');
            document.getElementById('stockModal').style.display = 'flex';
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
            document.getElementById('stockModal').style.display = 'none';
        }

        // CRUD Operations
        async function saveInventoryItem(event) {
            event.preventDefault();
            
            const itemId = document.getElementById('itemId').value;
            const data = {
                item_name: document.getElementById('itemName').value,
                description: document.getElementById('itemDescription').value,
                stock_quantity: parseInt(document.getElementById('stockQuantity').value),
                low_stock_threshold: parseInt(document.getElementById('lowStockThreshold').value),
                estimated_time: parseInt(document.getElementById('estimatedTime').value),
                is_active: document.getElementById('isActive').checked ? 1 : 0
            };

            try {
                const method = itemId ? 'PUT' : 'POST';
                if (itemId) data.item_id = parseInt(itemId);

                const response = await fetch(INVENTORY_API_URL, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(itemId ? 'Item updated successfully' : 'Item added successfully', 'success');
                    closeItemModal();
                    loadInventory();
                } else {
                    showNotification(result.message || 'Failed to save item', 'error');
                }
            } catch (error) {
                console.error('Error saving item:', error);
                showNotification('Error saving item. Please try again.', 'error');
            }
        }

        async function adjustInventoryStock(event) {
            event.preventDefault();
            
            const itemId = parseInt(document.getElementById('stockItemId').value);
            const newQuantity = parseInt(document.getElementById('newStockQuantity').value);
            const reason = document.getElementById('stockReason').value;

            try {
                const response = await fetch(INVENTORY_API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: itemId,
                        stock_quantity: newQuantity,
                        stock_reason: reason || 'Manual stock adjustment'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Stock updated successfully', 'success');
                    closeStockModal();
                    loadInventory();
                } else {
                    showNotification(result.message || 'Failed to update stock', 'error');
                }
            } catch (error) {
                console.error('Error updating stock:', error);
                showNotification('Error updating stock. Please try again.', 'error');
            }
        }

        async function toggleItemAvailability(itemId, currentStatus) {
            const newStatus = currentStatus == 1 ? 0 : 1;
            const action = newStatus == 1 ? 'available' : 'out of stock';
            
            const confirmed = await showConfirm(`Mark this item as ${action}?`);
            if (!confirmed) return;

            try {
                const response = await fetch(INVENTORY_API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: itemId,
                        is_available: newStatus
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`Item marked as ${action}`, 'success');
                    loadInventory();
                } else {
                    showNotification(result.message || 'Failed to update availability', 'error');
                }
            } catch (error) {
                console.error('Error updating availability:', error);
                showNotification('Error updating availability. Please try again.', 'error');
            }
        }

        async function deleteInventoryItem(itemId, itemName) {
            const confirmed = await showConfirm(
                `Are you sure you want to delete "${itemName}"?\n\nThis action cannot be undone.`,
                { danger: true, confirmText: 'Delete', cancelText: 'Cancel' }
            );
            if (!confirmed) return;

            try {
                const response = await fetch(INVENTORY_API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Item deleted successfully', 'success');
                    loadInventory();
                } else {
                    showNotification(result.message || 'Failed to delete item', 'error');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                showNotification('Error deleting item. Please try again.', 'error');
            }
        }

        // ============================================
        // END INVENTORY MANAGEMENT FUNCTIONS
        // ============================================

        // ============================================
        // ARCHIVE AND RESTORE FUNCTIONS
        // ============================================

        /**
         * Toggle between active and archived students view
         */
        async function toggleArchivedStudentsView() {
            showingArchivedStudents = !showingArchivedStudents;
            const viewArchivedBtn = document.getElementById('viewArchivedStudentsBtnMenu');
            const archiveBtn = document.getElementById('archiveStudentsBtnMenu');
            const title = document.getElementById('studentsTableTitle');
            
            if (showingArchivedStudents) {
                // Viewing archived students
                if (viewArchivedBtn) {
                    viewArchivedBtn.innerHTML = '<i class="fas fa-eye text-green-600 w-5"></i><span class="font-semibold text-gray-700">View Active</span>';
                }
                if (archiveBtn) {
                    archiveBtn.innerHTML = '<i class="fas fa-undo text-green-600 w-5"></i><span class="font-semibold text-gray-700">Restore Students</span>';
                }
                title.textContent = 'Archived Students';
            } else {
                // Viewing active students
                if (viewArchivedBtn) {
                    viewArchivedBtn.innerHTML = '<i class="fas fa-folder-open text-gray-600 w-5"></i><span class="font-semibold text-gray-700">View Archived</span>';
                }
                if (archiveBtn) {
                    archiveBtn.innerHTML = '<i class="fas fa-archive text-blue-900 w-5"></i><span class="font-semibold text-gray-700">Archive Students</span>';
                }
                title.textContent = 'Active Students';
            }
            
            await fetchStudents();
        }

        /**
         * Archive a student record
         */
        async function archiveStudent(studentId, studentName) {
            const confirmed = await showConfirm(
                `Archive student record: ${studentName}?\n\nThis will hide the student from the active list.`
            );
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'archive',
                        student_id: studentId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Student archived successfully', 'success');
                    await fetchStudents();
                } else {
                    await showAlert(result.message || 'Failed to archive student', 'error');
                }
            } catch (error) {
                console.error('Error archiving student:', error);
                await showAlert('Error archiving student', 'error');
            }
        }

        /**
         * Restore an archived student (Super Admin only)
         */
        async function restoreStudent(studentId, studentName) {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin != 1) {
                await showAlert('Only super admin can restore archived students', 'error');
                return;
            }
            
            const confirmed = await showConfirm(`Restore student record: ${studentName}?`);
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'restore',
                        student_id: studentId
                    })
                });
                
                const result = await response.json();
                
                console.log('Restore response:', result); // Debug log
                
                if (result.success) {
                    showNotification('Student restored successfully', 'success');
                    await fetchStudents();
                } else {
                    console.error('Restore failed:', result);
                    await showAlert(result.message || 'Failed to restore student', 'error');
                }
            } catch (error) {
                console.error('Error restoring student:', error);
                await showAlert('Error restoring student: ' + error.message, 'error');
            }
        }

        /**
         * Archive student from details modal
         */
        async function archiveStudentFromModal(studentId, studentName) {
            closeStudentModal();
            await archiveStudent(studentId, studentName);
        }

        /**
         * Restore student from details modal
         */
        async function restoreStudentFromModal(studentId, studentName) {
            closeStudentModal();
            await restoreStudent(studentId, studentName);
        }

        /**
         * Archive all visible students
         */
        async function archiveAllStudents() {
            const visibleStudents = showingArchivedStudents ? [] : studentsData.filter(s => !s.is_archived);
            
            if (visibleStudents.length === 0) {
                showNotification('No active students to archive', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Archive all ${visibleStudents.length} students?`);
            if (!confirmed) {
                return;
            }
            
            let successCount = 0;
            for (const student of visibleStudents) {
                try {
                    const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'archive',
                            student_id: student.student_id
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) successCount++;
                } catch (error) {
                    console.error('Error archiving student:', error);
                }
            }
            
            showNotification(`${successCount} of ${visibleStudents.length} students archived successfully`, 'success');
            exitStudentArchiveMode();
            await fetchStudents();
        }

        /**
         * Archive selected students
         */
        async function archiveSelectedStudents() {
            if (selectedStudentIds.length === 0) {
                showNotification('Please select students to archive', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Archive ${selectedStudentIds.length} selected students?`);
            if (!confirmed) {
                return;
            }
            
            let successCount = 0;
            for (const studentId of selectedStudentIds) {
                try {
                    const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'archive',
                            student_id: studentId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) successCount++;
                } catch (error) {
                    console.error('Error archiving student:', error);
                }
            }
            
            showNotification(`${successCount} of ${selectedStudentIds.length} students archived successfully`, 'success');
            exitStudentArchiveMode();
            await fetchStudents();
        }

        /**
         * Restore all visible archived students
         */
        async function restoreAllStudents() {
            const archivedStudents = showingArchivedStudents ? studentsData.filter(s => s.is_archived) : [];
            
            if (archivedStudents.length === 0) {
                showNotification('No archived students to restore', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Restore all ${archivedStudents.length} archived students?`);
            if (!confirmed) {
                return;
            }
            
            let successCount = 0;
            let errors = [];
            for (const student of archivedStudents) {
                try {
                    const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'restore',
                            student_id: student.student_id
                        })
                    });
                    
                    const result = await response.json();
                    console.log(`Restore ${student.first_name} ${student.last_name}:`, result); // Debug
                    if (result.success) {
                        successCount++;
                    } else {
                        errors.push(`${student.first_name} ${student.last_name}: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error restoring student:', student.student_id, error);
                    errors.push(`${student.first_name} ${student.last_name}: ${error.message}`);
                }
            }
            
            if (errors.length > 0) {
                console.error('Restore errors:', errors);
            }
            
            showNotification(`${successCount} of ${archivedStudents.length} students restored successfully`, successCount > 0 ? 'success' : 'error');
            exitStudentArchiveMode();
            await fetchStudents();
        }

        /**
         * Restore selected students
         */
        async function restoreSelectedStudents() {
            if (selectedStudentIds.length === 0) {
                showNotification('Please select students to restore', 'warning');
                return;
            }
            
            const confirmed = await showConfirm(`Restore ${selectedStudentIds.length} selected students?`);
            if (!confirmed) {
                return;
            }
            
            let successCount = 0;
            let errors = [];
            for (const studentId of selectedStudentIds) {
                try {
                    const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                        method: 'PUT',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'restore',
                            student_id: studentId
                        })
                    });
                    
                    const result = await response.json();
                    console.log(`Restore student ${studentId}:`, result); // Debug
                    if (result.success) {
                        successCount++;
                    } else {
                        errors.push(`${studentId}: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Error restoring student:', studentId, error);
                    errors.push(`${studentId}: ${error.message}`);
                }
            }
            
            if (errors.length > 0) {
                console.error('Restore errors:', errors);
            }
            
            showNotification(`${successCount} of ${selectedStudentIds.length} students restored successfully`, successCount > 0 ? 'success' : 'error');
            exitStudentArchiveMode();
            await fetchStudents();
        }

        /**
         * Toggle between active and archived admins view
         */
        async function toggleArchivedAdminsView() {
            showingArchivedAdmins = !showingArchivedAdmins;
            const btn = document.getElementById('viewArchivedAdminsBtn');
            const title = document.getElementById('adminAccountsTableTitle');
            
            if (showingArchivedAdmins) {
                btn.innerHTML = '<i class="fas fa-eye mr-2"></i>View Active';
                btn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold whitespace-nowrap';
                title.textContent = 'Archived Admin Accounts';
            } else {
                btn.innerHTML = '<i class="fas fa-archive mr-2"></i>View Archived';
                btn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold whitespace-nowrap';
                title.textContent = 'Admin Accounts';
            }
            
            await fetchAdminAccounts();
        }

        /**
         * Archive an admin account (Super Admin only)
         */
        async function archiveAdmin(adminId, fullName) {
            const confirmed = await showConfirm(
                `Archive admin account: ${fullName}?\n\nThis will prevent them from logging in.`
            );
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'archive',
                        admin_id: adminId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Admin account archived successfully', 'success');
                    await fetchAdminAccounts();
                } else {
                    await showAlert(result.message || 'Failed to archive admin', 'error');
                }
            } catch (error) {
                console.error('Error archiving admin:', error);
                await showAlert('Error archiving admin', 'error');
            }
        }

        /**
         * Restore an archived admin (Super Admin only)
         */
        async function restoreAdmin(adminId, fullName) {
            const confirmed = await showConfirm(`Restore admin account: ${fullName}?`);
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'restore',
                        admin_id: adminId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Admin account restored successfully', 'success');
                    await fetchAdminAccounts();
                } else {
                    await showAlert(result.message || 'Failed to restore admin', 'error');
                }
            } catch (error) {
                console.error('Error restoring admin:', error);
                await showAlert('Error restoring admin', 'error');
            }
        }

        /**
         * Permanently delete an archived admin (Super Admin only)
         */
        async function permanentDeleteAdmin(adminId, fullName) {
            const confirmed1 = await showConfirm(
                `PERMANENTLY DELETE admin account: ${fullName}?\n\nThis action CANNOT be undone!`,
                { danger: true, confirmText: 'Delete', cancelText: 'Cancel' }
            );
            if (!confirmed1) {
                return;
            }
            
            const confirmed2 = await showConfirm(
                'Are you absolutely sure?\n\nThis will permanently remove this account from the database.',
                { danger: true, confirmText: 'Yes, Delete Forever', cancelText: 'Cancel' }
            );
            if (!confirmed2) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'permanent_delete',
                        admin_id: adminId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Admin account permanently deleted', 'success');
                    await fetchAdminAccounts();
                } else {
                    await showAlert(result.message || 'Failed to delete admin', 'error');
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                await showAlert('Error deleting admin', 'error');
            }
        }

        // ============================================
        // END ARCHIVE AND RESTORE FUNCTIONS
        // ============================================

        // ============================================
        // ADMIN MANAGEMENT TAB FUNCTIONS
        // ============================================

        /**
         * Switch between Admin Accounts and Activity Logs sub-tabs
         */
        function switchAdminTab(tabName) {
            // Update button styles
            const accountsBtn = document.getElementById('admin-subtab-accounts');
            const logsBtn = document.getElementById('admin-subtab-logs');
            const accountsContent = document.getElementById('admin-content-accounts');
            const logsContent = document.getElementById('admin-content-logs');
            
            if (tabName === 'accounts') {
                accountsBtn.className = 'flex-1 px-6 py-4 font-bold text-blue-900 border-b-4 border-blue-500 bg-blue-50';
                logsBtn.className = 'flex-1 px-6 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-50';
                accountsContent.classList.remove('hidden');
                logsContent.classList.add('hidden');
                fetchAdminAccounts();
            } else {
                accountsBtn.className = 'flex-1 px-6 py-4 font-bold text-gray-600 border-b-4 border-transparent hover:bg-gray-50';
                logsBtn.className = 'flex-1 px-6 py-4 font-bold text-blue-900 border-b-4 border-blue-500 bg-blue-50';
                accountsContent.classList.add('hidden');
                logsContent.classList.remove('hidden');
                fetchAdminLogs();
            }
        }

        /**
         * Filter admin accounts based on search
         */
        function filterAdmins() {
            const searchTerm = document.getElementById('searchAdmins')?.value.toLowerCase() || '';
            const rows = document.querySelectorAll('#adminAccountsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        /**
         * Fetch and display admin logs
         */
        async function fetchAdminLogs() {
            try {
                const adminFilter = document.getElementById('filterLogAdmin')?.value || 'all';
                const actionFilter = document.getElementById('filterLogAction')?.value || 'all';
                const dateFilter = document.getElementById('filterLogDate')?.value || '';
                const searchTerm = document.getElementById('searchLogs')?.value || '';
                
                let url = `${API_BASE}/admin/admin_logs.php?`;
                if (adminFilter !== 'all') url += `admin_id=${adminFilter}&`;
                if (actionFilter !== 'all') url += `action_type=${actionFilter}&`;
                if (dateFilter) url += `start_date=${dateFilter}&`;
                if (searchTerm) url += `search=${searchTerm}&`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayAdminLogs(result.data.logs || []);
                    populateAdminFilter(result.data.admins || []);
                    updateLogsStats(result.data.stats || {});
                } else {
                    console.error('Failed to fetch admin logs:', result.message);
                    displayAdminLogs([]);
                }
            } catch (error) {
                console.error('Error fetching admin logs:', error);
                const tbody = document.getElementById('adminLogsTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-red-500">Error loading logs. Please try again.</td></tr>';
            }
        }

        /**
         * Display logs in table
         */
        function displayAdminLogs(logs) {
            const tbody = document.getElementById('adminLogsTableBody');
            tbody.innerHTML = '';
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-inbox text-5xl mb-3 text-gray-300"></i>
                            <p class="text-lg font-semibold">No activity logs found</p>
                            <p class="text-sm">Try adjusting your filters or check back later</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-colors';
                
                const time = new Date(log.created_at).toLocaleString('en-US', {
                    month: 'short', 
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
                
                const actionBadge = getActionBadge(log.action_type);
                
                row.innerHTML = `
                    <td class="px-6 py-4 admin-log-checkbox-column hidden">
                        <input type="checkbox" class="admin-log-checkbox w-4 h-4" data-log-id="${log.log_id}" onchange="handleAdminLogCheckbox()">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        <i class="fas fa-clock text-blue-500 mr-1"></i>${time}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-2">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                            <span class="font-semibold">${log.admin_name || 'Unknown'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">${actionBadge}</td>
                    <td class="px-6 py-4 text-sm">${log.description || 'No description'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        <i class="fas fa-network-wired text-gray-400 mr-1"></i>${log.ip_address || 'N/A'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Get action badge with appropriate color
         */
        function getActionBadge(actionType) {
            const badges = {
                'admin_login': { color: 'bg-green-100 text-green-800 border-green-300', icon: 'sign-in-alt', label: 'Login' },
                'admin_logout': { color: 'bg-gray-100 text-gray-800 border-gray-300', icon: 'sign-out-alt', label: 'Logout' },
                'admin_create': { color: 'bg-blue-100 text-blue-800 border-blue-300', icon: 'user-plus', label: 'Admin Created' },
                'admin_update': { color: 'bg-indigo-100 text-indigo-800 border-indigo-300', icon: 'user-edit', label: 'Admin Updated' },
                'admin_archive': { color: 'bg-orange-100 text-orange-800 border-orange-300', icon: 'archive', label: 'Admin Archived' },
                'admin_restore': { color: 'bg-cyan-100 text-cyan-800 border-cyan-300', icon: 'undo', label: 'Admin Restored' },
                'admin_delete': { color: 'bg-red-100 text-red-800 border-red-300', icon: 'trash', label: 'Admin Deleted' },
                'student_create': { color: 'bg-green-100 text-green-800 border-green-300', icon: 'user-graduate', label: 'Student Created' },
                'student_update': { color: 'bg-indigo-100 text-indigo-800 border-indigo-300', icon: 'edit', label: 'Student Updated' },
                'student_archive': { color: 'bg-orange-100 text-orange-800 border-orange-300', icon: 'archive', label: 'Student Archived' },
                'student_restore': { color: 'bg-cyan-100 text-cyan-800 border-cyan-300', icon: 'undo', label: 'Student Restored' },
                'order_status_update': { color: 'bg-purple-100 text-purple-800 border-purple-300', icon: 'exchange-alt', label: 'Order Updated' },
                'email_archive': { color: 'bg-orange-100 text-orange-800 border-orange-300', icon: 'envelope-open', label: 'Email Archived' },
                'email_restore': { color: 'bg-cyan-100 text-cyan-800 border-cyan-300', icon: 'envelope', label: 'Email Restored' },
                'email_delete': { color: 'bg-red-100 text-red-800 border-red-300', icon: 'trash-alt', label: 'Email Deleted' },
                'inventory_create': { color: 'bg-green-100 text-green-800 border-green-300', icon: 'box', label: 'Item Created' },
                'inventory_update': { color: 'bg-indigo-100 text-indigo-800 border-indigo-300', icon: 'boxes', label: 'Inventory Updated' },
                'inventory_delete': { color: 'bg-red-100 text-red-800 border-red-300', icon: 'box-open', label: 'Item Deleted' },
                'settings_update': { color: 'bg-yellow-100 text-yellow-800 border-yellow-300', icon: 'cog', label: 'Settings Changed' }
            };
            
            const badge = badges[actionType] || { 
                color: 'bg-gray-100 text-gray-800 border-gray-300', 
                icon: 'circle', 
                label: actionType ? actionType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown'
            };
            
            return `<span class="${badge.color} px-3 py-1 rounded-full text-xs font-bold border">
                        <i class="fas fa-${badge.icon} mr-1"></i>${badge.label}
                    </span>`;
        }

        /**
         * Populate admin filter dropdown
         */
        function populateAdminFilter(admins) {
            const select = document.getElementById('filterLogAdmin');
            if (!select || !admins) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="all">All Admins</option>';
            
            admins.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.admin_id;
                option.textContent = admin.full_name;
                select.appendChild(option);
            });
            
            select.value = currentValue;
        }

        /**
         * Update logs statistics
         */
        function updateLogsStats(stats) {
            document.getElementById('totalLogsCount').textContent = stats.total_logs || 0;
            document.getElementById('todayLogsCount').textContent = stats.today_logs || 0;
            document.getElementById('activeAdminsLogsCount').textContent = stats.active_admins || 0;
            document.getElementById('actionTypesCount').textContent = stats.action_types || 0;
        }

        /**
         * Reset log filters
         */
        function resetLogFilters() {
            document.getElementById('filterLogAdmin').value = 'all';
            document.getElementById('filterLogAction').value = 'all';
            document.getElementById('filterLogDate').value = '';
            document.getElementById('searchLogs').value = '';
            fetchAdminLogs();
        }

        /**
         * Export logs to CSV
         */
        async function exportLogsToCSV() {
            try {
                const adminFilter = document.getElementById('filterLogAdmin')?.value || 'all';
                const actionFilter = document.getElementById('filterLogAction')?.value || 'all';
                const dateFilter = document.getElementById('filterLogDate')?.value || '';
                const searchTerm = document.getElementById('searchLogs')?.value || '';
                
                let url = `${API_BASE}/admin/admin_logs.php?`;
                if (adminFilter !== 'all') url += `admin_id=${adminFilter}&`;
                if (actionFilter !== 'all') url += `action_type=${actionFilter}&`;
                if (dateFilter) url += `start_date=${dateFilter}&`;
                if (searchTerm) url += `search=${searchTerm}&`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success && result.data && result.data.logs) {
                    const logs = result.data.logs;
                    
                    // Create CSV content
                    const headers = ['Time', 'Admin', 'Action Type', 'Description', 'IP Address'];
                    const csvRows = [headers.join(',')];
                    
                    logs.forEach(log => {
                        const time = new Date(log.created_at).toLocaleString();
                        const row = [
                            `"${time}"`,
                            `"${log.admin_name || 'Unknown'}"`,
                            `"${log.action_type}"`,
                            `"${(log.description || '').replace(/"/g, '""')}"`,
                            `"${log.ip_address || 'N/A'}"`
                        ];
                        csvRows.push(row.join(','));
                    });
                    
                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `admin_logs_${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Logs exported successfully', 'success');
                } else {
                    alert('No logs to export');
                }
            } catch (error) {
                console.error('Error exporting logs:', error);
                alert('Error exporting logs');
            }
        }



        /**
         * Export email logs to Excel
         */
        async function exportEmailLogsToExcel() {
            try {
                const type = document.getElementById('filterEmailType')?.value || 'all';
                const status = document.getElementById('filterEmailStatus')?.value || 'all';
                const search = document.getElementById('searchEmail')?.value || '';
                const isArchived = showingArchivedLogs ? 1 : 0;
                
                let url = `${API_BASE}/admin/export_email_logs.php?`;
                if (type !== 'all') url += `type=${type}&`;
                if (status !== 'all') url += `status=${status}&`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                url += `is_archived=${isArchived}`;
                
                // Open in new window to trigger download
                window.open(url, '_blank');
                
                showNotification('Email logs export started', 'success');
            } catch (error) {
                console.error('Error exporting email logs:', error);
                alert('Error exporting email logs');
            }
        }



        // ============================================
        // STUDENT SELECTION AND EXPORT FUNCTIONS
        // ============================================
        
        let selectedStudentIds = [];

        /**
         * Toggle select all students
         */
        function toggleSelectAllStudents() {
            const selectAll = document.getElementById('selectAllStudents').checked;
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
            handleStudentCheckbox();
        }

        /**
         * Handle student checkbox change
         */
        function handleStudentCheckbox() {
            selectedStudentIds = [];
            document.querySelectorAll('.student-checkbox:checked').forEach(cb => {
                selectedStudentIds.push(cb.dataset.studentId);
            });
            updateSelectedStudentCount();
        }

        /**
         * Update selected student count display
         */
        function updateSelectedStudentCount() {
            const count = selectedStudentIds.length;
            const countEl = document.getElementById('selectedStudentCount');
            if (countEl) countEl.textContent = count;
            
            // Also update archive counts
            const archiveCountEl = document.getElementById('selectedStudentArchiveCount');
            if (archiveCountEl) archiveCountEl.textContent = count;
            
            const restoreCountEl = document.getElementById('selectedStudentRestoreCount');
            if (restoreCountEl) restoreCountEl.textContent = count;
        }

        /**
         * Enter student export mode - show checkboxes and action buttons
         */
        function enterStudentExportMode() {
            // Show checkbox column
            document.querySelectorAll('.student-checkbox-column').forEach(el => {
                el.classList.remove('hidden');
            });
            
            // Show action buttons, hide kebab menu
            document.getElementById('studentActions').classList.remove('hidden');
            document.getElementById('studentKebabMenu').classList.add('hidden');
            
            // Reset selection
            selectedStudentIds = [];
            document.getElementById('selectAllStudents').checked = false;
            updateSelectedStudentCount();
        }

        /**
         * Exit student export mode - hide checkboxes and action buttons
         */
        function exitStudentExportMode() {
            // Hide checkbox column
            document.querySelectorAll('.student-checkbox-column').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Hide action buttons, show kebab menu
            document.getElementById('studentActions').classList.add('hidden');
            document.getElementById('studentKebabMenu').classList.remove('hidden');
            
            // Reset selection
            selectedStudentIds = [];
            document.getElementById('selectAllStudents').checked = false;
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
            updateSelectedStudentCount();
        }

        /**
         * Enter student archive mode - show checkboxes and archive action buttons
         */
        function enterStudentArchiveMode() {
            // Show checkbox column
            document.querySelectorAll('.student-checkbox-column').forEach(el => {
                el.classList.remove('hidden');
            });
            
            // Show archive action buttons, hide kebab menu
            document.getElementById('studentArchiveActions').classList.remove('hidden');
            document.getElementById('studentKebabMenu').classList.add('hidden');
            
            // Show/hide buttons based on current view
            if (showingArchivedStudents) {
                // Hide archive buttons, show restore buttons
                document.querySelector('#studentArchiveActions button[onclick="archiveAllStudents()"]').classList.add('hidden');
                document.querySelector('#studentArchiveActions button[onclick="archiveSelectedStudents()"]').classList.add('hidden');
                document.getElementById('restoreAllStudentsBtn').classList.remove('hidden');
                document.getElementById('restoreSelectedStudentsBtn').classList.remove('hidden');
            } else {
                // Show archive buttons, hide restore buttons
                document.querySelector('#studentArchiveActions button[onclick="archiveAllStudents()"]').classList.remove('hidden');
                document.querySelector('#studentArchiveActions button[onclick="archiveSelectedStudents()"]').classList.remove('hidden');
                document.getElementById('restoreAllStudentsBtn').classList.add('hidden');
                document.getElementById('restoreSelectedStudentsBtn').classList.add('hidden');
            }
            
            // Reset selection
            selectedStudentIds = [];
            document.getElementById('selectAllStudents').checked = false;
            updateSelectedStudentCount();
        }

        /**
         * Exit student archive mode - hide checkboxes and archive action buttons
         */
        function exitStudentArchiveMode() {
            // Hide checkbox column
            document.querySelectorAll('.student-checkbox-column').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Hide archive action buttons, show kebab menu
            document.getElementById('studentArchiveActions').classList.add('hidden');
            document.getElementById('studentKebabMenu').classList.remove('hidden');
            
            // Reset selection
            selectedStudentIds = [];
            document.getElementById('selectAllStudents').checked = false;
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = false);
            updateSelectedStudentCount();
        }

        /**
         * Toggle student kebab menu
         */
        function toggleStudentMenu() {
            const dropdown = document.getElementById('studentMenuDropdown');
            dropdown.classList.toggle('hidden');
        }

        /**
         * Toggle email kebab menu
         */
        function toggleEmailMenu() {
            const dropdown = document.getElementById('emailMenuDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(event) {
            const studentMenu = document.getElementById('studentKebabMenu');
            const emailMenu = document.getElementById('emailKebabMenu');
            
            if (studentMenu && !studentMenu.contains(event.target)) {
                document.getElementById('studentMenuDropdown')?.classList.add('hidden');
            }
            
            if (emailMenu && !emailMenu.contains(event.target)) {
                document.getElementById('emailMenuDropdown')?.classList.add('hidden');
            }
        });

        /**
         * Export all students (no selection needed)
         */
        async function exportAllStudents() {
            try {
                const searchTerm = document.getElementById('searchStudent')?.value || '';
                const archived = showingArchivedStudents ? 'true' : 'false';
                
                let url = `${API_BASE}/admin/export_students.php?archived=${archived}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                
                window.open(url, '_blank');
                showNotification('Exporting all students...', 'success');
                
                // Exit export mode after initiating export
                setTimeout(() => exitStudentExportMode(), 500);
            } catch (error) {
                console.error('Error exporting students:', error);
                alert('Error exporting students');
            }
        }

        /**
         * Export selected students
         */
        async function exportSelectedStudents() {
            if (selectedStudentIds.length === 0) {
                alert('Please select students to export');
                return;
            }

            try {
                // Create a form to POST the selected IDs
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${API_BASE}/admin/export_students.php`;
                form.target = '_blank';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'student_ids';
                input.value = JSON.stringify(selectedStudentIds);
                form.appendChild(input);

                const archivedInput = document.createElement('input');
                archivedInput.type = 'hidden';
                archivedInput.name = 'archived';
                archivedInput.value = showingArchivedStudents ? 'true' : 'false';
                form.appendChild(archivedInput);

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);

                showNotification(`Exporting ${selectedStudentIds.length} student(s)...`, 'success');
                
                // Exit export mode after initiating export
                setTimeout(() => exitStudentExportMode(), 500);
            } catch (error) {
                console.error('Error exporting selected students:', error);
                alert('Error exporting selected students');
            }
        }

        // ============================================
        // ADMIN LOG SELECTION AND EXPORT FUNCTIONS
        // ============================================
        
        let selectedAdminLogIds = [];

        /**
         * Toggle select all admin logs
         */
        function toggleSelectAllAdminLogs() {
            const selectAll = document.getElementById('selectAllAdminLogs').checked;
            document.querySelectorAll('.admin-log-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
            handleAdminLogCheckbox();
        }

        /**
         * Handle admin log checkbox change
         */
        function handleAdminLogCheckbox() {
            selectedAdminLogIds = [];
            document.querySelectorAll('.admin-log-checkbox:checked').forEach(cb => {
                selectedAdminLogIds.push(cb.dataset.logId);
            });
            updateSelectedAdminLogCount();
        }

        /**
         * Update selected admin log count display
         */
        function updateSelectedAdminLogCount() {
            const count = selectedAdminLogIds.length;
            const countEl = document.getElementById('selectedAdminLogCount');
            countEl.textContent = count;
        }

        /**
         * Enter admin log export mode - show checkboxes and action buttons
         */
        function enterAdminLogExportMode() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin != 1) {
                alert('Only super admins can export admin logs');
                return;
            }

            // Show checkbox column
            document.querySelectorAll('.admin-log-checkbox-column').forEach(el => {
                el.classList.remove('hidden');
            });
            
            // Show action buttons, hide start export button
            document.getElementById('adminLogActions').classList.remove('hidden');
            document.getElementById('startAdminLogExportBtn').classList.add('hidden');
            
            // Reset selection
            selectedAdminLogIds = [];
            document.getElementById('selectAllAdminLogs').checked = false;
            updateSelectedAdminLogCount();
        }

        /**
         * Exit admin log export mode - hide checkboxes and action buttons
         */
        function exitAdminLogExportMode() {
            // Hide checkbox column
            document.querySelectorAll('.admin-log-checkbox-column').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Hide action buttons, show start export button
            document.getElementById('adminLogActions').classList.add('hidden');
            document.getElementById('startAdminLogExportBtn').classList.remove('hidden');
            
            // Reset selection
            selectedAdminLogIds = [];
            document.getElementById('selectAllAdminLogs').checked = false;
            document.querySelectorAll('.admin-log-checkbox').forEach(cb => cb.checked = false);
            updateSelectedAdminLogCount();
        }

        /**
         * Export all admin logs (no selection needed)
         */
        async function exportAllAdminLogs() {
            try {
                const adminData = JSON.parse(sessionStorage.getItem('adminData'));
                if (!adminData || adminData.is_super_admin != 1) {
                    alert('Only super admins can export admin logs');
                    return;
                }
                
                const adminFilter = document.getElementById('filterLogAdmin')?.value || 'all';
                const actionFilter = document.getElementById('filterLogAction')?.value || 'all';
                const dateFilter = document.getElementById('filterLogDate')?.value || '';
                const searchTerm = document.getElementById('searchLogs')?.value || '';
                
                let url = `${API_BASE}/admin/export_admin_logs.php?`;
                if (adminFilter !== 'all') url += `admin_id=${adminFilter}&`;
                if (actionFilter !== 'all') url += `action_type=${actionFilter}&`;
                if (dateFilter) {
                    url += `start_date=${dateFilter}&`;
                    url += `end_date=${dateFilter}&`;
                }
                if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
                
                window.open(url, '_blank');
                showNotification('Exporting all admin logs...', 'success');
                
                // Exit export mode after initiating export
                setTimeout(() => exitAdminLogExportMode(), 500);
            } catch (error) {
                console.error('Error exporting admin logs:', error);
                alert('Error exporting admin logs');
            }
        }

        /**
         * Export selected admin logs
         */
        async function exportSelectedAdminLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.is_super_admin != 1) {
                alert('Only super admins can export admin logs');
                return;
            }

            if (selectedAdminLogIds.length === 0) {
                alert('Please select logs to export');
                return;
            }

            try {
                // Create a form to POST the selected IDs
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `${API_BASE}/admin/export_admin_logs.php`;
                form.target = '_blank';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'log_ids';
                input.value = JSON.stringify(selectedAdminLogIds);
                form.appendChild(input);

                document.body.appendChild(form);
                form.submit();
                document.body.removeChild(form);

                showNotification(`Exporting ${selectedAdminLogIds.length} log(s)...`, 'success');
                
                // Exit export mode after initiating export
                setTimeout(() => exitAdminLogExportMode(), 500);
            } catch (error) {
                console.error('Error exporting selected logs:', error);
                alert('Error exporting selected logs');
            }
        }

        /**
         * Update admin accounts stats
         */
        function updateAdminStats(admins) {
            if (!admins) return;
            
            const total = admins.length;
            const superAdmins = admins.filter(a => a.is_super_admin == 1).length;
            const archived = admins.filter(a => a.is_archived == 1).length;
            
            document.getElementById('totalAdminsCount').textContent = total;
            document.getElementById('superAdminsCount').textContent = superAdmins;
            document.getElementById('archivedAdminsCount').textContent = archived;
        }

        // ============================================
        // END ADMIN MANAGEMENT TAB FUNCTIONS
        // ============================================

        // ============================================
        // WORKING HOURS MANAGEMENT FUNCTIONS
        // ============================================
        
        async function loadWorkingHours() {
            try {
                const response = await fetch(`${API_BASE}/admin/get_working_hours.php`);
                const data = await response.json();
                
                if (data.success) {
                    displayWorkingHours(data.working_hours);
                    displaySpecialHours(data.special_hours);
                    loadSystemSettings(data.settings);
                }
            } catch (error) {
                console.error('Error loading working hours:', error);
            }
        }
        
        function loadSystemSettings(settings) {
            if (!settings) return;
            
            // Load order cutoff time
            if (settings.closing_warning_minutes) {
                const cutoffInput = document.getElementById('orderCutoffMinutes');
                if (cutoffInput) cutoffInput.value = settings.closing_warning_minutes;
            }
            
            // Load auto-move pending orders setting
            if (settings.auto_move_pending_to_next_day !== undefined) {
                const autoMoveInput = document.getElementById('autoMovePending');
                if (autoMoveInput) autoMoveInput.checked = settings.auto_move_pending_to_next_day === '1';
            }
            
            // Load average processing time
            if (settings.avg_processing_time) {
                const avgTimeInput = document.getElementById('avgProcessTime');
                if (avgTimeInput) avgTimeInput.value = settings.avg_processing_time;
            }
            
            // Load item complexity factor
            if (settings.item_complexity_factor) {
                const complexityInput = document.getElementById('itemComplexity');
                if (complexityInput) complexityInput.value = settings.item_complexity_factor;
            }
        }
        
        function displayWorkingHours(hours) {
            const container = document.getElementById('workingHoursForm');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            // Generate days HTML if not already done
            if (container.getAttribute('data-days-generated') === 'false') {
                let html = '';
                
                dayNames.forEach((dayName, index) => {
                    const dayNum = index + 1;
                    const isWeekend = dayNum >= 6;
                    const toggleColor = isWeekend ? 'gray' : 'purple';
                    
                    html += `
                    <div class="border border-gray-200 rounded-lg overflow-hidden" id="day-container-${dayNum}">
                        <div class="flex items-center justify-between p-4 bg-white">
                            <div class="flex items-center gap-3 flex-1">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="day${dayNum}" class="sr-only peer" onchange="toggleDay(${dayNum})">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-${toggleColor}-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-${toggleColor}-600"></div>
                                </label>
                                <div class="flex-1">
                                    <span class="text-sm font-medium text-gray-900">${dayName}</span>
                                    <div id="day-summary-${dayNum}" class="text-xs text-gray-500 mt-0.5"></div>
                                </div>
                            </div>
                            <button type="button" onclick="toggleDayExpand(${dayNum})" class="text-purple-600 hover:text-purple-700">
                                <svg id="expand-icon-${dayNum}" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="day-detail-${dayNum}" class="hidden border-t border-gray-200 p-4 bg-gray-50">
                            <div id="time-slots-${dayNum}" class="space-y-3"></div>
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                <button type="button" onclick="addTimeSlot(${dayNum})" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Time Slot
                                </button>
                                <button type="button" onclick="copyToAll(${dayNum})" class="text-purple-600 hover:text-purple-700 text-sm font-medium flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    Copy to All
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                });
                
                html += `
                    <div class="flex justify-end pt-4">
                        <button onclick="saveWorkingHours()" 
                                class="px-6 py-2 bg-gray-900 hover:bg-gray-800 text-white text-sm font-medium rounded-lg transition-colors">
                            Save Changes
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
                container.setAttribute('data-days-generated', 'true');
            }
            
            // Populate data for each day
            hours.forEach(dayData => {
                const dayNum = dayData.day_of_week;
                const isOpen = dayData.is_open == 1;
                
                // Set checkbox
                const checkbox = document.getElementById(`day${dayNum}`);
                if (checkbox) checkbox.checked = isOpen;
                
                // Create time slots
                const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
                if (slotsContainer) {
                    // Determine time slots based on break times
                    const slots = [];
                    
                    if (dayData.break_start && dayData.break_end) {
                        // Has lunch break - split into two slots
                        slots.push({
                            start: dayData.opening_time || '09:00',
                            end: dayData.break_start,
                            label: 'Morning'
                        });
                        slots.push({
                            start: dayData.break_end,
                            end: dayData.closing_time || '17:00',
                            label: 'Afternoon'
                        });
                    } else {
                        // No break - single slot
                        slots.push({
                            start: dayData.opening_time || '09:00',
                            end: dayData.closing_time || '17:00',
                            label: 'Operating Hours'
                        });
                    }
                    
                    // Render time slots
                    slotsContainer.innerHTML = slots.map((slot, idx) => `
                        <div class="flex items-center gap-2 time-slot-item" data-slot-index="${idx}">
                            <input type="time" value="${slot.start}" 
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   data-slot="start" data-day="${dayNum}" data-index="${idx}">
                            <span class="text-gray-500">to</span>
                            <input type="time" value="${slot.end}" 
                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                   data-slot="end" data-day="${dayNum}" data-index="${idx}">
                            ${slots.length > 1 ? `
                            <button type="button" onclick="removeTimeSlot(${dayNum}, ${idx})" 
                                    class="text-red-500 hover:text-red-700 p-2" title="Remove time slot">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                    `).join('');
                }
                
                updateDaySummary(dayNum);
            });
        }
        
        function toggleDayOpen(dayNum) {
            const checkbox = document.getElementById(`day${dayNum}`);
            const openTime = document.getElementById(`open${dayNum}`);
            const closeTime = document.getElementById(`close${dayNum}`);
            const breakStart = document.getElementById(`breakStart${dayNum}`);
            const breakEnd = document.getElementById(`breakEnd${dayNum}`);
            
            openTime.disabled = !checkbox.checked;
            closeTime.disabled = !checkbox.checked;
            breakStart.disabled = !checkbox.checked;
            breakEnd.disabled = !checkbox.checked;
        }
        
        function toggleDay(dayNum) {
            const checkbox = document.getElementById(`day${dayNum}`);
            const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
            
            if (!checkbox.checked && slotsContainer) {
                // Clear all time slots when unchecking
                const inputs = slotsContainer.querySelectorAll('input[type="time"]');
                inputs.forEach(input => input.value = '');
            }
            updateDaySummary(dayNum);
        }
        
        function toggleDayExpand(dayNum) {
            const detail = document.getElementById(`day-detail-${dayNum}`);
            const icon = document.getElementById(`expand-icon-${dayNum}`);
            
            if (detail.classList.contains('hidden')) {
                detail.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                detail.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function updateDaySummary(dayNum) {
            const checkbox = document.getElementById(`day${dayNum}`);
            const summary = document.getElementById(`day-summary-${dayNum}`);
            
            if (!summary) return;
            
            if (checkbox.checked) {
                const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
                if (slotsContainer) {
                    const slots = [];
                    const timeSlots = slotsContainer.querySelectorAll('.time-slot-item');
                    
                    timeSlots.forEach(slot => {
                        const startInput = slot.querySelector('[data-slot="start"]');
                        const endInput = slot.querySelector('[data-slot="end"]');
                        if (startInput && endInput && startInput.value && endInput.value) {
                            slots.push(`${startInput.value} - ${endInput.value}`);
                        }
                    });
                    
                    summary.textContent = slots.length > 0 ? slots.join('  ') : '';
                }
            } else {
                summary.textContent = '';
            }
        }
        
        function addTimeSlot(dayNum) {
            const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
            if (!slotsContainer) return;
            
            const currentSlots = slotsContainer.querySelectorAll('.time-slot-item');
            const slotIndex = currentSlots.length;
            
            // Get the last slot's end time as the new start time
            let lastEndTime = '13:00';
            if (currentSlots.length > 0) {
                const lastSlot = currentSlots[currentSlots.length - 1];
                const lastEndInput = lastSlot.querySelector('[data-slot="end"]');
                if (lastEndInput && lastEndInput.value) {
                    lastEndTime = lastEndInput.value;
                }
            }
            
            const newSlot = document.createElement('div');
            newSlot.className = 'flex items-center gap-2 time-slot-item';
            newSlot.setAttribute('data-slot-index', slotIndex);
            newSlot.innerHTML = `
                <input type="time" value="${lastEndTime}" 
                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       data-slot="start" data-day="${dayNum}" data-index="${slotIndex}" onchange="updateDaySummary(${dayNum})">
                <span class="text-gray-500">to</span>
                <input type="time" value="17:00" 
                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                       data-slot="end" data-day="${dayNum}" data-index="${slotIndex}" onchange="updateDaySummary(${dayNum})">
                <button type="button" onclick="removeTimeSlot(${dayNum}, ${slotIndex})" 
                        class="text-red-500 hover:text-red-700 p-2" title="Remove time slot">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            `;
            
            slotsContainer.appendChild(newSlot);
            updateDaySummary(dayNum);
        }
        
        function removeTimeSlot(dayNum, slotIndex) {
            const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
            if (!slotsContainer) return;
            
            const slots = slotsContainer.querySelectorAll('.time-slot-item');
            
            // Don't allow removing if only one slot remains
            if (slots.length <= 1) {
                alert('At least one time slot is required');
                return;
            }
            
            // Remove the specific slot
            slots.forEach(slot => {
                if (parseInt(slot.getAttribute('data-slot-index')) === slotIndex) {
                    slot.remove();
                }
            });
            
            // Reindex remaining slots
            const remainingSlots = slotsContainer.querySelectorAll('.time-slot-item');
            remainingSlots.forEach((slot, newIndex) => {
                slot.setAttribute('data-slot-index', newIndex);
                slot.querySelectorAll('[data-index]').forEach(input => {
                    input.setAttribute('data-index', newIndex);
                });
                
                // Update delete button
                const deleteBtn = slot.querySelector('button[onclick^="removeTimeSlot"]');
                if (deleteBtn) {
                    deleteBtn.setAttribute('onclick', `removeTimeSlot(${dayNum}, ${newIndex})`);
                }
            });
            
            updateDaySummary(dayNum);
        }
        
        function copyToAll(sourceDayNum) {
            const sourceSlotsContainer = document.getElementById(`time-slots-${sourceDayNum}`);
            if (!sourceSlotsContainer) return;
            
            const sourceSlots = sourceSlotsContainer.querySelectorAll('.time-slot-item');
            if (sourceSlots.length === 0) {
                alert('Please set time slots first');
                return;
            }
            
            // Collect source time slots
            const timeSlotsData = [];
            sourceSlots.forEach(slot => {
                const startInput = slot.querySelector('[data-slot="start"]');
                const endInput = slot.querySelector('[data-slot="end"]');
                if (startInput && endInput && startInput.value && endInput.value) {
                    timeSlotsData.push({
                        start: startInput.value,
                        end: endInput.value
                    });
                }
            });
            
            if (timeSlotsData.length === 0) {
                alert('Please set valid time slots first');
                return;
            }
            
            if (confirm('Copy these time slots to all other days?')) {
                for (let i = 1; i <= 7; i++) {
                    if (i !== sourceDayNum) {
                        // Enable the day
                        document.getElementById(`day${i}`).checked = true;
                        
                        // Get target slots container
                        const targetSlotsContainer = document.getElementById(`time-slots-${i}`);
                        if (!targetSlotsContainer) continue;
                        
                        // Clear existing slots
                        targetSlotsContainer.innerHTML = '';
                        
                        // Add copied slots
                        timeSlotsData.forEach((slotData, idx) => {
                            const newSlot = document.createElement('div');
                            newSlot.className = 'flex items-center gap-2 time-slot-item';
                            newSlot.setAttribute('data-slot-index', idx);
                            newSlot.innerHTML = `
                                <input type="time" value="${slotData.start}" 
                                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       data-slot="start" data-day="${i}" data-index="${idx}" onchange="updateDaySummary(${i})">
                                <span class="text-gray-500">to</span>
                                <input type="time" value="${slotData.end}" 
                                       class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                                       data-slot="end" data-day="${i}" data-index="${idx}" onchange="updateDaySummary(${i})">
                                ${timeSlotsData.length > 1 ? `
                                <button type="button" onclick="removeTimeSlot(${i}, ${idx})" 
                                        class="text-red-500 hover:text-red-700 p-2" title="Remove time slot">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                                ` : ''}
                            `;
                            targetSlotsContainer.appendChild(newSlot);
                        });
                        
                        updateDaySummary(i);
                    }
                }
                showNotification('Time slots copied to all days!', 'success');
            }
        }
        
        function switchSettingsTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.settings-content').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show selected tab content
            document.getElementById(`settings-content-${tabName}`).classList.remove('hidden');
            
            // Update tab button styling
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('text-gray-900', 'border-gray-900');
                btn.classList.add('text-gray-500', 'border-transparent');
            });
            
            const activeTab = document.getElementById(`settings-tab-${tabName}`);
            activeTab.classList.remove('text-gray-500', 'border-transparent');
            activeTab.classList.add('text-gray-900', 'border-gray-900');
        }
        
        async function saveWorkingHours() {
            const days = [1, 2, 3, 4, 5, 6, 7];
            const workingHours = [];
            
            days.forEach(dayNum => {
                const isOpen = document.getElementById(`day${dayNum}`).checked;
                const slotsContainer = document.getElementById(`time-slots-${dayNum}`);
                
                if (!slotsContainer) return;
                
                const timeSlots = slotsContainer.querySelectorAll('.time-slot-item');
                let openTime = '';
                let closeTime = '';
                let breakStart = null;
                let breakEnd = null;
                
                if (timeSlots.length > 0) {
                    // Get first slot start time as opening time
                    const firstSlot = timeSlots[0];
                    const firstStart = firstSlot.querySelector('[data-slot="start"]');
                    openTime = firstStart ? firstStart.value : '';
                    
                    // Get last slot end time as closing time
                    const lastSlot = timeSlots[timeSlots.length - 1];
                    const lastEnd = lastSlot.querySelector('[data-slot="end"]');
                    closeTime = lastEnd ? lastEnd.value : '';
                    
                    // If there are 2 slots, the gap between them is the lunch break
                    if (timeSlots.length === 2) {
                        const firstEnd = firstSlot.querySelector('[data-slot="end"]');
                        const secondSlot = timeSlots[1];
                        const secondStart = secondSlot.querySelector('[data-slot="start"]');
                        
                        if (firstEnd && secondStart) {
                            breakStart = firstEnd.value;
                            breakEnd = secondStart.value;
                        }
                    }
                }
                
                workingHours.push({
                    day_of_week: dayNum,
                    is_open: isOpen ? 1 : 0,
                    opening_time: openTime || '09:00',
                    closing_time: closeTime || '17:00',
                    break_start: breakStart,
                    break_end: breakEnd
                });
            });
            
            try {
                const response = await fetch(`${API_BASE}/admin/update_working_hours.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'update_weekly',
                        schedule: workingHours 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessageInElement('hoursUpdateMessage', 'Operating hours updated successfully!', 'success');
                    showNotification('Operating hours updated!', 'success');
                } else {
                    showMessageInElement('hoursUpdateMessage', data.message || 'Failed to update hours', 'error');
                }
            } catch (error) {
                console.error('Error saving working hours:', error);
                showMessageInElement('hoursUpdateMessage', 'Error updating hours', 'error');
            }
        }
        
        async function displaySpecialHours(specialHours) {
            const list = document.getElementById('specialHoursList');
            
            if (!specialHours || specialHours.length === 0) {
                list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No special dates configured</p>';
                return;
            }
            
            let html = '';
            specialHours.forEach(sh => {
                const dateObj = new Date(sh.date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900">${formattedDate}</p>
                            <p class="text-xs text-gray-600">${sh.reason}</p>
                            ${sh.is_open == 0 ? '<p class="text-xs text-red-600 font-semibold mt-1">CLOSED</p>' : 
                             `<p class="text-xs text-green-600 mt-1">${sh.opening_time} - ${sh.closing_time}</p>`}
                        </div>
                        <button onclick="deleteSpecialHour(${sh.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
        
        document.getElementById('specialHourForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const date = document.getElementById('specialDate').value;
            const reason = document.getElementById('specialReason').value;
            const openTime = document.getElementById('specialOpenTime').value;
            const closeTime = document.getElementById('specialCloseTime').value;
            const isClosed = document.getElementById('specialClosed').checked;
            
            try {
                const response = await fetch(`${API_BASE}/admin/update_working_hours.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        special_hours: [{
                            date: date,
                            reason: reason,
                            opening_time: openTime || null,
                            closing_time: closeTime || null,
                            is_open: isClosed ? 0 : 1
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Special date added successfully!', 'success');
                    e.target.reset();
                    loadWorkingHours(); // Reload to show new special hour
                } else {
                    alert(data.message || 'Failed to add special date');
                }
            } catch (error) {
                console.error('Error adding special hour:', error);
                alert('Error adding special date');
            }
        });
        
        async function deleteSpecialHour(id) {
            if (!confirm('Delete this special date?')) return;
            
            try {
                const response = await fetch(`${API_BASE}/admin/update_working_hours.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delete_special_hour: id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Special date deleted', 'success');
                    loadWorkingHours();
                } else {
                    alert(data.message || 'Failed to delete');
                }
            } catch (error) {
                console.error('Error deleting special hour:', error);
            }
        }
        
        async function saveSystemSettings() {
            const orderCutoff = document.getElementById('orderCutoffMinutes').value;
            const autoMove = document.getElementById('autoMovePending').checked;
            const avgTime = document.getElementById('avgProcessTime').value;
            const complexity = document.getElementById('itemComplexity').value;
            
            const settings = {
                closing_warning_minutes: orderCutoff,
                auto_move_pending_to_next_day: autoMove ? '1' : '0',
                avg_processing_time: avgTime,
                item_complexity_factor: complexity
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/update_working_hours.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'update_settings',
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('System settings saved!', 'success');
                } else {
                    showNotification(data.message || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Error saving system settings:', error);
                showNotification('Error saving settings', 'error');
            }
        }
        
        // Reset Daily Queue Function
        async function resetDailyQueue() {
            if (!confirm('Are you sure you want to reset the daily queue number?\n\nThis will reset the queue counter back to 1 for today. This action should only be done at the start of a new business day.')) {
                return;
            }
            
            const messageEl = document.getElementById('queueResetMessage');
            messageEl.textContent = 'Resetting queue...';
            messageEl.className = 'mt-3 text-sm font-medium text-center text-blue-600';
            
            try {
                const response = await fetch('../../php/api/admin/reset_daily_queue.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageEl.textContent = data.message;
                    messageEl.className = 'mt-3 text-sm font-medium text-center text-green-600';
                    showNotification('Daily queue has been reset successfully!', 'success');
                    
                    // Refresh the queue display
                    if (document.getElementById('content-queue-management').classList.contains('active')) {
                        await loadCurrentQueue();
                    }
                } else {
                    messageEl.textContent = data.message || 'Failed to reset queue';
                    messageEl.className = 'mt-3 text-sm font-medium text-center text-red-600';
                    showNotification(data.message || 'Failed to reset queue', 'error');
                }
            } catch (error) {
                console.error('Reset queue error:', error);
                messageEl.textContent = 'Error: ' + error.message;
                messageEl.className = 'mt-3 text-sm font-medium text-center text-red-600';
                showNotification('Failed to reset queue. Please try again.', 'error');
            }
            
            // Clear message after 10 seconds
            setTimeout(() => {
                messageEl.textContent = '';
            }, 10000);
        }
        
        function showMessageInElement(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `mt-4 text-sm font-medium ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            element.textContent = message;
            
            setTimeout(() => {
                element.textContent = '';
            }, 5000);
        }
        
        // ============================================
        // END WORKING HOURS MANAGEMENT
        // ============================================

        // Start the dashboard
        checkSuperAdminAccess(); // Show admin management tab for super admin
        initializeDashboard();
        loadInventory(); // Load inventory management data
        loadWorkingHours(); // Load working hours on init
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Settings Tab Styles */
        .settings-tab {
            transition: all 0.2s ease;
            border-bottom-width: 2px;
        }
        
        .settings-tab:hover {
            text-decoration: none;
            color: #111827;
        }
        
        .settings-content {
            display: block;
        }
        
        .settings-content.hidden {
            display: none;
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-15px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.25s ease-out;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Notification panel smooth transitions */
        #notificationList {
            transition: opacity 0.3s ease;
        }
        
        .notif-tab {
            transition: all 0.2s ease;
        }
        
        /* Smooth notification item animations */
        @keyframes notifSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease-out;
        }

        .custom-modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 28rem;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-modal-in {
            animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Retractable Sidebar Styles */
        .sidebar {
            width: 80px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: fixed;
            z-index: 100;
        }

        .sidebar:hover {
            width: 280px;
        }

        .sidebar-content {
            width: 280px;
        }

        .menu-text {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s ease-in-out;
        }

        .sidebar:hover .menu-text {
            opacity: 1;
            transition-delay: 0.1s;
        }

        .logo-text {
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: opacity 0.2s, max-width 0.3s;
        }

        .sidebar:hover .logo-text {
            opacity: 1;
            max-width: 200px;
            transition-delay: 0.1s;
        }

        .menu-icon {
            min-width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar nav li {
            position: relative;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: 50%;
            border: 3px solid #1e3a8a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px -1px rgba(30, 58, 138, 0.4);
            padding: 3px;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .main-content-adjusted {
            margin-left: 0;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Enhanced Card Styles */
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Button Hover Effects */
        .btn-primary {
            background: linear-gradient(135deg, #F97316, #EA580C);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.4);
        }
        
        /* Table Enhancements */
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05), rgba(249, 115, 22, 0.05));
            transform: translateX(4px);
        }
        
        /* Glassmorphism Effect */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Force hide tabs */
        .tab-content.hidden {
            display: none !important;
        }
        
        .tab-content {
            display: block;
        }

        /* Floating QR Scanner Button */
        .qr-scan-button {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #F97316, #EA580C);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(249, 115, 22, 0.5);
            transition: all 0.3s ease;
            z-index: 1000;
            border: 3px solid white;
        }

        .qr-scan-button:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 15px 35px rgba(249, 115, 22, 0.6);
        }

        .qr-scan-button:active {
            transform: scale(0.95);
        }

        .qr-scan-button i {
            color: white;
            font-size: 24px;
        }

        /* QR Scanner Modal */
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .qr-modal.active {
            display: flex;
        }

        .qr-modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
        }

        #qr-reader__dashboard_section_swaplink {
            display: none !important;
        }

        /* Ensure active tab hover works properly with border effect */
        nav li.bg-orange-500:hover {
            background-color: rgb(234 88 12) !important; /* hover:bg-orange-600 */
            border-left-color: rgb(251 146 60) !important; /* hover:border-orange-400 */
        }
    </style>

    <!-- Floating QR Scanner Button -->
    <div class="qr-scan-button" onclick="openQRScanner()" title="Scan QR Code">
        <i class="fas fa-camera"></i>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrScannerModal" class="qr-modal">
        <div class="qr-modal-content">
            <!-- Header -->
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-6 rounded-t-20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-qrcode text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-white">QR Code Scanner</h3>
                            <p class="text-orange-100 text-sm">Scan student order QR codes</p>
                        </div>
                    </div>
                    <button onclick="closeQRScanner()" class="text-white hover:bg-white/20 p-2 rounded-full transition">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>

            <!-- Scanner Content -->
            <div class="p-6">
                <!-- Scanner View -->
                <div id="qr-reader" class="mb-4 bg-gray-100"></div>

                <!-- Instructions -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                        <div>
                            <h4 class="font-semibold text-blue-900 mb-1">How to scan:</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li> Allow camera access when prompted</li>
                                <li> Position the QR code within the frame</li>
                                <li> Hold steady until the scanner detects it</li>
                                <li> Order details will appear automatically</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Scan Result -->
                <div id="qr-scan-result" class="hidden">
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg mb-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-green-900 mb-2">QR Code Detected!</h4>
                                <div id="qr-order-details" class="text-sm text-green-800">
                                    <!-- Order details will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="processScannedOrder()" class="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 text-white py-3 px-6 rounded-xl font-semibold hover:shadow-lg transition">
                            <i class="fas fa-check mr-2"></i>
                            Process Order
                        </button>
                        <button onclick="scanAgain()" class="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition">
                            <i class="fas fa-redo mr-2"></i>
                            Scan Again
                        </button>
                    </div>
                </div>

                <!-- Close Button -->
                <button onclick="closeQRScanner()" class="w-full mt-4 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition">
                    <i class="fas fa-times mr-2"></i>
                    Close Scanner
                </button>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let scannedOrderData = null;

        // Open QR Scanner
        function openQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            modal.classList.add('active');
            
            // Initialize scanner
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            // Start scanning
            html5QrCode.start(
                { facingMode: "environment" }, // Use back camera
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanError
            ).catch(err => {
                console.error("Error starting QR scanner:", err);
                showAlert('Camera Error', 'Unable to access camera. Please check permissions.', 'error');
            });
        }

        // Close QR Scanner
        function closeQRScanner() {
            const modal = document.getElementById('qrScannerModal');
            modal.classList.remove('active');
            
            // Stop scanner
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    console.log("QR Scanner stopped");
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                });
            }

            // Reset result display
            document.getElementById('qr-scan-result').classList.add('hidden');
            scannedOrderData = null;
        }

        // Handle successful scan
        function onScanSuccess(decodedText, decodedResult) {
            console.log("QR Code detected:", decodedText);
            
            // Stop scanning temporarily
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.pause(true);
            }

            try {
                // Parse QR code data
                const qrData = JSON.parse(decodedText);
                scannedOrderData = qrData;

                // Display order details
                displayScannedOrder(qrData);

            } catch (error) {
                console.error("Error parsing QR code:", error);
                showAlert('Invalid QR Code', 'This QR code is not a valid order code.', 'error');
                
                // Resume scanning
                setTimeout(() => {
                    if (html5QrCode) {
                        html5QrCode.resume();
                    }
                }, 2000);
            }
        }

        // Handle scan errors (silent - too many logs)
        function onScanError(errorMessage) {
            // Silent - normal when QR not in frame
        }

        // Display scanned order details
        function displayScannedOrder(qrData) {
            const detailsDiv = document.getElementById('qr-order-details');
            const resultDiv = document.getElementById('qr-scan-result');

            detailsDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <span class="font-semibold">Queue Number:</span>
                        <p class="text-lg font-bold text-green-600">${qrData.queue_number || 'N/A'}</p>
                    </div>
                    <div>
                        <span class="font-semibold">Email:</span>
                        <p class="text-sm">${qrData.email || 'N/A'}</p>
                    </div>
                    <div class="col-span-2">
                        <span class="font-semibold">Scanned At:</span>
                        <p class="text-sm">${new Date().toLocaleString()}</p>
                    </div>
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        // Process scanned order
        async function processScannedOrder() {
            if (!scannedOrderData) {
                showAlert('Error', 'No order data available', 'error');
                return;
            }

            const queueNumber = scannedOrderData.queue_number;
            
            // Find order in ordersData (the actual data source)
            const foundOrder = ordersData.find(order => order.queue_number === queueNumber);

            if (!foundOrder) {
                showAlert('Order Not Found', `Queue ${queueNumber} was not found. It may have been completed, cancelled, or doesn't exist.`, 'warning');
                closeQRScanner();
                return;
            }

            // Check order status
            if (foundOrder.order_status === 'completed') {
                showAlert('Order Already Completed', `Queue ${queueNumber} has already been completed and claimed.`, 'info');
                closeQRScanner();
                return;
            }

            if (foundOrder.order_status === 'cancelled') {
                showAlert('Order Cancelled', `Queue ${queueNumber} has been cancelled and is no longer active.`, 'warning');
                closeQRScanner();
                return;
            }

            // Check if this is the current queue (first pending/processing order)
            const currentOrder = currentQueueOrder;
            
            if (currentOrder && currentOrder.queue_number === queueNumber) {
                // This is the current queue! Process it automatically
                closeQRScanner();
                showTab('queue-management');
                
                // Scroll to current queue display
                document.getElementById('currentQueueDisplay').scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight the current order card
                const orderCard = document.getElementById('currentOrderCard');
                orderCard.style.boxShadow = '0 0 0 4px rgba(249, 115, 22, 0.5)';
                orderCard.style.transform = 'scale(1.02)';
                orderCard.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    orderCard.style.boxShadow = '';
                    orderCard.style.transform = '';
                }, 2000);
                
                // Automatically start processing if status is pending
                if (foundOrder.order_status === 'pending') {
                    await showAlert(
                        'QR Code Verified!',
                        `Queue ${queueNumber} detected. Starting processing...`,
                        'success'
                    );
                    
                    // Wait a moment for visual feedback, then start processing
                    setTimeout(async () => {
                        await processQueue('processing');
                    }, 800);
                } else if (foundOrder.order_status === 'processing') {
                    // Already processing, show message
                    await showAlert(
                        'Order in Progress',
                        `Queue ${queueNumber} is already being processed. Mark as ready when complete.`,
                        'info'
                    );
                }
                
                return;
            }

            // Order exists but is not the current queue
            if (foundOrder.order_status === 'pending' || foundOrder.order_status === 'processing') {
                // Get queue position
                const pendingOrders = ordersData.filter(o => 
                    (o.order_status === 'pending' || o.order_status === 'processing') &&
                    o.order_id <= foundOrder.order_id
                );
                const queuePosition = pendingOrders.length;
                const totalPending = ordersData.filter(o => 
                    o.order_status === 'pending' || o.order_status === 'processing'
                ).length;

                closeQRScanner();
                
                // Show modal with order details instead of just switching tabs
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 p-6 animate-modal-in">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-qrcode text-blue-600 mr-2"></i>
                                Scanned Order Details
                            </h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                                <div>
                                    <p class="font-semibold text-yellow-800">Not Current Queue</p>
                                    <p class="text-sm text-yellow-700 mt-1">
                                        This order is in position <strong>${queuePosition}</strong> of <strong>${totalPending}</strong> in the queue.
                                        Please process orders in sequence.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">Queue Number</p>
                                    <p class="text-lg font-bold text-blue-600">${foundOrder.queue_number}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Status</p>
                                    <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold ${
                                        foundOrder.order_status === 'processing' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${foundOrder.order_status === 'processing' ? 'Processing' : 'Pending'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="border-t pt-3">
                                <p class="text-sm text-gray-600">Student Information</p>
                                <p class="font-semibold text-gray-800">${foundOrder.first_name} ${foundOrder.last_name}</p>
                                <p class="text-sm text-gray-600">${foundOrder.student_id} | ${foundOrder.email}</p>
                            </div>
                            
                            <div class="border-t pt-3">
                                <p class="text-sm text-gray-600">Items Ordered</p>
                                <p class="font-semibold text-gray-800">${foundOrder.item_ordered}</p>
                            </div>
                            
                            <div class="border-t pt-3">
                                <p class="text-sm text-gray-600">Order Placed</p>
                                <p class="text-sm text-gray-800">${new Date(foundOrder.created_at).toLocaleString()}</p>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6">
                            <button onclick="this.closest('.fixed').remove(); showTab('queue-management'); setTimeout(() => { const rows = Array.from(document.querySelectorAll('#queueTableBody tr')); const row = rows.find(r => r.querySelector('td')?.textContent.trim() === '${foundOrder.queue_number}'); if(row) { row.scrollIntoView({behavior: 'smooth', block: 'center'}); row.style.backgroundColor = 'rgba(59, 130, 246, 0.2)'; setTimeout(() => row.style.backgroundColor = '', 3000); } }, 300);" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                <i class="fas fa-list mr-2"></i>
                                View in Queue Table
                            </button>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                return;
            }

            // Shouldn't reach here, but just in case
            showAlert('Unknown Status', `Queue ${queueNumber} has status: ${foundOrder.order_status}`, 'warning');
            closeQRScanner();
        }

        // Scan again
        function scanAgain() {
            document.getElementById('qr-scan-result').classList.add('hidden');
            scannedOrderData = null;
            
            if (html5QrCode) {
                html5QrCode.resume();
            }
        }

        // ============================================================================
        // NOTIFICATION SYSTEM
        // ============================================================================
        
        let notificationsData = [];
        let currentFilter = 'all'; // 'all', 'unread', 'read'
        
        async function loadNotifications() {
            try {
                const response = await fetch('/Q-Mak/php/api/admin/get_notifications.php');
                const data = await response.json();
                
                if (data.success) {
                    notificationsData = data.notifications;
                    const unreadCount = data.unread_count;
                    
                    const badge = document.getElementById('notificationBadge');
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                    
                    displayNotifications();
                    updateTabCounts();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }
        
        function filterNotifications(filter) {
            currentFilter = filter;
            
            // Update tab styles
            document.querySelectorAll('.notif-tab').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-white');
                tab.classList.add('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
            });
            
            const activeTab = document.getElementById(`tab-${filter}`);
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-900', 'hover:bg-gray-50');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600', 'bg-white');
            
            displayNotifications();
        }
        
        function updateTabCounts() {
            const unreadCount = notificationsData.filter(n => n.is_read == 0 || n.is_read === '0').length;
            const readCount = notificationsData.filter(n => n.is_read == 1 || n.is_read === '1').length;
            
            console.log('Unread count:', unreadCount, 'Read count:', readCount);
            
            document.getElementById('tab-unread').innerHTML = `Unread ${unreadCount > 0 ? `<span class="ml-1 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">${unreadCount}</span>` : ''}`;
            document.getElementById('tab-read').innerHTML = `Read ${readCount > 0 ? `<span class="ml-1 text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">${readCount}</span>` : ''}`;
        }
        
        function displayNotifications() {
            const list = document.getElementById('notificationList');
            
            // Filter notifications based on current filter
            // Convert is_read to number for consistent comparison
            let filteredNotifications = notificationsData;
            if (currentFilter === 'unread') {
                filteredNotifications = notificationsData.filter(n => n.is_read == 0 || n.is_read === '0');
            } else if (currentFilter === 'read') {
                filteredNotifications = notificationsData.filter(n => n.is_read == 1 || n.is_read === '1');
            }
            
            console.log('Current filter:', currentFilter);
            console.log('Total notifications:', notificationsData.length);
            console.log('Filtered notifications:', filteredNotifications.length);
            console.log('Notifications data:', notificationsData);
            
            if (filteredNotifications.length === 0) {
                let emptyMessage = 'No notifications';
                if (currentFilter === 'unread') emptyMessage = 'No unread notifications';
                if (currentFilter === 'read') emptyMessage = 'No read notifications';
                
                list.innerHTML = `
                    <div class="p-8 text-center">
                        <svg class="w-16 h-16 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                        <p class="text-gray-500 text-sm">${emptyMessage}</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredNotifications.map(notif => {
                const isUnread = notif.is_read == 0 || notif.is_read === '0';
                const date = new Date(notif.created_at);
                const timeAgo = getTimeAgo(date);
                
                return `
                    <div class="group p-4 hover:bg-blue-50/30 transition-all duration-200 ${isUnread ? 'bg-blue-50/50' : ''} relative cursor-pointer">
                        <div class="flex items-start gap-3">
                            ${isUnread ? '<div class="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0 animate-pulse"></div>' : '<div class="w-2 h-2 bg-gray-300 rounded-full mt-2 flex-shrink-0"></div>'}
                            <div class="flex-1 min-w-0">
                                <div class="flex items-start justify-between gap-2 mb-1">
                                    <h4 class="font-semibold text-sm ${isUnread ? 'text-gray-900' : 'text-gray-600'}">${notif.title}</h4>
                                    ${isUnread ? `
                                        <button onclick="markAsRead(${notif.notification_id}, event)" 
                                                class="opacity-0 group-hover:opacity-100 text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded font-medium whitespace-nowrap transition-all duration-200 flex-shrink-0 shadow-sm hover:shadow"
                                                title="Mark as read">
                                            <i class="fas fa-check mr-1"></i>Mark read
                                        </button>
                                    ` : `
                                        <span class="text-xs text-gray-400 flex items-center gap-1">
                                            <i class="fas fa-check-double"></i> Read
                                        </span>
                                    `}
                                </div>
                                <p class="text-sm text-gray-600 mb-2 line-clamp-2">${notif.message}</p>
                                <div class="flex items-center justify-between">
                                    <p class="text-xs text-gray-400 flex items-center gap-1">
                                        <i class="far fa-clock"></i> ${timeAgo}
                                    </p>
                                    ${notif.notification_type ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-medium">${notif.notification_type.replace('_', ' ')}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.classList.toggle('hidden');
            
            if (!panel.classList.contains('hidden')) {
                currentFilter = 'all'; // Reset to "All" tab when opening
                filterNotifications('all');
                loadNotifications();
            }
        }
        
        async function markAsRead(notificationId, event) {
            try {
                if (event) {
                    event.stopPropagation();
                }
                
                console.log('Marking notification as read:', notificationId);
                
                const response = await fetch('/Q-Mak/php/api/admin/get_notifications.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notification_id: notificationId, action: 'mark_read' })
                });
                
                const data = await response.json();
                console.log('Mark as read response:', data);
                
                if (data.success) {
                    // Reload notifications to update counts and list
                    await loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }
        
        async function markAllRead() {
            try {
                // Show confirmation for better UX
                if (currentFilter === 'unread') {
                    const unreadCount = notificationsData.filter(n => n.is_read === '0').length;
                    if (unreadCount === 0) return;
                }
                
                const response = await fetch('/Q-Mak/php/api/admin/get_notifications.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'mark_all_read' })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Smooth transition
                    const list = document.getElementById('notificationList');
                    list.style.opacity = '0';
                    setTimeout(() => {
                        loadNotifications();
                        list.style.opacity = '1';
                    }, 200);
                }
            } catch (error) {
                console.error('Error marking all as read:', error);
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }
        
        // Close notification panel when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationPanel');
            const button = event.target.closest('button[onclick="toggleNotifications()"]');
            
            if (!panel.classList.contains('hidden') && !panel.contains(event.target) && !button) {
                panel.classList.add('hidden');
            }
        });
        
        // Load notifications on page load and refresh every 5 minutes
        loadNotifications();
        setInterval(loadNotifications, 5 * 60 * 1000);
    </script>
</body>
</html>