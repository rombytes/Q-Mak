<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - UMak COOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 text-white flex flex-col">
        <div class="p-6 text-center border-b border-gray-700">
            <h3 class="text-xl font-bold text-orange-400">COOP Admin</h3>
            <p class="text-sm text-gray-400 mt-2" id="sidebarAdminName">Loading...</p>
        </div>
        <nav class="flex-1">
            <ul>
                <li onclick="showTab('queue-management')" id="tab-queue-management" class="px-6 py-4 cursor-pointer transition border-l-4 bg-blue-900 border-orange-500 font-bold">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Queue & Orders
                    </div>
                </li>
                <li onclick="showTab('queue-history')" id="tab-queue-history" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="m9 16 2 2 4-4"/></svg>
                        Queue History
                    </div>
                </li>
                <li onclick="showTab('student-records')" id="tab-student-records" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Student Records
                    </div>
                </li>
                <li onclick="showTab('analytics')" id="tab-analytics" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a2.3 2.3 0 0 0-3.4 0l-4.6 4.6a2.3 2.3 0 0 0 0 3.4l1.6 1.6a2.3 2.3 0 0 0 3.4 0l4.6-4.6a2.3 2.3 0 0 0 0-3.4Z"/><path d="M12 12 1.4 1.4"/><path d="M7.7 3H5v2.7Z"/></svg>
                        Analytics
                    </div>
                </li>
                <li onclick="showTab('service-config')" id="tab-service-config" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Service Config
                    </div>
                </li>
                <li onclick="showTab('email-logs')" id="tab-email-logs" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                        Email Logs
                    </div>
                </li>
                <li onclick="showTab('admin-settings')" id="tab-admin-settings" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                        Admin Settings
                    </div>
                </li>
                <li onclick="showTab('admin-management')" id="tab-admin-management" class="px-6 py-4 cursor-pointer transition border-l-4 border-transparent hover:bg-gray-700 hidden">
                    <div class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="22" x2="22" y1="11" y2="11"/><line x1="19" x2="25" y1="11" y2="11"/><line x1="22" x2="22" y1="8" y2="14"/></svg>
                        Admin Management
                    </div>
                </li>
            </ul>
        </nav>
        <button onclick="logout()" class="m-4 bg-red-600 hover:bg-red-700 py-3 rounded font-bold">
            Log Out
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-gray-100">
        <!-- Top Bar -->
        <div class="bg-white shadow-sm sticky top-0 z-10 px-8 py-5 border-b">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-900">
                    Welcome, <span id="adminName" class="text-orange-500">Admin</span>! 
                </h1>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <div id="connectionStatus" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-sm text-gray-600">Live</span>
                    </div>
                    <p class="text-gray-600" id="currentDate"></p>
                </div>
            </div>
        </div>

        <div class="p-8">
            <!-- Queue Management Tab -->
            <div id="content-queue-management" class="tab-content">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Queue & Orders Management</h2>
                
                <!-- Current Queue Display -->
                <div id="currentQueueDisplay" class="bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-lg shadow-lg p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold">Current Queue</h3>
                        <div class="text-sm bg-orange-500 px-4 py-2 rounded-full font-bold" id="queuePosition">Queue: -</div>
                    </div>
                    
                    <div id="currentOrderCard" class="bg-white text-gray-900 rounded-lg p-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-bold text-blue-900 mb-4">Order Information</h4>
                                <div class="space-y-2">
                                    <div><span class="font-bold">Queue Number:</span> <span id="currentQueueNumber">-</span></div>
                                    <div><span class="font-bold">Item Ordered:</span> <span id="currentItemOrdered">-</span></div>
                                    <div><span class="font-bold">Time Placed:</span> <span id="currentTimePlaced">-</span></div>
                                    <div><span class="font-bold">Wait Time:</span> <span id="currentWaitTime">-</span> mins</div>
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-bold text-blue-900 mb-4">Student Information</h4>
                                <div class="space-y-2">
                                    <div><span class="font-bold">Student ID:</span> <span id="currentStudentId">-</span></div>
                                    <div><span class="font-bold">Name:</span> <span id="currentStudentName">-</span></div>
                                    <div><span class="font-bold">Email:</span> <span id="currentStudentEmail">-</span></div>
                                    <div><span class="font-bold">Program:</span> <span id="currentStudentProgram">-</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-200">
    
                            <div id="queue-action-start" class="flex justify-center">
                                <button onclick="processQueue('processing')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                    Start Processing
                                </button>
                            </div>
                            
                            <div id="queue-action-process" class="flex gap-4 justify-center hidden">
                                <button onclick="processQueue('ready')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                    Mark Ready
                                </button>
                                <button onclick="processQueue('completed')" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                    Complete
                                </button>
                                <button onclick="skipQueue()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>
                                    Skip
                                </button>
                                <button onclick="processQueue('cancelled')" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></svg>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="noQueueMessage" class="hidden bg-white text-gray-900 rounded-lg p-8 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-400"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                        <h4 class="text-xl font-bold text-gray-600 mb-2">No Orders in Queue</h4>
                        <p class="text-gray-500">All orders have been processed or there are no pending orders.</p>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Pending Orders</h4>
                        <p class="text-5xl font-bold text-orange-500" id="pendingCount">1</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Ready for Pick Up</h4>
                        <p class="text-5xl font-bold text-blue-500" id="readyCount">1</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Completed Today</h4>
                        <p class="text-5xl font-bold text-green-600" id="doneCount">1</p>
                    </div>
                </div>

                <!-- Queue Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Current Queue Status</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Queue ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Student ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Time Placed</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Current Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody id="queueTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student Records Tab -->
            <div id="content-student-records" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Student Records</h2>
                <input type="text" id="searchStudent" placeholder="Search by Student ID or Email..." class="w-full border border-gray-300 rounded p-3 mb-6" onkeyup="filterStudents()" />
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Student ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Full Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">College</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Program</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Year Level</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Section</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Action</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Service Config Tab -->
            <div id="content-service-config" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Service & Time Configuration</h2>
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Add New Service</h3>
                    <form id="addServiceForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block font-bold mb-1">Service Name *</label>
                                <input type="text" id="newServiceName" required class="w-full border border-gray-300 rounded p-2" placeholder="e.g., School Uniform" />
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Estimated Time (mins) *</label>
                                <input type="number" id="newServiceTime" required min="1" value="10" class="w-full border border-gray-300 rounded p-2" />
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Add Service
                        </button>
                    </form>
                    <div id="addServiceMessage" class="mt-4 text-sm font-medium"></div>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Current Services</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Service ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Service Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Estimated Time (mins)</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Inventory Management Section -->
                <div class="bg-gradient-to-br from-purple-900 to-blue-900 rounded-lg shadow-lg p-6 mt-6 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <svg class="w-8 h-8 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        <div>
                            <h3 class="text-2xl font-bold text-white">Inventory Management</h3>
                            <p class="text-purple-200 text-sm">Control stock availability for student orders</p>
                        </div>
                    </div>
                    <form id="addInventoryItemForm" class="space-y-4 bg-white/10 backdrop-blur rounded-lg p-4">
                        <div>
                            <label class="block font-bold mb-2 text-white">Add New Item to Inventory</label>
                            <div class="flex gap-2">
                                <input type="text" id="newInventoryItemName" required 
                                       class="flex-1 border border-purple-200 rounded p-3 focus:ring-2 focus:ring-purple-300 focus:border-purple-300" 
                                       placeholder="e.g., ID Lace, School Uniform" />
                                <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded font-bold whitespace-nowrap transition-all hover:scale-105">
                                    Add Item
                                </button>
                            </div>
                        </div>
                        <div id="addInventoryMessage" class="text-sm font-medium"></div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div class="p-6 bg-gradient-to-r from-blue-900 to-purple-900">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-2">Inventory Stock Status</h3>
                                <p class="text-blue-100 text-sm">Manage availability of items for ordering</p>
                            </div>
                            <div class="flex gap-3 text-sm">
                                <div class="bg-white/20 backdrop-blur rounded-lg px-4 py-2">
                                    <span class="text-green-300 font-bold">●</span>
                                    <span class="text-white ml-1">In Stock</span>
                                </div>
                                <div class="bg-white/20 backdrop-blur rounded-lg px-4 py-2">
                                    <span class="text-red-300 font-bold">●</span>
                                    <span class="text-white ml-1">Out of Stock</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase tracking-wider">Item Name</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase tracking-wider">Stock Status</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase tracking-wider">Last Updated</th>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-blue-900 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Edit Service Modal -->
            <div id="editServiceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Edit Service</h3>
                    <form id="editServiceForm" class="space-y-4">
                        <input type="hidden" id="editServiceId" />
                        <div>
                            <label class="block font-bold mb-1">Service Name *</label>
                            <input type="text" id="editServiceName" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Estimated Time (mins) *</label>
                            <input type="number" id="editServiceTime" required min="1" class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editServiceActive" class="w-4 h-4" />
                                <span class="font-bold">Active</span>
                            </label>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                                Update
                            </button>
                            <button type="button" onclick="closeEditServiceModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <div id="editServiceMessage" class="mt-4 text-sm font-medium"></div>
                </div>
            </div>

            <!-- Email Logs Tab -->
            <div id="content-email-logs" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Email Logs</h2>
                
                <!-- Statistics Cards -->
                <div class="grid grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Total Emails</h4>
                        <p class="text-4xl font-bold text-blue-600" id="totalEmails">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Successfully Sent</h4>
                        <p class="text-4xl font-bold text-green-600" id="sentEmails">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Failed</h4>
                        <p class="text-4xl font-bold text-red-600" id="failedEmails">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Success Rate</h4>
                        <p class="text-4xl font-bold text-indigo-600" id="successRate">0%</p>
                    </div>
                </div>
                
                <!-- Filters and Actions -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <select id="filterEmailType" onchange="fetchEmailLogs()" class="border border-gray-300 rounded p-2">
                            <option value="all">All Types</option>
                            <option value="otp">OTP</option>
                            <option value="receipt">Receipt</option>
                            <option value="status_update">Status Update</option>
                        </select>
                        <select id="filterEmailStatus" onchange="fetchEmailLogs()" class="border border-gray-300 rounded p-2">
                            <option value="all">All Status</option>
                            <option value="sent">Sent</option>
                            <option value="failed">Failed</option>
                        </select>
                        <input type="text" id="searchEmail" placeholder="Search by email..." 
                               onkeyup="fetchEmailLogs()" class="border border-gray-300 rounded p-2" />
                        <button onclick="toggleArchivedView()" id="viewArchivedBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold">
                            View Archived
                        </button>
                    </div>
                    <div id="emailLogActions" class="hidden flex gap-2">
                        <button onclick="archiveSelectedLogs()" id="archiveLogsBtn" class="bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded font-bold text-sm">
                            Archive Selected
                        </button>
                        <button onclick="restoreSelectedLogs()" id="restoreLogsBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold text-sm">
                            Restore Selected (Super Admin)
                        </button>
                        <button onclick="deleteSelectedLogs()" id="deleteLogsBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold text-sm">
                            Permanently Delete (Super Admin)
                        </button>
                        <span id="selectedCount" class="text-sm text-gray-600 flex items-center ml-2"></span>
                    </div>
                </div>
                
                <!-- Email Logs Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-900 mb-4" id="emailLogsTableTitle">Email History</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left">
                                        <input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs()" class="w-4 h-4">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Log ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Recipient</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Subject</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Sent At</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogsTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin Settings Tab -->
            <div id="content-admin-settings" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Admin Account Management</h2>
                <div class="bg-white rounded-lg shadow p-8 max-w-md">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 border-b pb-2">Change Password</h3>
                    
                    <form id="passwordUpdateForm" class="space-y-4">
        
                        <div>
                            <label class="block font-bold mb-1">Current Password</label>
                            <input type="password" id="currentPassword" class="w-full border border-gray-300 rounded p-2" required />
                        </div>
                        
                        <div>
                            <label class="block font-bold mb-1">New Password</label>
                            <input type="password" id="newPassword" class="w-full border border-gray-300 rounded p-2" required />
                        </div>
                        
                        <div>
                            <label class="block font-bold mb-1">Confirm Password</label>
                            <input type="password" id="confirmPassword" class="w-full border border-gray-300 rounded p-2" required />
                        </div>
                        
                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Update Password
                        </button>
                    </form>

                    <div id="passwordUpdateMessage" class="mt-4 text-sm font-medium"></div>
                </div>
            </div>

            <!-- Admin Management Tab -->
            <div id="content-admin-management" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Admin Account Management</h2>
                
                <!-- Create New Admin Form -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Create New Admin Account</h3>
                    <form id="createAdminForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block font-bold mb-1">Full Name *</label>
                                <input type="text" id="newAdminFullName" required class="w-full border border-gray-300 rounded p-2" />
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Username *</label>
                                <input type="text" id="newAdminUsername" required class="w-full border border-gray-300 rounded p-2" />
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Email *</label>
                                <input type="email" id="newAdminEmail" required class="w-full border border-gray-300 rounded p-2" />
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Password * (min 8 characters)</label>
                                <input type="password" id="newAdminPassword" required minlength="8" class="w-full border border-gray-300 rounded p-2" />
                            </div>
                            <div>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="newAdminSuperAdmin" class="w-4 h-4" />
                                    <span class="font-bold">Super Admin</span>
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Create Admin Account
                        </button>
                    </form>
                    <div id="createAdminMessage" class="mt-4 text-sm font-medium"></div>
                </div>
                
                <!-- Admins List -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-blue-900 mb-4">Admin Accounts</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Full Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="adminAccountsTableBody" class="divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Edit Admin Modal -->
            <div id="editAdminModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold text-blue-900 mb-4">Edit Admin Account</h3>
                    <form id="editAdminForm" class="space-y-4">
                        <input type="hidden" id="editAdminId" />
                        <div>
                            <label class="block font-bold mb-1">Full Name</label>
                            <input type="text" id="editAdminFullName" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Username</label>
                            <input type="text" id="editAdminUsername" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Email</label>
                            <input type="email" id="editAdminEmail" required class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="block font-bold mb-1">New Password (leave blank to keep current)</label>
                            <input type="password" id="editAdminPassword" minlength="8" class="w-full border border-gray-300 rounded p-2" />
                        </div>
                        <div>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="editAdminSuperAdmin" class="w-4 h-4" />
                                <span class="font-bold">Super Admin</span>
                            </label>
                        </div>
                        <div class="flex gap-4">
                            <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                                Update
                            </button>
                            <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                                Cancel
                            </button>
                        </div>
                    </form>
                    <div id="editAdminMessage" class="mt-4 text-sm font-medium"></div>
                </div>
            </div>

            <!-- Student Details Modal -->
            <div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-blue-900" id="studentModalTitle">Student Details</h3>
                            <button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="flex gap-2 mt-4">
                            <button onclick="switchStudentTab('current')" id="student-tab-current" class="px-4 py-2 rounded font-bold bg-blue-900 text-white">
                                Current Order
                            </button>
                            <button onclick="switchStudentTab('info')" id="student-tab-info" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Student Info
                            </button>
                            <button onclick="switchStudentTab('history')" id="student-tab-history" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">
                                Order History
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px);">
                        <!-- Current Order Tab -->
                        <div id="student-content-current" class="student-tab-content">
                            <div id="studentCurrentOrder"></div>
                        </div>
                        
                        <!-- Student Info Tab -->
                        <div id="student-content-info" class="student-tab-content hidden">
                            <div id="studentInfoContent"></div>
                        </div>
                        
                        <!-- Order History Tab -->
                        <div id="student-content-history" class="student-tab-content hidden">
                            <div id="studentOrderHistory"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="content-queue-history" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Queue History</h2>
                
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="filterHistoryDate" class="block text-sm font-medium text-gray-700">Filter by Date</label>
                            <input type="date" id="filterHistoryDate" onchange="fetchHistory()" class="mt-1 border border-gray-300 rounded p-2 w-full">
                        </div>
                        <div>
                            <label for="filterHistoryStatus" class="block text-sm font-medium text-gray-700">Filter by Status</label>
                            <select id="filterHistoryStatus" onchange="fetchHistory()" class="mt-1 border border-gray-300 rounded p-2 w-full">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="processing">Processing</option>
                                <option value="ready">Ready</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div>
                            <label for="searchHistory" class="block text-sm font-medium text-gray-700">Search</label>
                            <input type="text" id="searchHistory" placeholder="Student ID, Queue #" 
                                   onkeyup="fetchHistory()" class="mt-1 border border-gray-300 rounded p-2 w-full" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-transparent">Actions</label>
                            <button onclick="resetHistoryFilters()" class="mt-1 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold w-full">
                                Reset Filters
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Queue ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Date Placed</th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="content-analytics" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-blue-900 mb-6 border-b-2 border-blue-400 pb-2">Analytics & Reports</h2>
                
                <!-- Period Selector -->
                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <div class="flex flex-col gap-4">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-medium text-gray-700">Quick Period:</label>
                            <div class="flex gap-2">
                                <button onclick="setAnalyticsPeriod('daily')" id="btn-daily" class="px-4 py-2 rounded font-bold bg-blue-900 text-white">Daily</button>
                                <button onclick="setAnalyticsPeriod('weekly')" id="btn-weekly" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Weekly</button>
                                <button onclick="setAnalyticsPeriod('monthly')" id="btn-monthly" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Monthly</button>
                                <button onclick="setAnalyticsPeriod('yearly')" id="btn-yearly" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Yearly</button>
                                <button onclick="setAnalyticsPeriod('custom')" id="btn-custom" class="px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300">Custom Range</button>
                            </div>
                        </div>
                        <div id="customDateRange" class="hidden grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="date" id="customStartDate" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="date" id="customEndDate" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-transparent mb-1">Apply</label>
                                <button onclick="applyCustomDateRange()" class="w-full bg-blue-900 hover:bg-blue-800 text-white px-4 py-2 rounded font-bold">
                                    Apply Range
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Total Orders</h4>
                        <p class="text-5xl font-bold text-blue-600" id="analyticsTotalOrders">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Total Completed</h4>
                        <p class="text-5xl font-bold text-green-600" id="analyticsTotalCompleted">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <h4 class="text-gray-600 mb-2">Top Item</h4>
                        <p class="text-2xl font-bold text-orange-500" id="analyticsTopItem">N/A</p>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h3 class="text-xl font-bold text-blue-900 mb-4">Orders Trend</h3>
                    <canvas id="ordersChart" height="80"></canvas>
                </div>

                <!-- Order Status Breakdown and Product Quantities -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">Order Status Breakdown</h3>
                            <p class="text-sm text-gray-500" id="statusDateRange">Loading...</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Count</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">%</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsStatusBody" class="divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-6">
                            <h3 class="text-xl font-bold text-blue-900 mb-4">Product Quantities</h3>
                            <p class="text-sm text-gray-500" id="productDateRange">Loading...</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Product</th>
                                        <th class="px-6 py-3 text-left text-xs font-bold text-blue-900 uppercase">Qty Sold</th>
                                    </tr>
                                </thead>
                                <tbody id="analyticsProductQtyBody" class="divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Top Items - Enhanced Layout -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-6 bg-gradient-to-r from-blue-900 to-blue-700">
                        <h3 class="text-2xl font-bold text-white mb-2">Top Ordered Items</h3>
                        <p class="text-blue-100 text-sm">Most popular items in this period</p>
                    </div>
                    <div class="p-6">
                        <div id="analyticsTopItemsBody" class="space-y-3">
                        </div>
                    </div>
                </div>
            </div>
        </div> </div>
    </div>

    <script>
        const API_BASE = '../../php/api';
        let ordersData = [];
        let studentsData = [];
        let refreshInterval = null;
        let currentQueueOrder = null;
        let queueIndex = 0;
        let ordersChart = null;
        let currentAnalyticsPeriod = 'daily';
        let showingArchivedLogs = false;
        let selectedLogIds = [];
        let inventoryStock = {};

        // Check if admin is logged in
        if (!sessionStorage.getItem('adminLoggedIn')) {
            window.location.href = 'admin_login.html';
        }

        // Display current date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').textContent = 'Today is: ' + new Date().toLocaleDateString('en-US', options);

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all menu items
            document.querySelectorAll('nav li').forEach(item => {
                item.classList.remove('bg-blue-900', 'border-orange-500', 'font-bold');
                item.classList.add('border-transparent');
            });
            
            // Show selected tab
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Add active class to selected menu item
            const activeItem = document.getElementById('tab-' + tabName);
            activeItem.classList.add('bg-blue-900', 'border-orange-500', 'font-bold');
            activeItem.classList.remove('border-transparent');

            // Fetch data for the tab if it's one of the new ones
            if (tabName === 'queue-history') {
                fetchHistory(); // Fetch history data
            } else if (tabName === 'analytics') {
                fetchAnalyticsByPeriod(currentAnalyticsPeriod);
            } else if (tabName === 'student-records') {
                fetchStudents(); // Fetch student data
            } else if (tabName === 'admin-management') {
                fetchAdminAccounts();
            }
        }

        // Logout function
        async function logout() {
            sessionStorage.clear();
            window.location.href = '../index.html';
        }

        // Fetch orders from API
        async function fetchOrders() {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'GET',
                    credentials: 'include' // Important for session cookies
                });
                
                const result = await response.json();
                
                if (result.success) {
                    ordersData = result.data.orders;
                    displayQueueTable();
                    updateCounts(result.data.stats);
                    updateCurrentQueue();
                    updateConnectionStatus(true);
                } else if (response.status === 401) {
                    // Session expired, redirect to login
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                updateConnectionStatus(false);
            }
        }

        // Fetch students from API
        async function fetchStudents() {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    studentsData = result.data.students;
                    updateStudentTable();
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching students:', error);
            }
        }

        // Update student table display
        function updateStudentTable() {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            if (!studentsData || studentsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">No students found</td></tr>';
                return;
            }

            studentsData.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4">${student.student_id || 'N/A'}</td>
                    <td class="px-6 py-4">${student.first_name || ''} ${student.last_name || ''}</td>
                    <td class="px-6 py-4">${student.college || 'N/A'}</td>
                    <td class="px-6 py-4">${student.program || 'N/A'}</td>
                    <td class="px-6 py-4">${student.year_level || 'N/A'}</td>
                    <td class="px-6 py-4">${student.section || 'N/A'}</td>
                    <td class="px-6 py-4">${student.email || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <button onclick="viewStudentDetails('${student.student_id}')" class="text-blue-600 hover:text-blue-800 font-bold">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter students based on search
        function filterStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            
            if (!searchTerm) {
                updateStudentTable();
                return;
            }

            const filtered = studentsData.filter(student => {
                return (student.student_id && student.student_id.toLowerCase().includes(searchTerm)) ||
                       (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                       (student.first_name && student.first_name.toLowerCase().includes(searchTerm)) ||
                       (student.last_name && student.last_name.toLowerCase().includes(searchTerm));
            });

            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = '';

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-8 text-center text-gray-500">No matching students found</td></tr>';
                return;
            }

            filtered.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4">${student.student_id || 'N/A'}</td>
                    <td class="px-6 py-4">${student.first_name || ''} ${student.last_name || ''}</td>
                    <td class="px-6 py-4">${student.college || 'N/A'}</td>
                    <td class="px-6 py-4">${student.program || 'N/A'}</td>
                    <td class="px-6 py-4">${student.year_level || 'N/A'}</td>
                    <td class="px-6 py-4">${student.section || 'N/A'}</td>
                    <td class="px-6 py-4">${student.email || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <button onclick="viewStudentDetails('${student.student_id}')" class="text-blue-600 hover:text-blue-800 font-bold">
                            View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // View student details in modal
        async function viewStudentDetails(studentId) {
            const student = studentsData.find(s => s.student_id === studentId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            // Show modal
            document.getElementById('studentDetailsModal').classList.remove('hidden');
            document.getElementById('studentDetailsModal').classList.add('flex');
            document.getElementById('studentModalTitle').textContent = `${student.first_name} ${student.last_name} (${student.student_id})`;
            
            // Switch to current order tab
            switchStudentTab('current');
            
            // Load student data
            await loadStudentCurrentOrder(studentId);
            loadStudentInfo(student);
            await loadStudentOrderHistory(studentId);
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('studentDetailsModal').classList.add('hidden');
            document.getElementById('studentDetailsModal').classList.remove('flex');
        }

        // Switch student modal tabs
        function switchStudentTab(tabName) {
            // Update button styles
            ['current', 'info', 'history'].forEach(tab => {
                const btn = document.getElementById(`student-tab-${tab}`);
                const content = document.getElementById(`student-content-${tab}`);
                if (tab === tabName) {
                    btn.className = 'px-4 py-2 rounded font-bold bg-blue-900 text-white';
                    content.classList.remove('hidden');
                } else {
                    btn.className = 'px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300';
                    content.classList.add('hidden');
                }
            });
        }

        // Load student current order
        async function loadStudentCurrentOrder(studentId) {
            const container = document.getElementById('studentCurrentOrder');
            container.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            // Find current orders for this student
            const currentOrders = ordersData.filter(o => 
                o.student_id === studentId && 
                (o.order_status === 'pending' || o.order_status === 'processing' || o.order_status === 'ready')
            );
            
            if (currentOrders.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No current orders in queue</div>';
                return;
            }
            
            container.innerHTML = currentOrders.map(order => {
                const statusColor = getStatusColor(order.order_status);
                const createdTime = new Date(order.created_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg text-blue-900">Queue #${order.queue_number}</h4>
                                <p class="text-sm text-gray-500">${createdTime}</p>
                            </div>
                            <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                                ${capitalizeWords(order.order_status)}
                            </span>
                        </div>
                        <div class="space-y-2">
                            <p><span class="font-bold">Item:</span> ${capitalizeWords(order.item_ordered)}</p>
                            <p><span class="font-bold">Wait Time:</span> ${order.estimated_wait_time} minutes</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load student information
        function loadStudentInfo(student) {
            const container = document.getElementById('studentInfoContent');
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            const isSuperAdmin = adminData && adminData.role === 'super_admin';
            
            container.innerHTML = `
                <div class="grid grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Personal Information</h4>
                        <div><span class="font-bold">Student ID:</span> ${student.student_id || 'N/A'}</div>
                        <div><span class="font-bold">Full Name:</span> ${student.first_name} ${student.last_name}</div>
                        <div><span class="font-bold">Email:</span> ${student.email || 'N/A'}</div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Academic Information</h4>
                        <div><span class="font-bold">College:</span> ${student.college || 'N/A'}</div>
                        <div><span class="font-bold">Program:</span> ${student.program || 'N/A'}</div>
                        <div><span class="font-bold">Year Level:</span> ${student.year_level || 'N/A'}</div>
                        <div><span class="font-bold">Section:</span> ${student.section || 'N/A'}</div>
                    </div>
                </div>
                ${isSuperAdmin ? `
                    <div class="mt-6 pt-6 border-t">
                        <button onclick="editStudentInfo('${student.student_id}')" class="bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Edit Student Information
                        </button>
                    </div>
                ` : ''}
            `;
        }

        // Edit student information (super admin only)
        async function editStudentInfo(studentId) {
            const student = studentsData.find(s => s.student_id === studentId);
            if (!student) return;
            
            const container = document.getElementById('studentInfoContent');
            container.innerHTML = `
                <form id="editStudentForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Personal Information</h4>
                            <div>
                                <label class="block font-bold mb-1">First Name</label>
                                <input type="text" id="edit_first_name" value="${student.first_name || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Last Name</label>
                                <input type="text" id="edit_last_name" value="${student.last_name || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Email</label>
                                <input type="email" id="edit_email" value="${student.email || ''}" class="w-full border border-gray-300 rounded p-2" required>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-bold text-lg text-blue-900 border-b pb-2">Academic Information</h4>
                            <div>
                                <label class="block font-bold mb-1">College</label>
                                <input type="text" id="edit_college" value="${student.college || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Program</label>
                                <input type="text" id="edit_program" value="${student.program || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Year Level</label>
                                <input type="text" id="edit_year_level" value="${student.year_level || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                            <div>
                                <label class="block font-bold mb-1">Section</label>
                                <input type="text" id="edit_section" value="${student.section || ''}" class="w-full border border-gray-300 rounded p-2">
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded font-bold">
                            Save Changes
                        </button>
                        <button type="button" onclick="loadStudentInfo(studentsData.find(s => s.student_id === '${studentId}'))" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded font-bold">
                            Cancel
                        </button>
                    </div>
                </form>
            `;
            
            // Add form submit handler
            document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveStudentChanges(studentId);
            });
        }

        // Save student changes (super admin only)
        async function saveStudentChanges(studentId) {
            const updatedData = {
                student_id: studentId,
                first_name: document.getElementById('edit_first_name').value,
                last_name: document.getElementById('edit_last_name').value,
                email: document.getElementById('edit_email').value,
                college: document.getElementById('edit_college').value,
                program: document.getElementById('edit_program').value,
                year_level: document.getElementById('edit_year_level').value,
                section: document.getElementById('edit_section').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_students.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Student information updated successfully', 'success');
                    // Refresh student data
                    await fetchStudents();
                    // Reload student info
                    const updatedStudent = studentsData.find(s => s.student_id === studentId);
                    if (updatedStudent) {
                        loadStudentInfo(updatedStudent);
                    }
                } else {
                    alert(result.message || 'Failed to update student information');
                }
            } catch (error) {
                console.error('Error updating student:', error);
                alert('Error updating student information');
            }
        }

        // Load student order history
        async function loadStudentOrderHistory(studentId) {
            const container = document.getElementById('studentOrderHistory');
            container.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php?filter=history&student_id=${studentId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success && result.data.orders) {
                    const orders = result.data.orders;
                    
                    if (orders.length === 0) {
                        container.innerHTML = '<div class="text-center py-8 text-gray-500">No order history found</div>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <table class="w-full">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Queue #</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Item</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-blue-900 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${orders.map(order => {
                                    const statusColor = getStatusColor(order.order_status);
                                    const createdDate = new Date(order.created_at).toLocaleString('en-US', {
                                        year: 'numeric', month: 'short', day: 'numeric', 
                                        hour: '2-digit', minute: '2-digit'
                                    });
                                    return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3">${order.queue_number}</td>
                                            <td class="px-4 py-3">${capitalizeWords(order.item_ordered || order.item_name)}</td>
                                            <td class="px-4 py-3">${createdDate}</td>
                                            <td class="px-4 py-3">
                                                <span class="${statusColor} text-white px-2 py-1 rounded text-xs font-bold uppercase">
                                                    ${capitalizeWords(order.order_status)}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Error loading order history</div>';
                }
            } catch (error) {
                console.error('Error loading student order history:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Error loading order history</div>';
            }
        }

        // --- ADDED: New function to fetch data for the Queue History tab ---
        async function fetchHistory() {
            const date = document.getElementById('filterHistoryDate').value;
            const status = document.getElementById('filterHistoryStatus').value;
            const search = document.getElementById('searchHistory').value;

            // We pass ?filter=history to get ALL orders
            let url = `${API_BASE}/admin/admin_orders.php?filter=history`;
            if (date) url += `&date=${date}`;
            if (status !== 'all') url += `&status=${status}`;
            if (search) url += `&search=${search}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    displayHistoryTable(result.data.orders);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching order history:', error);
            }
        }

        // --- ADDED: New function to display the history table ---
        function displayHistoryTable(orders) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No order history found for these filters.</td></tr>';
                return;
            }

            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const createdDate = new Date(order.created_at).toLocaleString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // Format items with quantity
                const items = order.item_ordered ? order.item_ordered.split(',').map(i => i.trim()) : [];
                const itemCount = items.length;
                const itemDisplay = itemCount > 1 ? `<strong>${itemCount} items:</strong> ${order.item_ordered}` : order.item_ordered;

                row.innerHTML = `
                    <td class="px-6 py-4">${order.queue_number}</td>
                    <td class="px-6 py-4">${order.first_name} ${order.last_name} (${order.student_id})</td>
                    <td class="px-6 py-4">${itemDisplay}</td>
                    <td class="px-6 py-4">${createdDate}</td>
                    <td class="px-6 py-4">
                        <span class="${getStatusColor(order.order_status)} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                            ${order.order_status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- ADDED: New function to reset history filters ---
        function resetHistoryFilters() {
            document.getElementById('filterHistoryDate').value = '';
            document.getElementById('filterHistoryStatus').value = 'all';
            document.getElementById('searchHistory').value = '';
            fetchHistory();
        }

        // Set analytics period and fetch data
        function setAnalyticsPeriod(period) {
            currentAnalyticsPeriod = period;
            
            // Update button styles
            ['daily', 'weekly', 'monthly', 'yearly', 'custom'].forEach(p => {
                const btn = document.getElementById(`btn-${p}`);
                if (p === period) {
                    btn.className = 'px-4 py-2 rounded font-bold bg-blue-900 text-white';
                } else {
                    btn.className = 'px-4 py-2 rounded font-bold bg-gray-200 text-gray-700 hover:bg-gray-300';
                }
            });
            
            // Show/hide custom date range
            const customDateRange = document.getElementById('customDateRange');
            if (period === 'custom') {
                customDateRange.classList.remove('hidden');
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                document.getElementById('customStartDate').value = weekAgo;
                document.getElementById('customEndDate').value = today;
            } else {
                customDateRange.classList.add('hidden');
                fetchAnalyticsByPeriod(period);
            }
        }

        // Apply custom date range
        function applyCustomDateRange() {
            const startDate = document.getElementById('customStartDate').value;
            const endDate = document.getElementById('customEndDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date.');
                return;
            }
            
            fetchAnalyticsByDateRange(startDate, endDate);
        }

        // Fetch analytics based on period
        async function fetchAnalyticsByPeriod(period) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_reports.php?period=${period}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    displayAnalytics(result.data, period, result.data.date_range);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    console.error('Analytics API Error:', result);
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        }

        // Fetch analytics by custom date range
        async function fetchAnalyticsByDateRange(startDate, endDate) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_reports.php?start=${startDate}&end=${endDate}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    displayAnalytics(result.data, 'custom', result.data.date_range);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                } else {
                    const errorMsg = result.error || result.message || 'Unknown error';
                    console.error('Analytics API Error:', result);
                }
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        }

        // Helper function to capitalize words properly
        function capitalizeWords(str) {
            if (!str) return 'N/A';
            return str.toLowerCase().split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Display analytics data with Chart.js
        function displayAnalytics(data, period, dateRange) {
            // Update summary cards
            document.getElementById('analyticsTotalOrders').textContent = data.summary.total_orders || 0;
            document.getElementById('analyticsTotalCompleted').textContent = data.summary.completed_orders || 0;
            
            // Fix top item display to handle empty data
            if (data.top_items && data.top_items.length > 0 && data.top_items[0].item_ordered) {
                document.getElementById('analyticsTopItem').textContent = capitalizeWords(data.top_items[0].item_ordered);
            } else {
                document.getElementById('analyticsTopItem').textContent = 'N/A';
            }

            // Update date range displays
            const dateRangeText = dateRange ? `${dateRange.start} to ${dateRange.end}` : 'Loading...';
            document.getElementById('statusDateRange').textContent = dateRangeText;
            document.getElementById('productDateRange').textContent = dateRangeText;

            // Populate order status breakdown table
            const statusBody = document.getElementById('analyticsStatusBody');
            statusBody.innerHTML = '';
            if (data.status_breakdown && data.status_breakdown.length > 0) {
                const totalOrders = data.summary.total_orders || 1;
                data.status_breakdown.forEach(status => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const percentage = ((status.count / totalOrders) * 100).toFixed(1);
                    const statusColor = getStatusColor(status.status);
                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold">
                                ${capitalizeWords(status.status)}
                            </span>
                        </td>
                        <td class="px-6 py-4 font-bold">${status.count}</td>
                        <td class="px-6 py-4">${percentage}%</td>
                    `;
                    statusBody.appendChild(row);
                });
            } else {
                statusBody.innerHTML = '<tr><td colspan="3" class="px-6 py-8 text-center text-gray-500">No status data found for this period.</td></tr>';
            }

            // Populate product quantities table
            const productQtyBody = document.getElementById('analyticsProductQtyBody');
            productQtyBody.innerHTML = '';
            if (data.product_quantities && data.product_quantities.length > 0) {
                data.product_quantities.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4">${capitalizeWords(product.item_name)}</td>
                        <td class="px-6 py-4 font-bold text-blue-600">${product.quantity_sold}</td>
                    `;
                    productQtyBody.appendChild(row);
                });
            } else {
                productQtyBody.innerHTML = '<tr><td colspan="2" class="px-6 py-8 text-center text-gray-500">No product data found for this period.</td></tr>';
            }

            // Populate top items with enhanced card layout
            const topItemsBody = document.getElementById('analyticsTopItemsBody');
            topItemsBody.innerHTML = '';
            if (!data.top_items || data.top_items.length === 0) {
                topItemsBody.innerHTML = '<div class="text-center py-8 text-gray-500">No item data found for this period.</div>';
            } else {
                // Get max value for calculating bar widths
                const maxTotal = Math.max(...data.top_items.map(item => item.total));
                
                data.top_items.forEach((item, index) => {
                    const percentage = (item.total / maxTotal) * 100;
                    const rankColors = [
                        'bg-gradient-to-r from-yellow-400 to-orange-500',
                        'bg-gradient-to-r from-gray-300 to-gray-400',
                        'bg-gradient-to-r from-orange-300 to-orange-400',
                        'bg-gradient-to-r from-blue-400 to-blue-500'
                    ];
                    const barColor = index < 3 ? rankColors[index] : rankColors[3];
                    const rankBadgeColors = [
                        'bg-yellow-500 text-white',
                        'bg-gray-400 text-white',
                        'bg-orange-400 text-white',
                        'bg-blue-500 text-white'
                    ];
                    const badgeColor = index < 3 ? rankBadgeColors[index] : rankBadgeColors[3];
                    
                    const card = document.createElement('div');
                    card.className = 'bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="${badgeColor} px-3 py-1 rounded-full text-sm font-bold">
                                    #${index + 1}
                                </span>
                                <div>
                                    <h4 class="font-bold text-gray-900">${capitalizeWords(item.item_ordered)}</h4>
                                    <p class="text-sm text-gray-500">${item.total} orders</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-blue-900">${item.total}</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                            <div class="${barColor} h-3 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    topItemsBody.appendChild(card);
                });
            }

            // Render chart
            renderOrdersChart(data.timeline || [], period);
        }

        // Render Chart.js chart
        function renderOrdersChart(timeline, period) {
            const ctx = document.getElementById('ordersChart');
            
            // Destroy existing chart if it exists
            if (ordersChart) {
                ordersChart.destroy();
            }

            // Prepare data
            const labels = timeline.map(t => t.label || t.date);
            const ordersData = timeline.map(t => t.total_orders || 0);
            const completedData = timeline.map(t => t.completed_orders || 0);

            // Get descriptive title
            const periodTitles = {
                'daily': 'Today\'s Orders by Hour',
                'weekly': 'Orders by Week',
                'monthly': 'Orders by Month',
                'yearly': 'Orders by Year',
                'custom': 'Orders Trend'
            };

            // Create chart
            ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Orders',
                            data: ordersData,
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Completed Orders',
                            data: completedData,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: periodTitles[period] || 'Orders Trend',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // Initialize queue table
        function displayQueueTable(filteredOrders = null) {
            const tbody = document.getElementById('queueTableBody');
            tbody.innerHTML = '';

            const dataToDisplay = filteredOrders || ordersData;

            if (dataToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No orders found</td></tr>';
                return;
            }
            
            dataToDisplay.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                const createdTime = new Date(order.created_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                
                // Format items with quantity
                const items = order.item_ordered ? order.item_ordered.split(',').map(i => i.trim()) : [];
                const itemCount = items.length;
                const itemDisplay = itemCount > 1 ? `<strong>${itemCount} items:</strong> ${order.item_ordered}` : order.item_ordered;
                
                row.innerHTML = `
                    <td class="px-6 py-4">${order.queue_number}</td>
                    <td class="px-6 py-4">${order.student_id}</td>
                    <td class="px-6 py-4">${itemDisplay}</td>
                    <td class="px-6 py-4">${createdTime}</td>
                    <td class="px-6 py-4">
                        <span class="${getStatusColor(order.order_status)} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                            ${order.order_status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateOrderStatus(${order.order_id}, this.value)" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="pending" ${order.order_status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="processing" ${order.order_status === 'processing' ? 'selected' : ''}>Processing</option>
                            <option value="ready" ${order.order_status === 'ready' ? 'selected' : ''}>Ready for Pick Up</option>
                            <option value="completed" ${order.order_status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${order.order_status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-orange-500',
                'processing': 'bg-blue-500',
                'ready': 'bg-indigo-600',
                'completed': 'bg-green-600',
                'cancelled': 'bg-red-600'
            };
            return colors[status] || 'bg-gray-500';
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: orderId,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store queue number before fetchOrders clears currentQueueOrder
                    const queueNumber = currentQueueOrder ? currentQueueOrder.queue_number : 'N/A';
                    
                    // Refresh orders to show updated status
                    await fetchOrders();
                    
                    // Show success message
                    const statusLabels = {
                        'processing': 'started processing',
                        'ready': 'marked as ready',
                        'completed': 'completed',
                        'cancelled': 'cancelled'
                    };
                    
                    showNotification(`Order ${queueNumber} ${statusLabels[newStatus]}!`, 'success');
                } else {
                    alert(result.message || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('An error occurred while updating the order status');
            }
        }

        function updateCounts(stats) {
            if (stats) {
                document.getElementById('pendingCount').textContent = stats.pending || 0;
                document.getElementById('readyCount').textContent = stats.ready || 0;
                document.getElementById('doneCount').textContent = stats.completed || 0;
            } else {
                // Fallback to counting from ordersData
                const pending = ordersData.filter(o => o.order_status === 'pending').length;
                const ready = ordersData.filter(o => o.order_status === 'ready').length;
                const completed = ordersData.filter(o => o.order_status === 'completed').length;
                
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('readyCount').textContent = ready;
                document.getElementById('doneCount').textContent = completed;
            }
        }

        // Connection status indicator
        function updateConnectionStatus(isConnected) {
            const statusDot = document.getElementById('connectionStatus');
            if (isConnected) {
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
            } else {
                statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            // Refresh every 5 seconds
            refreshInterval = setInterval(() => {
                fetchOrders();
            }, 5000);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Queue Management Functions
        function updateCurrentQueue() {
            const pendingOrders = ordersData.filter(o => o.order_status === 'pending' || o.order_status === 'processing');
            
            // --- ADDED: Get references to the button containers ---
            const startButtonDiv = document.getElementById('queue-action-start');
            const processButtonsDiv = document.getElementById('queue-action-process');

            if (pendingOrders.length === 0) {
                // No orders in queue
                document.getElementById('currentOrderCard').classList.add('hidden');
                document.getElementById('noQueueMessage').classList.remove('hidden');
                currentQueueOrder = null;

                // --- ADDED: Hide both button containers if no order ---
                startButtonDiv.classList.add('hidden');
                processButtonsDiv.classList.add('hidden');

                document.getElementById('queuePosition').textContent = 'Queue: 0 of 0';
                return;
            }
            
            // Show first pending order
            document.getElementById('currentOrderCard').classList.remove('hidden');
            document.getElementById('noQueueMessage').classList.add('hidden');
            
            currentQueueOrder = pendingOrders[0];

            // ... (all the code that updates text content, from line 536 to 563) ...
            document.getElementById('currentStudentProgram').textContent = `${currentQueueOrder.program} - ${currentQueueOrder.year_level} ${currentQueueOrder.section}` || 'N/A';
            
            // --- ADDED: This block controls which buttons are visible ---
            if (currentQueueOrder.order_status === 'pending') {
                startButtonDiv.classList.remove('hidden');
                processButtonsDiv.classList.add('hidden');
            } else if (currentQueueOrder.order_status === 'processing') {
                startButtonDiv.classList.add('hidden');
                processButtonsDiv.classList.remove('hidden');
            }
            // --- END OF ADDED BLOCK ---
            
            // Update queue position
            document.getElementById('queuePosition').textContent = `Queue: 1 of ${pendingOrders.length}`;
            
            // Update order information
            document.getElementById('currentQueueNumber').textContent = currentQueueOrder.queue_number;
            document.getElementById('currentItemOrdered').textContent = currentQueueOrder.item_ordered;
            const createdTime = new Date(currentQueueOrder.created_at).toLocaleString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('currentTimePlaced').textContent = createdTime;
            document.getElementById('currentWaitTime').textContent = currentQueueOrder.estimated_wait_time;
            
            // Update student information
            document.getElementById('currentStudentId').textContent = currentQueueOrder.student_id;
            document.getElementById('currentStudentName').textContent = `${currentQueueOrder.first_name} ${currentQueueOrder.last_name}`;
            document.getElementById('currentStudentEmail').textContent = currentQueueOrder.email;
            document.getElementById('currentStudentProgram').textContent = `${currentQueueOrder.program} - ${currentQueueOrder.year_level} ${currentQueueOrder.section}` || 'N/A';
        }
        
        async function processQueue(newStatus) {
            if (!currentQueueOrder) {
                alert('No order in queue to process');
                return;
            }
            
            const confirmMessages = {
                'processing': 'Start processing this order?',
                'ready': 'Mark this order as ready for pickup?',
                'completed': 'Mark this order as completed?',
                'cancelled': 'Cancel this order? This action cannot be undone.'
            };
            
            if (!confirm(confirmMessages[newStatus])) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_orders.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        order_id: currentQueueOrder.order_id,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store queue number before fetchOrders clears currentQueueOrder
                    const queueNumber = currentQueueOrder ? currentQueueOrder.queue_number : 'N/A';
                    
                    // Refresh orders to show updated status
                    await fetchOrders();
                    
                    // Show success message
                    const statusLabels = {
                        'processing': 'started processing',
                        'ready': 'marked as ready',
                        'completed': 'completed',
                        'cancelled': 'cancelled'
                    };
                    
                    showNotification(`Order ${queueNumber} ${statusLabels[newStatus]}!`, 'success');
                } else {
                    alert(result.message || 'Failed to update order status');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('An error occurred while updating the order status');
            }
        }
        
        function skipQueue() {
            if (!currentQueueOrder) {
                alert('No order in queue to skip');
                return;
            }
            
            if (!confirm('Skip this order? It will remain in the queue but move to the end.')) {
                return;
            }
            
            // Move current order to end of pending orders
            const currentIndex = ordersData.findIndex(o => o.order_id === currentQueueOrder.order_id);
            if (currentIndex !== -1) {
                const skippedOrder = ordersData.splice(currentIndex, 1)[0];
                ordersData.push(skippedOrder);
                updateCurrentQueue();
                showNotification(`Order ${currentQueueOrder.queue_number} skipped`, 'info');
            }
        }
        
        function showNotification(message, type = 'success') {
            const colors = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-8 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 animate-fade-in`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Fetch email logs from API
        async function fetchEmailLogs() {
            try {
                const type = document.getElementById('filterEmailType').value;
                const status = document.getElementById('filterEmailStatus').value;
                const search = document.getElementById('searchEmail').value;
                
                const response = await fetch(`${API_BASE}/admin/email_logs.php?type=${type}&status=${status}&search=${search}&archived=${showingArchivedLogs}&limit=100`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayEmailLogs(result.data.logs);
                    updateEmailStats(result.data.stats);
                } else if (response.status === 401) {
                    sessionStorage.clear();
                    window.location.href = 'admin_login.html';
                }
            } catch (error) {
                console.error('Error fetching email logs:', error);
            }
            selectedLogIds = [];
            updateSelectedCount();
        }

        // Display email logs in table
        function displayEmailLogs(logs) {
            const tbody = document.getElementById('emailLogsTableBody');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No email logs found</td></tr>';
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = log.status === 'sent' ? 'bg-green-500' : 'bg-red-500';
                const sentTime = new Date(log.sent_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const typeColors = {
                    'otp': 'bg-blue-100 text-blue-800',
                    'receipt': 'bg-green-100 text-green-800',
                    'status_update': 'bg-purple-100 text-purple-800'
                };
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <input type="checkbox" class="log-checkbox w-4 h-4" data-log-id="${log.log_id}" onchange="handleLogCheckbox()">
                    </td>
                    <td class="px-6 py-4">${log.log_id || 'N/A'}</td>
                    <td class="px-6 py-4">${log.recipient_email || 'N/A'}</td>
                    <td class="px-6 py-4">
                        <span class="${typeColors[log.email_type] || 'bg-gray-100 text-gray-800'} px-2 py-1 rounded text-xs font-bold uppercase">
                            ${(log.email_type || '').replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4">${log.subject || 'N/A'}</td>
                    <td class="px-6 py-4">${sentTime}</td>
                    <td class="px-6 py-4">
                        <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold uppercase">
                            ${log.status || 'N/A'}
                        </span>
                    </td>
                `;
                
                // Add error message tooltip if failed
                if (log.status === 'failed' && log.error_message) {
                    row.title = `Error: ${log.error_message}`;
                    row.style.cursor = 'help';
                }
                
                tbody.appendChild(row);
            });
        }

        // Update email statistics
        function updateEmailStats(stats) {
            document.getElementById('totalEmails').textContent = stats.total || 0;
            document.getElementById('sentEmails').textContent = stats.sent || 0;
            document.getElementById('failedEmails').textContent = stats.failed || 0;
            
            const successRate = stats.total > 0 ? ((stats.sent / stats.total) * 100).toFixed(1) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Toggle archived view
        function toggleArchivedView() {
            showingArchivedLogs = !showingArchivedLogs;
            const btn = document.getElementById('viewArchivedBtn');
            const title = document.getElementById('emailLogsTableTitle');
            const archiveBtn = document.getElementById('archiveLogsBtn');
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            const isSuperAdmin = adminData && adminData.role === 'super_admin';
            
            if (showingArchivedLogs) {
                btn.textContent = 'View Active';
                btn.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold';
                title.textContent = 'Archived Email Logs';
                // Hide archive button, show restore/delete for super admin only
                archiveBtn.classList.add('hidden');
                if (isSuperAdmin) {
                    document.getElementById('restoreLogsBtn').classList.remove('hidden');
                    document.getElementById('deleteLogsBtn').classList.remove('hidden');
                }
            } else {
                btn.textContent = 'View Archived';
                btn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded font-bold';
                title.textContent = 'Email History';
                // Show archive button for all admins
                archiveBtn.classList.remove('hidden');
                document.getElementById('restoreLogsBtn').classList.add('hidden');
                document.getElementById('deleteLogsBtn').classList.add('hidden');
            }
            fetchEmailLogs();
        }

        // Handle individual checkbox selection
        function handleLogCheckbox() {
            selectedLogIds = Array.from(document.querySelectorAll('.log-checkbox:checked'))
                .map(cb => cb.dataset.logId);
            updateSelectedCount();
        }

        // Toggle select all checkboxes
        function toggleSelectAllLogs() {
            const selectAll = document.getElementById('selectAllLogs').checked;
            document.querySelectorAll('.log-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
            handleLogCheckbox();
        }

        // Update selected count display
        function updateSelectedCount() {
            const count = selectedLogIds.length;
            const countEl = document.getElementById('selectedCount');
            const actionsEl = document.getElementById('emailLogActions');
            
            if (count > 0) {
                countEl.textContent = `${count} selected`;
                actionsEl.classList.remove('hidden');
            } else {
                countEl.textContent = '';
                actionsEl.classList.add('hidden');
            }
        }

        // Archive selected logs
        async function archiveSelectedLogs() {
            if (selectedLogIds.length === 0) {
                alert('Please select logs to archive');
                return;
            }
            
            if (!confirm(`Archive ${selectedLogIds.length} log(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'archive',
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Logs archived successfully', 'success');
                    fetchEmailLogs();
                } else {
                    alert(result.message || 'Failed to archive logs');
                }
            } catch (error) {
                console.error('Error archiving logs:', error);
                alert('Error archiving logs');
            }
        }

        // Restore selected logs (super admin only)
        async function restoreSelectedLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.role !== 'super_admin') {
                alert('Only super admin can restore archived logs');
                return;
            }
            
            if (selectedLogIds.length === 0) {
                alert('Please select logs to restore');
                return;
            }
            
            if (!confirm(`Restore ${selectedLogIds.length} log(s)?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'restore',
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Logs restored successfully', 'success');
                    fetchEmailLogs();
                } else {
                    alert(result.message || 'Failed to restore logs');
                }
            } catch (error) {
                console.error('Error restoring logs:', error);
                alert('Error restoring logs');
            }
        }

        // Delete selected logs permanently (super admin only)
        async function deleteSelectedLogs() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData'));
            if (!adminData || adminData.role !== 'super_admin') {
                alert('Only super admin can permanently delete logs');
                return;
            }
            
            if (selectedLogIds.length === 0) {
                alert('Please select logs to delete');
                return;
            }
            
            if (!confirm(`PERMANENTLY DELETE ${selectedLogIds.length} log(s)? This action CANNOT be undone!`)) {
                return;
            }
            
            // Second confirmation for deletion
            if (!confirm('Are you absolutely sure? This will permanently remove these logs from the database.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/email_logs.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        log_ids: selectedLogIds
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Logs permanently deleted', 'success');
                    fetchEmailLogs();
                } else {
                    alert(result.message || 'Failed to delete logs');
                }
            } catch (error) {
                console.error('Error deleting logs:', error);
                alert('Error deleting logs');
            }
        }

        // Fetch inventory stock status
        async function fetchInventoryStatusAdmin() {
            try {
                const response = await fetch(`${API_BASE}/inventory_status.php`);
                const result = await response.json();
                
                if (result.success) {
                    inventoryStock = result.data.stock_status;
                }
            } catch (error) {
                console.error('Error fetching inventory status:', error);
            }
        }

        // Initialize data on page load
        async function initializeDashboard() {
            try {
                const adminData = JSON.parse(sessionStorage.getItem('adminData'));
                if (adminData && adminData.full_name) {
                    // Set name in top bar (first name only)
                    document.getElementById('adminName').textContent = adminData.full_name.split(' ')[0];
                    // Set full name in sidebar
                    document.getElementById('sidebarAdminName').textContent = adminData.full_name;
                }
                
                await fetchInventoryStatusAdmin();
                await fetchOrders();
                await fetchStudents();
                await fetchEmailLogs();
                updateCurrentQueue();
                startAutoRefresh();
            } catch (error) {
                console.error('Dashboard init error:', error);
            }
        }

        // Check if super admin and show management tab
        function checkSuperAdminAccess() {
            const adminData = JSON.parse(sessionStorage.getItem('adminData') || '{}');
            if (adminData && adminData.is_super_admin == 1) {
                document.getElementById('tab-admin-management').classList.remove('hidden');
            }
        }

        // Fetch admin accounts
        async function fetchAdminAccounts() {
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayAdminAccounts(result.data.admins);
                } else if (response.status === 403) {
                    alert('Access denied. Super admin only.');
                }
            } catch (error) {
                console.error('Error fetching admin accounts:', error);
            }
        }

        // Display admin accounts in table
        function displayAdminAccounts(admins) {
            const tbody = document.getElementById('adminAccountsTableBody');
            tbody.innerHTML = '';
            
            const currentAdminId = JSON.parse(sessionStorage.getItem('adminData') || '{}').admin_id;
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const roleColor = admin.is_super_admin == 1 ? 'bg-purple-500' : 'bg-blue-500';
                const roleText = admin.is_super_admin == 1 ? 'Super Admin' : 'Admin';
                
                const isCurrentUser = admin.admin_id == currentAdminId;
                
                row.innerHTML = `
                    <td class="px-6 py-4">${admin.admin_id}</td>
                    <td class="px-6 py-4">${admin.full_name} ${isCurrentUser ? '(You)' : ''}</td>
                    <td class="px-6 py-4">${admin.username}</td>
                    <td class="px-6 py-4">${admin.email}</td>
                    <td class="px-6 py-4">
                        <span class="${roleColor} text-white px-3 py-1 rounded text-xs font-bold">
                            ${roleText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick='editAdmin(${JSON.stringify(admin)})' class="border-2 border-blue-900 text-blue-900 hover:bg-gray-100 px-4 py-1 rounded text-sm font-bold">
                                Edit
                            </button>
                            ${!isCurrentUser ? `
                            <button onclick="deleteAdmin(${admin.admin_id}, '${admin.full_name}')" class="border-2 border-red-600 text-red-600 hover:bg-red-50 px-4 py-1 rounded text-sm font-bold">
                                Delete
                            </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Create admin form handler
        document.getElementById('createAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('createAdminMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            messageEl.textContent = '';
            
            const formData = {
                full_name: document.getElementById('newAdminFullName').value,
                username: document.getElementById('newAdminUsername').value,
                email: document.getElementById('newAdminEmail').value,
                password: document.getElementById('newAdminPassword').value,
                is_super_admin: document.getElementById('newAdminSuperAdmin').checked ? 1 : 0
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Admin account created successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    e.target.reset();
                    await fetchAdminAccounts();
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error creating admin:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Admin Account';
            }
        });

        // Edit admin
        function editAdmin(admin) {
            document.getElementById('editAdminId').value = admin.admin_id;
            document.getElementById('editAdminFullName').value = admin.full_name;
            document.getElementById('editAdminUsername').value = admin.username;
            document.getElementById('editAdminEmail').value = admin.email;
            document.getElementById('editAdminPassword').value = '';
            document.getElementById('editAdminSuperAdmin').checked = admin.is_super_admin == 1;
            
            const modal = document.getElementById('editAdminModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditModal() {
            const modal = document.getElementById('editAdminModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editAdminMessage').textContent = '';
        }

        // Edit admin form handler
        document.getElementById('editAdminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('editAdminMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            messageEl.textContent = '';
            
            const formData = {
                admin_id: document.getElementById('editAdminId').value,
                full_name: document.getElementById('editAdminFullName').value,
                username: document.getElementById('editAdminUsername').value,
                email: document.getElementById('editAdminEmail').value,
                is_super_admin: document.getElementById('editAdminSuperAdmin').checked ? 1 : 0
            };
            
            const password = document.getElementById('editAdminPassword').value;
            if (password) {
                formData.password = password;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Admin account updated successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    await fetchAdminAccounts();
                    setTimeout(closeEditModal, 1500);
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error updating admin:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update';
            }
        });

        // Delete admin
        async function deleteAdmin(adminId, fullName) {
            if (!confirm(`Are you sure you want to delete admin account: ${fullName}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin_management.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ admin_id: adminId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Admin account deleted successfully', 'success');
                    await fetchAdminAccounts();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error deleting admin:', error);
                alert('A connection error occurred.');
            }
        }

        // Service Management Functions
        async function fetchServices() {
            try {
                const response = await fetch(`${API_BASE}/services.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayServices(result.data.services);
                }
            } catch (error) {
                console.error('Error fetching services:', error);
            }
        }

        function displayServices(services) {
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';
            
            if (services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No services found</td></tr>';
                return;
            }
            
            services.forEach(service => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const statusColor = service.is_active == 1 ? 'bg-green-500' : 'bg-gray-500';
                const statusText = service.is_active == 1 ? 'Active' : 'Inactive';
                
                row.innerHTML = `
                    <td class="px-6 py-4">${service.service_id}</td>
                    <td class="px-6 py-4">${service.service_name}</td>
                    <td class="px-6 py-4">${service.estimated_time}</td>
                    <td class="px-6 py-4">
                        <span class="${statusColor} text-white px-3 py-1 rounded text-xs font-bold">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2">
                            <button onclick='editService(${JSON.stringify(service)})' class="border-2 border-blue-900 text-blue-900 hover:bg-gray-100 px-4 py-1 rounded text-sm font-bold">
                                Edit
                            </button>
                            <button onclick="deleteService(${service.service_id}, '${service.service_name}')" class="border-2 border-red-600 text-red-600 hover:bg-red-50 px-4 py-1 rounded text-sm font-bold">
                                Delete
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Add service form handler
        document.getElementById('addServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('addServiceMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            messageEl.textContent = '';
            
            const formData = {
                service_name: document.getElementById('newServiceName').value,
                estimated_time: parseInt(document.getElementById('newServiceTime').value)
            };
            
            try {
                const response = await fetch(`${API_BASE}/services.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Service added successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    e.target.reset();
                    await fetchServices();
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error adding service:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Service';
            }
        });

        function editService(service) {
            document.getElementById('editServiceId').value = service.service_id;
            document.getElementById('editServiceName').value = service.service_name;
            document.getElementById('editServiceTime').value = service.estimated_time;
            document.getElementById('editServiceActive').checked = service.is_active == 1;
            
            const modal = document.getElementById('editServiceModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEditServiceModal() {
            const modal = document.getElementById('editServiceModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('editServiceMessage').textContent = '';
        }

        // Edit service form handler
        document.getElementById('editServiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('editServiceMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            messageEl.textContent = '';
            
            const formData = {
                service_id: document.getElementById('editServiceId').value,
                service_name: document.getElementById('editServiceName').value,
                estimated_time: parseInt(document.getElementById('editServiceTime').value),
                is_active: document.getElementById('editServiceActive').checked ? 1 : 0
            };
            
            try {
                const response = await fetch(`${API_BASE}/services.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Service updated successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    await fetchServices();
                    setTimeout(closeEditServiceModal, 1500);
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error updating service:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update';
            }
        });

        async function deleteService(serviceId, serviceName) {
            if (!confirm(`Are you sure you want to delete service: ${serviceName}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/services.php`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ service_id: serviceId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Service deleted successfully', 'success');
                    await fetchServices();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error deleting service:', error);
                alert('A connection error occurred.');
            }
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });

        // Inventory Management Functions
        // Add inventory item form handler
        document.getElementById('addInventoryItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const messageEl = document.getElementById('addInventoryMessage');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            messageEl.textContent = '';
            
            const formData = {
                item_name: document.getElementById('newInventoryItemName').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/inventory.php`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    messageEl.textContent = 'Item added successfully!';
                    messageEl.className = 'mt-4 text-sm font-medium text-green-600';
                    e.target.reset();
                    await fetchInventoryItems();
                } else {
                    messageEl.textContent = `Error: ${result.message}`;
                    messageEl.className = 'mt-4 text-sm font-medium text-red-600';
                }
            } catch (error) {
                console.error('Error adding item:', error);
                messageEl.textContent = 'A connection error occurred.';
                messageEl.className = 'mt-4 text-sm font-medium text-red-600';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Item';
            }
        });

        async function fetchInventoryItems() {
            try {
                const response = await fetch(`${API_BASE}/admin/inventory.php`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displayInventoryItems(result.data.items);
                }
            } catch (error) {
                console.error('Error fetching inventory:', error);
            }
        }

        function displayInventoryItems(items) {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center"><div class="text-gray-400"><svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg><p class="text-lg font-semibold">No items in inventory</p><p class="text-sm">Add your first item using the form above</p></div></td></tr>';
                return;
            }
            
            items.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-blue-50 transition-colors';
                
                const statusColor = item.is_in_stock == 1 ? 'bg-green-500' : 'bg-red-500';
                const statusText = item.is_in_stock == 1 ? 'In Stock' : 'Out of Stock';
                const statusIcon = item.is_in_stock == 1 ? '✓' : '✕';
                
                const btn = item.is_in_stock == 1 ? 
                    'bg-red-50 border-red-600 text-red-600 hover:bg-red-600 hover:text-white' : 
                    'bg-green-50 border-green-600 text-green-600 hover:bg-green-600 hover:text-white';
                const btnText = item.is_in_stock == 1 ? 'Mark Out of Stock' : 'Mark In Stock';
                
                const updatedAt = item.updated_at ? new Date(item.updated_at).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Never';
                
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <span class="bg-blue-100 text-blue-900 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                                ${index + 1}
                            </span>
                            <span class="font-bold text-gray-900">${item.item_name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="${statusColor} text-white px-4 py-2 rounded-full text-xs font-bold inline-flex items-center gap-2">
                            ${statusIcon} ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${updatedAt}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="toggleStockStatus(${item.item_id}, ${item.is_in_stock})" 
                                class="border-2 ${btn} px-5 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105">
                            ${btnText}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function toggleStockStatus(itemId, currentStatus) {
            const newStatus = currentStatus == 1 ? 0 : 1;
            const actionText = newStatus == 1 ? 'mark this item as IN STOCK' : 'mark this item as OUT OF STOCK';
            
            if (!confirm(`Are you sure you want to ${actionText}?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/inventory.php`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: itemId,
                        is_in_stock: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Stock status updated successfully', 'success');
                    await fetchInventoryItems();
                } else {
                    alert(`Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error updating stock status:', error);
                alert('A connection error occurred.');
            }
        }

        // Start the dashboard
        checkSuperAdminAccess(); // Show admin management tab for super admin
        initializeDashboard();
        fetchServices(); // Load services on init
        fetchInventoryItems(); // Load inventory on init
    </script>
</body>
</html>