<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - UMak COOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../js/notifications.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Q-Mak Student Hub</h1>
                    <p id="welcomeText" class="text-blue-200 text-sm">Loading...</p>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="logout()" class="px-4 py-2 bg-blue-800 hover:bg-blue-700 rounded-lg font-semibold transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <button onclick="showQuickOrder()" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow border-l-4 border-green-500">
                <div class="text-green-600 mb-2">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <h3 class="font-bold text-lg text-gray-800">Create New Order</h3>
                <p class="text-gray-600 text-sm">Place a new order quickly</p>
            </button>

            <button onclick="showOrderHistory()" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow border-l-4 border-blue-500">
                <div class="text-blue-600 mb-2">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                </div>
                <h3 class="font-bold text-lg text-gray-800">Order History</h3>
                <p class="text-gray-600 text-sm">View your past orders</p>
            </button>

            <button onclick="showProfile()" class="bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-shadow border-l-4 border-purple-500">
                <div class="text-purple-600 mb-2">
                    <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h3 class="font-bold text-lg text-gray-800">My Profile</h3>
                <p class="text-gray-600 text-sm">View and edit your information</p>
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="contentArea" class="bg-white rounded-xl shadow-md p-6">
            <!-- Welcome Screen (Default) -->
            <div id="welcomeScreen">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to Your Dashboard</h2>
                <p class="text-gray-600 mb-4">Select an action above to get started.</p>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
                    <h3 class="font-semibold text-blue-900 mb-2">Quick Tips:</h3>
                    <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
                        <li>Create orders faster - your information is already saved!</li>
                        <li>Track all your orders in one place</li>
                        <li>Get email notifications for order updates</li>
                        <li>View QR codes for active orders</li>
                    </ul>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profileScreen" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">My Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Personal Information</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-600">Student ID</label>
                                <p id="profileStudentId" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Full Name</label>
                                <p id="profileName" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Email</label>
                                <p id="profileEmail" class="font-semibold text-gray-800">-</p>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3">Academic Information</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-sm text-gray-600">College</label>
                                <p id="profileCollege" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Program</label>
                                <p id="profileProgram" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Year Level</label>
                                <p id="profileYear" class="font-semibold text-gray-800">-</p>
                            </div>
                            <div>
                                <label class="text-sm text-gray-600">Section</label>
                                <p id="profileSection" class="font-semibold text-gray-800">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Order Screen -->
            <div id="quickOrderScreen" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Order</h2>
                <form id="quickOrderForm" class="space-y-6">
                    <!-- Quantity Selection -->
                    <div class="bg-blue-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                            </svg>
                            Order Quantity
                        </h4>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">How many items would you like to order? *</label>
                        <div class="grid grid-cols-5 gap-3">
                            <button type="button" onclick="selectQuantity(1)" id="qty1Btn" 
                                    class="py-3 px-4 border-2 border-blue-900 bg-blue-900 text-white rounded-lg font-bold hover:bg-blue-800 transition-all">
                                1
                            </button>
                            <button type="button" onclick="selectQuantity(2)" id="qty2Btn" 
                                    class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                                2
                            </button>
                            <button type="button" onclick="selectQuantity(3)" id="qty3Btn" 
                                    class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                                3
                            </button>
                            <button type="button" onclick="selectQuantity(4)" id="qty4Btn" 
                                    class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                                4
                            </button>
                            <button type="button" onclick="selectQuantity(5)" id="qty5Btn" 
                                    class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                                5
                            </button>
                        </div>
                    </div>

                    <!-- Item Selection -->
                    <div class="bg-green-50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-blue-900 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            Item Selection
                        </h4>
                        <div class="space-y-4">
                            <!-- Item 1 -->
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item <span id="item1Label">1</span> *</label>
                                <select id="orderItem1" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Item</option>
                                    <option value="id lace">ID Lace</option>
                                    <option value="uniform">School Uniform</option>
                                    <option value="PE uniform">PE Uniform</option>
                                    <option value="nstp shirt">NSTP Shirt</option>
                                    <option value="patch">School Patch</option>
                                    <option value="book">Book/Manual</option>
                                    <option value="supplies">School Supplies</option>
                                    <option value="merchandise">UMak Merchandise</option>
                                </select>
                            </div>

                            <!-- Item 2 (Hidden by default) -->
                            <div id="item2Container" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item 2 *</label>
                                <select id="orderItem2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Item</option>
                                    <option value="id lace">ID Lace</option>
                                    <option value="uniform">School Uniform</option>
                                    <option value="PE uniform">PE Uniform</option>
                                    <option value="nstp shirt">NSTP Shirt</option>
                                    <option value="patch">School Patch</option>
                                    <option value="book">Book/Manual</option>
                                    <option value="supplies">School Supplies</option>
                                    <option value="merchandise">UMak Merchandise</option>
                                </select>
                            </div>

                            <!-- Item 3 -->
                            <div id="item3Container" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item 3 *</label>
                                <select id="orderItem3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Item</option>
                                    <option value="id lace">ID Lace</option>
                                    <option value="uniform">School Uniform</option>
                                    <option value="PE uniform">PE Uniform</option>
                                    <option value="nstp shirt">NSTP Shirt</option>
                                    <option value="patch">School Patch</option>
                                    <option value="book">Book/Manual</option>
                                    <option value="supplies">School Supplies</option>
                                    <option value="merchandise">UMak Merchandise</option>
                                </select>
                            </div>

                            <!-- Item 4 -->
                            <div id="item4Container" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item 4 *</label>
                                <select id="orderItem4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Item</option>
                                    <option value="id lace">ID Lace</option>
                                    <option value="uniform">School Uniform</option>
                                    <option value="PE uniform">PE Uniform</option>
                                    <option value="nstp shirt">NSTP Shirt</option>
                                    <option value="patch">School Patch</option>
                                    <option value="book">Book/Manual</option>
                                    <option value="supplies">School Supplies</option>
                                    <option value="merchandise">UMak Merchandise</option>
                                </select>
                            </div>

                            <!-- Item 5 -->
                            <div id="item5Container" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item 5 *</label>
                                <select id="orderItem5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Item</option>
                                    <option value="id lace">ID Lace</option>
                                    <option value="uniform">School Uniform</option>
                                    <option value="PE uniform">PE Uniform</option>
                                    <option value="nstp shirt">NSTP Shirt</option>
                                    <option value="patch">School Patch</option>
                                    <option value="book">Book/Manual</option>
                                    <option value="supplies">School Supplies</option>
                                    <option value="merchandise">UMak Merchandise</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Information Note -->
                    <div class="bg-orange-50 rounded-xl p-6">
                        <div class="flex gap-3">
                            <svg class="w-6 h-6 text-orange-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h4 class="font-semibold text-orange-900 mb-1">Additional Details</h4>
                                <p class="text-sm text-orange-800">You can provide specific details (size, color, etc.) directly at the COOP when picking up your order.</p>
                                <p class="text-xs text-orange-700 mt-2" id="orderPreview">Your student information will be automatically attached.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitOrderBtn"
                            class="w-full bg-blue-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-800 transition-all hover:shadow-lg hover:scale-105 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Submit Order
                    </button>
                </form>
            </div>

            <!-- Order History Screen -->
            <div id="orderHistoryScreen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Order History</h2>
                    <button onclick="loadOrderHistory()" class="flex items-center gap-2 px-4 py-2 bg-blue-900 text-white rounded-lg hover:bg-blue-800 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
                <div id="ordersList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">Loading orders...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Result Modal -->
    <div id="orderResultModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full max-h-screen overflow-y-auto">
            <h2 class="text-2xl font-bold text-green-600 mb-4">✓ Order Placed Successfully!</h2>
            <div class="space-y-3 mb-6">
                <div>
                    <label class="text-sm text-gray-600">Queue Number</label>
                    <p id="resultQueueNumber" class="text-2xl font-bold text-blue-900">-</p>
                </div>
                <div>
                    <label class="text-sm text-gray-600">Item Ordered</label>
                    <p id="resultItem" class="font-semibold text-gray-800">-</p>
                </div>
            </div>

            <div id="qrCodeSection" class="text-center mb-6">
                <canvas id="orderQRCode" class="mx-auto border p-2 rounded-lg"></canvas>
                <p class="text-xs text-gray-500 mt-2">Show this QR code when picking up your order</p>
            </div>

            <button onclick="closeOrderResult()"
                    class="w-full bg-blue-900 text-white py-3 rounded-lg font-bold hover:bg-blue-800 transition-colors">
                Done
            </button>
        </div>
    </div>

    <script>
        const API_BASE = '../../php/api';
        let studentData = null;
        let inventoryStock = {};

        // Fetch inventory stock status
        async function fetchInventoryStatus() {
            try {
                const response = await fetch(`${API_BASE}/inventory_status.php`);
                const result = await response.json();
                
                if (result.success) {
                    inventoryStock = result.data.stock_status;
                    updateItemSelects();
                }
            } catch (error) {
                console.error('Error fetching inventory status:', error);
            }
        }

        // Update all item select dropdowns with stock status
        function updateItemSelects() {
            const selectIds = ['orderItem1', 'orderItem2', 'orderItem3', 'orderItem4', 'orderItem5'];
            
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Store original text for each option
                Array.from(select.options).forEach(option => {
                    if (!option.value) return; // Skip "Select Item" option
                    
                    // Store original text if not already stored
                    if (!option.dataset.originalText) {
                        option.dataset.originalText = option.textContent.trim();
                    }
                    
                    const itemName = option.dataset.originalText;
                    const isInStock = inventoryStock[itemName];
                    
                    if (isInStock === false) {
                        option.disabled = true;
                        option.textContent = itemName + ' (Out of Stock)';
                        option.style.color = '#999';
                        option.style.fontStyle = 'italic';
                        option.style.backgroundColor = '#f5f5f5';
                    } else {
                        option.disabled = false;
                        option.textContent = itemName;
                        option.style.color = '';
                        option.style.fontStyle = '';
                        option.style.backgroundColor = '';
                    }
                });
            });
        }

        // Check if logged in
        async function checkSession() {
            try {
                const response = await fetch(`${API_BASE}/student/student_session.php`);
                const result = await response.json();

                if (!result.logged_in) {
                    window.location.href = 'student_login.html';
                    return;
                }

                studentData = result.data;
                updateUI();
            } catch (error) {
                console.error('Session check error:', error);
                window.location.href = 'student_login.html';
            }
        }

        function updateUI() {
            if (!studentData) return;

            document.getElementById('welcomeText').textContent = `Welcome, ${studentData.first_name}!`;
            
            // Update profile
            document.getElementById('profileStudentId').textContent = studentData.student_id;
            document.getElementById('profileName').textContent = 
                `${studentData.first_name} ${studentData.middle_initial ? studentData.middle_initial + '. ' : ''}${studentData.last_name}`;
            document.getElementById('profileEmail').textContent = studentData.email;
            document.getElementById('profileCollege').textContent = studentData.college;
            document.getElementById('profileProgram').textContent = studentData.program;
            document.getElementById('profileYear').textContent = studentData.year_level ? `${studentData.year_level}${getOrdinalSuffix(studentData.year_level)} Year` : 'Not specified';
            document.getElementById('profileSection').textContent = studentData.section || 'Not specified';

            // Update order preview
            document.getElementById('orderPreview').textContent = 
                `${studentData.first_name} ${studentData.last_name} | ${studentData.student_id} | ${studentData.email}`;
        }

        function getOrdinalSuffix(num) {
            const j = num % 10, k = num % 100;
            if (j == 1 && k != 11) return "st";
            if (j == 2 && k != 12) return "nd";
            if (j == 3 && k != 13) return "rd";
            return "th";
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('#contentArea > div').forEach(div => div.classList.add('hidden'));
            // Show selected screen
            document.getElementById(screenId).classList.remove('hidden');
        }

        let selectedQuantity = 1; // Track selected quantity

        function selectQuantity(qty) {
            selectedQuantity = qty;
            
            // Define classes
            const activeClass = 'py-3 px-4 border-2 border-blue-900 bg-blue-900 text-white rounded-lg font-bold hover:bg-blue-800 transition-all';
            const inactiveClass = 'py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all';
            
            // Update all quantity buttons
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`qty${i}Btn`);
                if (btn) {
                    btn.className = i === qty ? activeClass : inactiveClass;
                }
            }
            
            // Show/hide item containers based on quantity
            for (let i = 2; i <= 5; i++) {
                const container = document.getElementById(`item${i}Container`);
                const select = document.getElementById(`orderItem${i}`);
                if (container && select) {
                    if (i <= qty) {
                        container.classList.remove('hidden');
                        select.setAttribute('required', 'required');
                    } else {
                        container.classList.add('hidden');
                        select.removeAttribute('required');
                        select.value = ''; // Clear selection
                    }
                }
            }
        }

        function showQuickOrder() {
            showScreen('quickOrderScreen');
            selectQuantity(1); // Reset to 1 item
        }

        function showProfile() {
            showScreen('profileScreen');
        }

        async function showOrderHistory() {
            showScreen('orderHistoryScreen');
            await loadOrderHistory();
        }

        async function loadOrderHistory() {
            const ordersList = document.getElementById('ordersList');
            ordersList.innerHTML = '<div class="text-center text-gray-500 py-8">Loading orders...</div>';

            try {
                const response = await fetch(`${API_BASE}/admin/check_status.php?email=${encodeURIComponent(studentData.email)}`);
                const result = await response.json();

                if (result.success && result.data.orders.length > 0) {
                    const statusColors = {
                        'pending': 'bg-orange-100 text-orange-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'ready': 'bg-purple-100 text-purple-800',
                        'completed': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-red-100 text-red-800'
                    };

                    ordersList.innerHTML = result.data.orders.map(order => `
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <span class="text-lg font-bold text-blue-900">${order.queue_number}</span>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[order.order_status] || 'bg-gray-100 text-gray-800'}">
                                            ${order.order_status.toUpperCase()}
                                        </span>
                                    </div>
                                    <p class="font-semibold text-gray-800">${order.item_ordered}</p>
                                    <p class="text-sm text-gray-600">${new Date(order.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    ordersList.innerHTML = '<div class="text-center text-gray-500 py-8">No orders found</div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                ordersList.innerHTML = '<div class="text-center text-red-500 py-8">Failed to load orders</div>';
            }
        }

        document.getElementById('quickOrderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = document.getElementById('submitOrderBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            // Collect items based on quantity
            const items = [];
            for (let i = 1; i <= selectedQuantity; i++) {
                const itemValue = document.getElementById(`orderItem${i}`).value;
                if (itemValue) {
                    items.push(itemValue);
                }
            }
            const itemsOrdered = items.join(', ');

            const formData = {
                studentId: studentData.student_id,
                fname: studentData.first_name,
                lname: studentData.last_name,
                minitial: studentData.middle_initial || '',
                email: studentData.email,
                college: studentData.college,
                program: studentData.program,
                year: studentData.year_level,
                section: studentData.section || '',
                purchasing: itemsOrdered,
                notes: '' // No additional notes, as per requirement
            };

            try {
                // Step 1: Create order and get OTP
                const createResponse = await fetch(`${API_BASE}/student/create_order.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const createResult = await createResponse.json();

                if (!createResult.success) {
                    notificationManager.error(createResult.message || 'Failed to create order');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Order';
                    return;
                }

                // Step 2: Auto-verify with OTP (since student is logged in)
                const verifyResponse = await fetch(`${API_BASE}/student/verify_otp.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: studentData.email,
                        otp_code: createResult.data.otp_code,
                        otp_type: 'order',
                        order_data: {
                            purchasing: itemsOrdered,
                            studentId: studentData.student_id,
                            fname: studentData.first_name,
                            lname: studentData.last_name,
                            minitial: studentData.middle_initial || '',
                            college: studentData.college,
                            program: studentData.program,
                            year: studentData.year_level,
                            section: studentData.section || ''
                        }
                    })
                });

                const verifyResult = await verifyResponse.json();

                if (verifyResult.success) {
                    // Show result modal with QR code
                    document.getElementById('resultQueueNumber').textContent = verifyResult.data.queue_number;
                    document.getElementById('resultItem').textContent = itemsOrdered;
                    
                    // Generate QR code
                    const qrData = JSON.stringify({
                        queue_number: verifyResult.data.queue_number,
                        email: studentData.email,
                        timestamp: new Date().toISOString(),
                        type: 'umak_coop_order'
                    });

                    const canvas = document.getElementById('orderQRCode');
                    QRCode.toCanvas(canvas, qrData, {
                        width: 200,
                        margin: 2,
                        color: { dark: '#1e3a8a', light: '#ffffff' }
                    });

                    document.getElementById('orderResultModal').classList.remove('hidden');
                    document.getElementById('quickOrderForm').reset();
                    notificationManager.success('Order placed successfully!');
                } else {
                    notificationManager.error(verifyResult.message || 'Verification failed');
                }
            } catch (error) {
                console.error('Order submission error:', error);
                notificationManager.error('An error occurred. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Order';
            }
        });

        function closeOrderResult() {
            document.getElementById('orderResultModal').classList.add('hidden');
            showOrderHistory(); // Refresh order history
        }

        async function logout() {
            try {
                await fetch(`${API_BASE}/student/student_session.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'logout' })
                });
                window.location.href = 'student_login.html';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = 'student_login.html';
            }
        }

        // Initialize
        checkSession();
        fetchInventoryStatus();
    </script>
</body>
</html>
