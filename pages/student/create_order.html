<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Order - UMak COOP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../../js/notifications.js"></script>
    <script src="../../js/inventory_helper.js"></script>
    <script src="../../js/modal_utils.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full my-8">
        <!-- Cutoff Warning Banner (will be inserted by JavaScript) -->
        <div id="cutoffWarningBanner"></div>
        
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="text-3xl font-bold text-blue-900">Create New Order</h3>
                <p class="text-gray-600 mt-1">Fill out the form to place your order</p>
            </div>
            <button onclick="window.location.href='../index.html'" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full p-2 transition-all" title="Back to Homepage">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <form id="orderForm" class="space-y-6">
            <!-- Student Information -->
            <div class="bg-blue-50 rounded-xl p-6">
                <h4 class="text-lg font-semibold text-blue-900 mb-4">Student Information</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Student ID <span class="text-red-500">*</span></label>
                        <input type="text" id="studentId" placeholder="e.g., K12345678" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">First Name <span class="text-red-500">*</span></label>
                            <input type="text" id="fname" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Last Name <span class="text-red-500">*</span></label>
                            <input type="text" id="lname" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">M.I.</label>
                            <input type="text" id="minitial" maxlength="1" placeholder="Optional" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">UMak Student Email <span class="text-red-500">*</span></label>
                        <input type="email" id="email" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" placeholder="studentID@umak.edu.ph" required />
                        <div id="emailFeedback" class="mt-2 hidden"></div>
                    </div>
                </div>
            </div>
            
            <!-- Academic Information -->
            <div class="bg-orange-50 rounded-xl p-6">
                <h4 class="text-lg font-semibold text-blue-900 mb-4">Academic Information</h4>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">College/School/Institute <span class="text-red-500">*</span></label>
                            <select id="college" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required>
                                <option value="">Select College/School/Institute</option>
                                <optgroup label="Colleges">
                                    <option value="CLAS">CLAS</option>
                                    <option value="CHK">CHK</option>
                                    <option value="CBFS">CBFS</option>
                                    <option value="CCIS">CCIS</option>
                                    <option value="CITE">CITE</option>
                                    <option value="CITE-HSU">CITE-HSU</option>
                                    <option value="CGPP">CGPP</option>
                                    <option value="CCSE">CCSE</option>
                                    <option value="CET">CET</option>
                                    <option value="CTHM">CTHM</option>
                                    <option value="CCAPS">CCAPS</option>
                                </optgroup>
                                <optgroup label="Schools and Institutes">
                                    <option value="SOL">SOL</option>
                                    <option value="IAD">IAD</option>
                                    <option value="IOA">IOA</option>
                                    <option value="IOP">IOP</option>
                                    <option value="ION">ION</option>
                                    <option value="IIHS">IIHS</option>
                                    <option value="ITEST">ITEST</option>
                                    <option value="ISDNB">ISDNB</option>
                                    <option value="IOPsy">IOPsy</option>
                                    <option value="ISW">ISW</option>
                                    <option value="IDEM">IDEM</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Program <span class="text-red-500">*</span></label>
                            <input type="text" id="program" placeholder="e.g., BS Computer Science" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required />
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Year Level <span class="text-red-500">*</span></label>
                            <select id="year" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required>
                                <option value="">Select Year Level</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                                <option value="5">5th Year</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Section</label>
                            <input type="text" id="section" placeholder="e.g., A, B, C (Optional)" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Quantity -->
            <div class="bg-blue-50 rounded-xl p-6">
                <h4 class="text-lg font-semibold text-blue-900 mb-4">Order Quantity</h4>
                <label class="block text-sm font-semibold text-gray-700 mb-3">How many items would you like to order? <span class="text-red-500">*</span></label>
                <div class="grid grid-cols-5 gap-3">
                    <button type="button" onclick="selectQuantity(1)" id="qty1Btn" 
                            class="py-3 px-4 border-2 border-blue-900 bg-blue-900 text-white rounded-lg font-bold hover:bg-blue-800 transition-all">
                        1
                    </button>
                    <button type="button" onclick="selectQuantity(2)" id="qty2Btn" 
                            class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                        2
                    </button>
                    <button type="button" onclick="selectQuantity(3)" id="qty3Btn" 
                            class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                        3
                    </button>
                    <button type="button" onclick="selectQuantity(4)" id="qty4Btn" 
                            class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                        4
                    </button>
                    <button type="button" onclick="selectQuantity(5)" id="qty5Btn" 
                            class="py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all">
                        5
                    </button>
                </div>
            </div>

            <!-- Order Details -->
            <div class="bg-green-50 rounded-xl p-6">
                <h4 class="text-lg font-semibold text-blue-900 mb-4">Order Details</h4>
                <div class="space-y-4">
                    <!-- Item 1 -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Item 1 <span class="text-red-500">*</span></label>
                        <select id="purchasing" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" required>
                            <option value="">Select Item</option>
                            <option value="id lace">ID Lace</option>
                            <option value="uniform">School Uniform</option>
                            <option value="PE uniform">PE Uniform</option>
                            <option value="nstp shirt">NSTP Shirt</option>
                            <option value="patch">School Patch</option>
                            <option value="book">Book/Manual</option>
                            <option value="supplies">School Supplies</option>
                            <option value="merchandise">UMak Merchandise</option>
                        </select>
                    </div>

                    <!-- Item 2 -->
                    <div id="item2Container" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Item 2 <span class="text-red-500">*</span></label>
                        <select id="item2" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="">Select Item</option>
                            <option value="id lace">ID Lace</option>
                            <option value="uniform">School Uniform</option>
                            <option value="PE uniform">PE Uniform</option>
                            <option value="nstp shirt">NSTP Shirt</option>
                            <option value="patch">School Patch</option>
                            <option value="book">Book/Manual</option>
                            <option value="supplies">School Supplies</option>
                            <option value="merchandise">UMak Merchandise</option>
                        </select>
                    </div>

                    <!-- Item 3 -->
                    <div id="item3Container" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Item 3 <span class="text-red-500">*</span></label>
                        <select id="item3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="">Select Item</option>
                            <option value="id lace">ID Lace</option>
                            <option value="uniform">School Uniform</option>
                            <option value="PE uniform">PE Uniform</option>
                            <option value="nstp shirt">NSTP Shirt</option>
                            <option value="patch">School Patch</option>
                            <option value="book">Book/Manual</option>
                            <option value="supplies">School Supplies</option>
                            <option value="merchandise">UMak Merchandise</option>
                        </select>
                    </div>

                    <!-- Item 4 -->
                    <div id="item4Container" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Item 4 <span class="text-red-500">*</span></label>
                        <select id="item4" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="">Select Item</option>
                            <option value="id lace">ID Lace</option>
                            <option value="uniform">School Uniform</option>
                            <option value="PE uniform">PE Uniform</option>
                            <option value="nstp shirt">NSTP Shirt</option>
                            <option value="patch">School Patch</option>
                            <option value="book">Book/Manual</option>
                            <option value="supplies">School Supplies</option>
                            <option value="merchandise">UMak Merchandise</option>
                        </select>
                    </div>

                    <!-- Item 5 -->
                    <div id="item5Container" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Item 5 <span class="text-red-500">*</span></label>
                        <select id="item5" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="">Select Item</option>
                            <option value="id lace">ID Lace</option>
                            <option value="uniform">School Uniform</option>
                            <option value="PE uniform">PE Uniform</option>
                            <option value="nstp shirt">NSTP Shirt</option>
                            <option value="patch">School Patch</option>
                            <option value="book">Book/Manual</option>
                            <option value="supplies">School Supplies</option>
                            <option value="merchandise">UMak Merchandise</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6">
                <button type="submit" id="submitOrderBtn" class="flex-1 bg-blue-900 hover:bg-blue-800 text-white py-4 rounded-xl font-bold text-lg transition-all hover:shadow-lg hover:scale-105 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Submit Order
                </button>
                <button type="reset" class="flex-1 bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 py-4 rounded-xl font-bold text-lg transition-all hover:shadow-lg flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Clear Form
                </button>
            </div>
        </form>
    </div>

    <script>
        const API_BASE = '/Q-Mak/php/api';
        let selectedQuantity = 1;
        let inventoryStock = {};

        // ============================================================================
        // CUTOFF WARNING SYSTEM
        // ============================================================================
        
        async function checkCutoffWarning() {
            try {
                const response = await fetch(`${API_BASE}/student/check_cutoff.php`);
                const data = await response.json();
                
                if (data.success && data.warning) {
                    const banner = document.getElementById('cutoffWarningBanner');
                    const warning = data.warning;
                    
                    if (warning.level === 'error') {
                        // COOP is closed
                        banner.innerHTML = `
                            <div class="bg-red-100 border-l-4 border-red-500 text-red-900 p-4 mb-6 rounded-lg shadow-md">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="font-bold text-lg">COOP Closed</p>
                                        <p class="mt-1">${warning.message}</p>
                                        <p class="mt-2 text-sm">Your order will be scheduled for the next business day (${warning.next_business_day}).</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else if (warning.level === 'warning') {
                        // Closing soon
                        banner.innerHTML = `
                            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 p-4 mb-6 rounded-lg shadow-md animate-pulse">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-6 w-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                    </div>
                                    <div class="ml-3 flex-1">
                                        <p class="font-bold text-lg">Closing Soon!</p>
                                        <p class="mt-1">${warning.message}</p>
                                        <p class="mt-2 text-sm font-semibold">Orders placed after closing will be scheduled for ${warning.next_business_day}.</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error checking cutoff warning:', error);
            }
        }
        
        // Check cutoff warning on page load and refresh every minute
        checkCutoffWarning();
        setInterval(checkCutoffWarning, 60 * 1000);

        // ============================================================================
        // EMAIL EXISTENCE CHECK
        // ============================================================================
        
        let emailCheckTimeout = null;
        let isRegisteredAccount = false; // Flag to track if email has registered account
        const emailInput = document.getElementById('email');
        const emailFeedback = document.getElementById('emailFeedback');
        
        // Add event listener to email input
        emailInput.addEventListener('blur', checkEmailExists);
        emailInput.addEventListener('input', function() {
            // Clear previous timeout
            clearTimeout(emailCheckTimeout);
            
            // Reset feedback while typing
            emailFeedback.classList.add('hidden');
            emailInput.classList.remove('border-red-500', 'border-green-500');
            isRegisteredAccount = false; // Reset flag
            
            // Check after 1 second of no typing
            emailCheckTimeout = setTimeout(() => {
                if (emailInput.value && emailInput.validity.valid) {
                    checkEmailExists();
                }
            }, 1000);
        });
        
        async function checkEmailExists() {
            const email = emailInput.value.trim();
            
            // Validate email format
            if (!email || !emailInput.validity.valid) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/student/check_email.php?email=${encodeURIComponent(email)}`);
                const data = await response.json();
                
                if (data.success && data.exists && data.has_account) {
                    // Email has registered account with password - MUST LOGIN
                    isRegisteredAccount = true; // Set flag to prevent submission
                    
                    // Disable submit button
                    const submitBtn = document.getElementById('submitOrderBtn');
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    submitBtn.classList.remove('hover:bg-blue-800', 'hover:shadow-lg', 'hover:scale-105');
                    
                    emailFeedback.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow-sm animate-fadeIn">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-semibold text-red-800">Registered Account Detected</h3>
                                    <p class="mt-1 text-sm text-red-700">This email has a registered account.</p>
                                    <p class="mt-1 text-sm text-red-700">Please login to place your order.</p>
                                    <div class="mt-3 flex gap-3">
                                        <button onclick="window.location.href='student_login.html'" 
                                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-all shadow-sm">
                                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                                            </svg>
                                            Go to Login
                                        </button>
                                        <button onclick="emailInput.value=''; emailFeedback.classList.add('hidden'); isRegisteredAccount=false; document.getElementById('submitOrderBtn').disabled=false; document.getElementById('submitOrderBtn').classList.remove('opacity-50','cursor-not-allowed'); document.getElementById('submitOrderBtn').classList.add('hover:bg-blue-800','hover:shadow-lg','hover:scale-105'); emailInput.classList.remove('border-red-500'); emailInput.focus();" 
                                                class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 transition-all">
                                            Use Different Email
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    emailFeedback.classList.remove('hidden');
                    emailInput.classList.add('border-red-500');
                    emailInput.classList.remove('border-green-500');
                    
                } else if (data.success && !data.exists) {
                    // Email is available (new user or guest without password - can continue)
                    isRegisteredAccount = false; // Clear flag to allow submission
                    
                    // Enable submit button
                    const submitBtn = document.getElementById('submitOrderBtn');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.classList.add('hover:bg-blue-800', 'hover:shadow-lg', 'hover:scale-105');
                    
                    // Hide feedback for valid emails
                    emailFeedback.classList.add('hidden');
                    emailInput.classList.add('border-green-500');
                    emailInput.classList.remove('border-red-500', 'border-amber-500');
                }
            } catch (error) {
                console.error('Error checking email:', error);
            }
        }

        // ============================================================================
        // INVENTORY MANAGEMENT
        // ============================================================================

        // Fetch inventory stock status
        async function fetchInventoryStatus() {
            try {
                const response = await fetch(`${API_BASE}/inventory_status.php`);
                const result = await response.json();
                
                if (result.success && result.data.items) {
                    // Convert items array to lookup object for backward compatibility
                    inventoryStock = {};
                    result.data.items.forEach(item => {
                        inventoryStock[item.item_name] = item.is_available && item.stock_quantity > 0;
                    });
                    updateItemSelects();
                }
            } catch (error) {
                console.error('Error fetching inventory status:', error);
            }
        }

        // Update all item select dropdowns with stock status
        function updateItemSelects() {
            const selectIds = ['purchasing', 'item2', 'item3', 'item4', 'item5'];
            
            selectIds.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                // Store original text for each option
                Array.from(select.options).forEach(option => {
                    if (!option.value) return; // Skip "Select Item" option
                    
                    // Store original text if not already stored
                    if (!option.dataset.originalText) {
                        option.dataset.originalText = option.textContent.trim();
                    }
                    
                    const itemName = option.dataset.originalText;
                    const isInStock = inventoryStock[itemName];
                    
                    if (isInStock === false) {
                        option.disabled = true;
                        option.textContent = itemName + ' (Out of Stock)';
                        option.style.color = '#999';
                        option.style.fontStyle = 'italic';
                        option.style.backgroundColor = '#f5f5f5';
                    } else {
                        option.disabled = false;
                        option.textContent = itemName;
                        option.style.color = '';
                        option.style.fontStyle = '';
                        option.style.backgroundColor = '';
                    }
                });
            });
        }

        // Quantity selector function
        function selectQuantity(qty) {
            selectedQuantity = qty;
            
            const activeClass = 'py-3 px-4 border-2 border-blue-900 bg-blue-900 text-white rounded-lg font-bold hover:bg-blue-800 transition-all';
            const inactiveClass = 'py-3 px-4 border-2 border-gray-300 bg-white text-gray-700 rounded-lg font-bold hover:border-blue-900 hover:bg-blue-50 transition-all';
            
            // Update all quantity buttons
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`qty${i}Btn`);
                if (btn) {
                    btn.className = i === qty ? activeClass : inactiveClass;
                }
            }
            
            // Show/hide item containers based on quantity
            for (let i = 2; i <= 5; i++) {
                const container = document.getElementById(`item${i}Container`);
                const select = document.getElementById(`item${i}`);
                if (container && select) {
                    if (i <= qty) {
                        container.classList.remove('hidden');
                        select.setAttribute('required', 'required');
                    } else {
                        container.classList.add('hidden');
                        select.removeAttribute('required');
                        select.value = '';
                    }
                }
            }
        }

        // Initialize quantity selector
        document.addEventListener('DOMContentLoaded', function() {
            selectQuantity(1);
            loadInventoryItems();
        });
        
        async function loadInventoryItems() {
            // Populate all item select dropdowns with inventory
            await populateInventorySelect('purchasing', false);
            await populateInventorySelect('item2', false);
            await populateInventorySelect('item3', false);
            await populateInventorySelect('item4', false);
            await populateInventorySelect('item5', false);
        }
        
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            
            // CRITICAL: Verify email one more time before allowing submission
            const email = document.getElementById('email').value.trim();
            
            if (email) {
                // Show checking state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Verifying email...';
                
                try {
                    const response = await fetch(`${API_BASE}/student/check_email.php?email=${encodeURIComponent(email)}`);
                    const data = await response.json();
                    
                    if (data.success && data.exists && data.has_account) {
                        // Email has registered account - BLOCK SUBMISSION
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit Order';
                        
                        // Show error
                        emailFeedback.innerHTML = `
                            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg shadow-sm animate-fadeIn">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <svg class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-semibold text-red-800">‚ùå Cannot Submit Order</h3>
                                        <p class="mt-1 text-sm text-red-700">This email has a registered account.</p>
                                        <p class="mt-1 text-sm text-red-700 font-bold">You must login to place your order.</p>
                                        <div class="mt-3">
                                            <button onclick="window.location.href='student_login.html'" 
                                                    class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-all shadow-sm">
                                                Go to Login Page
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        emailFeedback.classList.remove('hidden');
                        emailFeedback.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        emailInput.classList.add('border-red-500');
                        
                        // Show notification
                        showNotification('This email has a registered account. Please login to place your order.', 'error');
                        
                        return; // STOP - Do not proceed with order
                    }
                } catch (error) {
                    console.error('Error verifying email:', error);
                }
            }
            
            // If we reach here, email is valid or doesn't have account - proceed
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            
            // Collect items based on quantity
            const items = [];
            items.push(document.getElementById('purchasing').value);
            for (let i = 2; i <= selectedQuantity; i++) {
                const itemValue = document.getElementById(`item${i}`).value;
                if (itemValue) {
                    items.push(itemValue);
                }
            }
            const itemsOrdered = items.join(', ');
            
            // Collect form data
            const formData = {
                studentId: document.getElementById('studentId').value,
                fname: document.getElementById('fname').value,
                lname: document.getElementById('lname').value,
                minitial: document.getElementById('minitial').value,
                email: document.getElementById('email').value,
                college: document.getElementById('college').value,
                program: document.getElementById('program').value,
                year: document.getElementById('year').value,
                section: document.getElementById('section').value,
                purchasing: itemsOrdered
            };
            
            try {
                const response = await fetch(`${API_BASE}/student/create_order.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Store form data and OTP info
                    sessionStorage.setItem('orderFormData', JSON.stringify(formData));
                    sessionStorage.setItem('currentOtp', result.data.otp_code);
                    sessionStorage.setItem('otpMode', 'order');
                    sessionStorage.setItem('userEmail', formData.email);
                    
                    // Show push notification
                    if (window.notificationManager) {
                        window.notificationManager.otpSent(formData.email);
                    }
                    
                    await showAlert('OTP has been sent to your email: ' + formData.email, 'success');
                    console.log('Development OTP:', result.data.otp_code);
                    
                    // Redirect to OTP page
                    setTimeout(() => {
                        window.location.href = 'otp_verification.html';
                    }, 1000);
                } else {
                    if (window.notificationManager) {
                        window.notificationManager.error(result.message || 'Failed to create order');
                    }
                    await showAlert(result.message || 'Failed to create order. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Order creation error:', error);
                if (window.notificationManager) {
                    window.notificationManager.error('Connection error. Please try again.');
                }
                await showAlert('An error occurred. Please check your connection and try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Order';
            }
        });
    </script>
</body>
</html>