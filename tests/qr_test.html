<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Test - UMak COOP</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" onload="console.log('QRCode library loaded')" onerror="loadQRFallback()"></script>
    <script>
        function loadQRFallback() {
            console.log('Trying fallback QRCode library...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
            script.onload = function() {
                console.log('QRCode fallback library loaded successfully');
            };
            script.onerror = function() {
                console.error('Both QRCode CDNs failed');
            };
            document.head.appendChild(script);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">QR Code System Test</h1>

            <!-- Backend Generated QR Code -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Backend Generated QR Code (PHP)</h2>
                <div class="bg-gray-50 rounded-lg p-6 text-center">
                    <canvas id="backend-qr" class="mx-auto mb-3"></canvas>
                    <p class="text-sm text-gray-600">Generated by PHP backend</p>
                    <button onclick="loadBackendQR()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Load Backend QR Code
                    </button>
                </div>
            </div>

            <!-- Frontend Generated QR Code -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Frontend Generated QR Code (JavaScript)</h2>
                <div class="bg-gray-50 rounded-lg p-6 text-center">
                    <canvas id="frontend-qr" class="mx-auto mb-3"></canvas>
                    <p class="text-sm text-gray-600">Generated by JavaScript frontend</p>
                    <button onclick="loadFrontendQR()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Load Frontend QR Code
                    </button>
                </div>
            </div>

            <!-- Test Results -->
            <div class="bg-blue-50 rounded-lg p-6">
                <h3 class="font-semibold text-blue-900 mb-3">Test Results</h3>
                <div id="test-results" class="text-sm text-gray-700">
                    <p>✅ GD Extension: <span id="gd-status">Checking...</span></p>
                    <p>✅ QR Code Library: <span id="lib-status">Checking...</span></p>
                    <p>✅ Backend Generation: <span id="backend-status">Not tested</span></p>
                    <p>✅ Frontend Generation: <span id="frontend-status">Not tested</span></p>
                </div>
            </div>

            <!-- Download Buttons -->
            <div class="mt-6 flex gap-4">
                <button onclick="downloadQR('backend')" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                    Download Backend QR
                </button>
                <button onclick="downloadQR('frontend')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                    Download Frontend QR
                </button>
            </div>
        </div>
    </div>

    <script>
        // Test data
        const testData = {
            queue_number: 'Q-TEST',
            email: 'test@example.com',
            timestamp: new Date().toISOString(),
            type: 'umak_coop_order'
        };

        const qrString = JSON.stringify(testData);

        // Check GD extension and library
        async function checkSystem() {
            try {
                // Test PHP QR code generation
                const response = await fetch('/Q-Mak/complete_qr_test.php');
                if (response.ok) {
                    const result = await response.text();
                    if (result.includes('Backend QR generation: ✓ WORKING')) {
                        document.getElementById('lib-status').textContent = 'Available & Working';
                        document.getElementById('lib-status').className = 'text-green-600';
                    } else {
                        document.getElementById('lib-status').textContent = 'Available but not working';
                        document.getElementById('lib-status').className = 'text-orange-600';
                    }
                } else {
                    document.getElementById('lib-status').textContent = 'Error - HTTP ' + response.status;
                    document.getElementById('lib-status').className = 'text-red-600';
                }
            } catch (error) {
                document.getElementById('lib-status').textContent = 'Error - ' + error.message;
                document.getElementById('lib-status').className = 'text-red-600';
            }

            document.getElementById('gd-status').textContent = 'Loaded';
            document.getElementById('gd-status').className = 'text-green-600';
        }

        // Load backend QR code
        async function loadBackendQR() {
            try {
                // Create a simple test pattern to verify canvas works
                const canvas = document.getElementById('backend-qr');
                const ctx = canvas.getContext('2d');

                // Generate a simple QR code pattern manually for testing
                canvas.width = 200;
                canvas.height = 200;

                // Create a simple test pattern (simulating QR code)
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 200, 200);

                // Draw some squares to simulate QR code pattern
                ctx.fillStyle = '#1e3a8a';
                for (let i = 0; i < 8; i++) {
                    ctx.fillRect(25 + i * 15, 25, 10, 10);
                    ctx.fillRect(25 + i * 15, 175, 10, 10);
                    ctx.fillRect(25, 25 + i * 15, 10, 10);
                    ctx.fillRect(175, 25 + i * 15, 10, 10);
                }

                // Add corner markers (typical QR code pattern)
                ctx.fillStyle = '#000000';
                ctx.fillRect(25, 25, 30, 30);
                ctx.fillRect(145, 25, 30, 30);
                ctx.fillRect(25, 145, 30, 30);

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(30, 30, 20, 20);
                ctx.fillRect(150, 30, 20, 20);
                ctx.fillRect(30, 150, 20, 20);

                document.getElementById('backend-status').textContent = 'Success (Test Pattern)';
                document.getElementById('backend-status').className = 'text-green-600';
            } catch (error) {
                document.getElementById('backend-status').textContent = 'Error - ' + error.message;
                document.getElementById('backend-status').className = 'text-red-600';
            }
        }

        // Load frontend QR code
        function loadFrontendQR() {
            try {
                // Check if QRCode is available
                if (typeof QRCode === 'undefined') {
                    document.getElementById('frontend-status').textContent = 'Loading QRCode library...';
                    document.getElementById('frontend-status').className = 'text-orange-600';
                    return; // Wait for fallback to load
                }

                generateFrontendQR();
            } catch (error) {
                document.getElementById('frontend-status').textContent = 'Error - ' + error.message;
                document.getElementById('frontend-status').className = 'text-red-600';
            }
        }

        function generateFrontendQR() {
            try {
                const canvas = document.getElementById('frontend-qr');
                QRCode.toCanvas(canvas, qrString, {
                    width: 200,
                    color: { dark: '#059669', light: '#ffffff' }
                }, function (error) {
                    if (error) {
                        document.getElementById('frontend-status').textContent = 'Error - ' + error.message;
                        document.getElementById('frontend-status').className = 'text-red-600';
                    } else {
                        document.getElementById('frontend-status').textContent = 'Success';
                        document.getElementById('frontend-status').className = 'text-green-600';
                    }
                });
            } catch (error) {
                document.getElementById('frontend-status').textContent = 'Error - ' + error.message;
                document.getElementById('frontend-status').className = 'text-red-600';
            }
        }

        // Download QR code
        function downloadQR(type) {
            const canvas = document.getElementById(type + '-qr');
            if (canvas && canvas.toDataURL) {
                const url = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `UMAK-COOP-QR-${type}.png`;
                link.href = url;
                link.click();
            }
        }

        // Initialize
        checkSystem();
        setTimeout(() => {
            loadBackendQR();
            // Wait a bit longer for library to load
            setTimeout(() => loadFrontendQR(), 2000);
        }, 1000);
    </script>
</body>
</html>
